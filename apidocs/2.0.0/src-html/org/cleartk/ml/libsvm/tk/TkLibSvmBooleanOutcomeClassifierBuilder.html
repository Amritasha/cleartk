<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html lang="en">
<head>
<title>Source code</title>
<link rel="stylesheet" type="text/css" href="../../../../../../stylesheet.css" title="Style">
</head>
<body>
<div class="sourceContainer">
<pre><span class="sourceLineNo">001</span>/*<a name="line.1"></a>
<span class="sourceLineNo">002</span> * Copyright (c) 2007-2013, Regents of the University of Colorado <a name="line.2"></a>
<span class="sourceLineNo">003</span> * All rights reserved.<a name="line.3"></a>
<span class="sourceLineNo">004</span> * <a name="line.4"></a>
<span class="sourceLineNo">005</span> * Redistribution and use in source and binary forms, with or without<a name="line.5"></a>
<span class="sourceLineNo">006</span> * modification, are permitted provided that the following conditions are met:<a name="line.6"></a>
<span class="sourceLineNo">007</span> * <a name="line.7"></a>
<span class="sourceLineNo">008</span> * Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer. <a name="line.8"></a>
<span class="sourceLineNo">009</span> * Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution. <a name="line.9"></a>
<span class="sourceLineNo">010</span> * Neither the name of the University of Colorado at Boulder nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission. <a name="line.10"></a>
<span class="sourceLineNo">011</span> * <a name="line.11"></a>
<span class="sourceLineNo">012</span> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"<a name="line.12"></a>
<span class="sourceLineNo">013</span> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE<a name="line.13"></a>
<span class="sourceLineNo">014</span> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE<a name="line.14"></a>
<span class="sourceLineNo">015</span> * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE<a name="line.15"></a>
<span class="sourceLineNo">016</span> * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR<a name="line.16"></a>
<span class="sourceLineNo">017</span> * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF<a name="line.17"></a>
<span class="sourceLineNo">018</span> * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS<a name="line.18"></a>
<span class="sourceLineNo">019</span> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN<a name="line.19"></a>
<span class="sourceLineNo">020</span> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)<a name="line.20"></a>
<span class="sourceLineNo">021</span> * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE<a name="line.21"></a>
<span class="sourceLineNo">022</span> * POSSIBILITY OF SUCH DAMAGE. <a name="line.22"></a>
<span class="sourceLineNo">023</span> */<a name="line.23"></a>
<span class="sourceLineNo">024</span>package org.cleartk.ml.libsvm.tk;<a name="line.24"></a>
<span class="sourceLineNo">025</span><a name="line.25"></a>
<span class="sourceLineNo">026</span>import java.io.BufferedReader;<a name="line.26"></a>
<span class="sourceLineNo">027</span>import java.io.File;<a name="line.27"></a>
<span class="sourceLineNo">028</span>import java.io.FileReader;<a name="line.28"></a>
<span class="sourceLineNo">029</span>import java.io.IOException;<a name="line.29"></a>
<span class="sourceLineNo">030</span>import java.io.PrintWriter;<a name="line.30"></a>
<span class="sourceLineNo">031</span>import java.util.ArrayList;<a name="line.31"></a>
<span class="sourceLineNo">032</span>import java.util.LinkedHashMap;<a name="line.32"></a>
<span class="sourceLineNo">033</span>import java.util.List;<a name="line.33"></a>
<span class="sourceLineNo">034</span>import java.util.jar.JarInputStream;<a name="line.34"></a>
<span class="sourceLineNo">035</span>import java.util.jar.JarOutputStream;<a name="line.35"></a>
<span class="sourceLineNo">036</span><a name="line.36"></a>
<span class="sourceLineNo">037</span>import org.apache.commons.cli.CommandLine;<a name="line.37"></a>
<span class="sourceLineNo">038</span>import org.apache.commons.cli.CommandLineParser;<a name="line.38"></a>
<span class="sourceLineNo">039</span>import org.apache.commons.cli.Options;<a name="line.39"></a>
<span class="sourceLineNo">040</span>import org.apache.commons.cli.PosixParser;<a name="line.40"></a>
<span class="sourceLineNo">041</span>import org.chboston.cnlp.kernel.CustomKernel;<a name="line.41"></a>
<span class="sourceLineNo">042</span>import org.chboston.cnlp.kernel.KernelManager;<a name="line.42"></a>
<span class="sourceLineNo">043</span>import org.chboston.cnlp.libsvm.svm_model;<a name="line.43"></a>
<span class="sourceLineNo">044</span>import org.chboston.cnlp.libsvm.svm_node;<a name="line.44"></a>
<span class="sourceLineNo">045</span>import org.chboston.cnlp.libsvm.svm_parameter;<a name="line.45"></a>
<span class="sourceLineNo">046</span>import org.chboston.cnlp.libsvm.ex.Instance;<a name="line.46"></a>
<span class="sourceLineNo">047</span>import org.chboston.cnlp.libsvm.ex.SVMTrainer;<a name="line.47"></a>
<span class="sourceLineNo">048</span>import org.cleartk.ml.jar.JarStreams;<a name="line.48"></a>
<span class="sourceLineNo">049</span>import org.cleartk.ml.svmlight.model.Kernel;<a name="line.49"></a>
<span class="sourceLineNo">050</span>import org.cleartk.ml.svmlight.model.LinearKernel;<a name="line.50"></a>
<span class="sourceLineNo">051</span>import org.cleartk.ml.svmlight.model.PolynomialKernel;<a name="line.51"></a>
<span class="sourceLineNo">052</span>import org.cleartk.ml.svmlight.model.RbfKernel;<a name="line.52"></a>
<span class="sourceLineNo">053</span>import org.cleartk.ml.tksvmlight.TreeFeatureVector;<a name="line.53"></a>
<span class="sourceLineNo">054</span>import org.cleartk.ml.tksvmlight.TreeKernelSvmBooleanOutcomeClassifier;<a name="line.54"></a>
<span class="sourceLineNo">055</span>import org.cleartk.ml.tksvmlight.TreeKernelSvmBooleanOutcomeClassifierBuilder;<a name="line.55"></a>
<span class="sourceLineNo">056</span>import org.cleartk.ml.tksvmlight.model.TreeKernel;<a name="line.56"></a>
<span class="sourceLineNo">057</span>import org.cleartk.ml.tksvmlight.model.TreeKernelSvmModel;<a name="line.57"></a>
<span class="sourceLineNo">058</span>import org.cleartk.ml.tksvmlight.model.CompositeKernel.ComboOperator;<a name="line.58"></a>
<span class="sourceLineNo">059</span>import org.cleartk.ml.tksvmlight.model.CompositeKernel.Normalize;<a name="line.59"></a>
<span class="sourceLineNo">060</span>import org.cleartk.ml.tksvmlight.model.TreeKernel.ForestSumMethod;<a name="line.60"></a>
<span class="sourceLineNo">061</span>import org.cleartk.ml.tksvmlight.model.TreeKernel.KernelType;<a name="line.61"></a>
<span class="sourceLineNo">062</span>import org.cleartk.ml.util.featurevector.FeatureVector;<a name="line.62"></a>
<span class="sourceLineNo">063</span>import org.cleartk.ml.util.featurevector.InvalidFeatureVectorValueException;<a name="line.63"></a>
<span class="sourceLineNo">064</span>import org.cleartk.ml.util.featurevector.SparseFeatureVector;<a name="line.64"></a>
<span class="sourceLineNo">065</span><a name="line.65"></a>
<span class="sourceLineNo">066</span>/**<a name="line.66"></a>
<span class="sourceLineNo">067</span> * A class that provided interfaces to train, package and unpackage a<a name="line.67"></a>
<span class="sourceLineNo">068</span> * {@link TreeKernelSvmBooleanOutcomeClassifier} into a jar file.<a name="line.68"></a>
<span class="sourceLineNo">069</span> * <a name="line.69"></a>
<span class="sourceLineNo">070</span> * &lt;br&gt;<a name="line.70"></a>
<span class="sourceLineNo">071</span> * Copyright (c) 2013, Regents of the University of Colorado &lt;br&gt;<a name="line.71"></a>
<span class="sourceLineNo">072</span> * All rights reserved.<a name="line.72"></a>
<span class="sourceLineNo">073</span> * <a name="line.73"></a>
<span class="sourceLineNo">074</span> * @author Tim Miller<a name="line.74"></a>
<span class="sourceLineNo">075</span> */<a name="line.75"></a>
<span class="sourceLineNo">076</span><a name="line.76"></a>
<span class="sourceLineNo">077</span><a name="line.77"></a>
<span class="sourceLineNo">078</span>public class TkLibSvmBooleanOutcomeClassifierBuilder extends<a name="line.78"></a>
<span class="sourceLineNo">079</span>  TreeKernelSvmBooleanOutcomeClassifierBuilder&lt;TreeKernelSvmBooleanOutcomeClassifier&gt; {<a name="line.79"></a>
<span class="sourceLineNo">080</span><a name="line.80"></a>
<span class="sourceLineNo">081</span>  private TreeKernelSvmModel model;<a name="line.81"></a>
<span class="sourceLineNo">082</span>  <a name="line.82"></a>
<span class="sourceLineNo">083</span>  Options options = new Options();<a name="line.83"></a>
<span class="sourceLineNo">084</span>  <a name="line.84"></a>
<span class="sourceLineNo">085</span>  public TkLibSvmBooleanOutcomeClassifierBuilder(){<a name="line.85"></a>
<span class="sourceLineNo">086</span>    options.addOption("c", true, "Cost parameter");<a name="line.86"></a>
<span class="sourceLineNo">087</span>    options.addOption("t", true, "Kernel type");<a name="line.87"></a>
<span class="sourceLineNo">088</span>    options.addOption("W", true, "Tree sequence comparision method (S sequential (default) or A for all vs. all)");<a name="line.88"></a>
<span class="sourceLineNo">089</span>    options.addOption("V", true, "Vector sequence comparison method");<a name="line.89"></a>
<span class="sourceLineNo">090</span>    options.addOption("S", true, "Secondary kernel for composite kernels");<a name="line.90"></a>
<span class="sourceLineNo">091</span>    options.addOption("C", true, "Combination operator for composite/tree kernels");<a name="line.91"></a>
<span class="sourceLineNo">092</span>    options.addOption("L", true, "Decay rate for tree kernels (lambda in Collins &amp; Duffy");<a name="line.92"></a>
<span class="sourceLineNo">093</span>    options.addOption("T", true, "Multiplicative constant for tree kernel in composite kernel");<a name="line.93"></a>
<span class="sourceLineNo">094</span>    options.addOption("N", true, "Normalization parameter for composite kernels");<a name="line.94"></a>
<span class="sourceLineNo">095</span>    options.addOption("D", true, "Tree kernel similarity function (0 = Subtree, 1 = Subset Tree (default), 2 = Partial tree kernel");<a name="line.95"></a>
<span class="sourceLineNo">096</span>    options.addOption("d", true, "Degree of polynomial kernel");<a name="line.96"></a>
<span class="sourceLineNo">097</span>    options.addOption("r", true, "Parameter c in poly kernel");<a name="line.97"></a>
<span class="sourceLineNo">098</span>    options.addOption("s", true, "Parameter s in poly kernel");<a name="line.98"></a>
<span class="sourceLineNo">099</span>    options.addOption("g", true, "Gamma in rbf kernel");<a name="line.99"></a>
<span class="sourceLineNo">100</span>  }<a name="line.100"></a>
<span class="sourceLineNo">101</span>  <a name="line.101"></a>
<span class="sourceLineNo">102</span>  @Override<a name="line.102"></a>
<span class="sourceLineNo">103</span>  public File getTrainingDataFile(File dir) {<a name="line.103"></a>
<span class="sourceLineNo">104</span>    return new File(dir, "training-data.libsvm");<a name="line.104"></a>
<span class="sourceLineNo">105</span>  }<a name="line.105"></a>
<span class="sourceLineNo">106</span><a name="line.106"></a>
<span class="sourceLineNo">107</span>  private File getModelFile(File dir){<a name="line.107"></a>
<span class="sourceLineNo">108</span>    return new File(dir, "training-data.libsvm.model");  <a name="line.108"></a>
<span class="sourceLineNo">109</span>  }<a name="line.109"></a>
<span class="sourceLineNo">110</span>  <a name="line.110"></a>
<span class="sourceLineNo">111</span>  @Override<a name="line.111"></a>
<span class="sourceLineNo">112</span>  public void trainClassifier(File filePath, String... args) throws Exception {<a name="line.112"></a>
<span class="sourceLineNo">113</span>    File inputFile = filePath.isDirectory() ? getTrainingDataFile(filePath) : filePath;<a name="line.113"></a>
<span class="sourceLineNo">114</span>    <a name="line.114"></a>
<span class="sourceLineNo">115</span>    // read and parse options<a name="line.115"></a>
<span class="sourceLineNo">116</span>    CommandLineParser parser = new PosixParser();<a name="line.116"></a>
<span class="sourceLineNo">117</span>    CommandLine cmd = parser.parse(options, args);<a name="line.117"></a>
<span class="sourceLineNo">118</span>     <a name="line.118"></a>
<span class="sourceLineNo">119</span>    // set parameters<a name="line.119"></a>
<span class="sourceLineNo">120</span>    Kernel fk = null;<a name="line.120"></a>
<span class="sourceLineNo">121</span>    <a name="line.121"></a>
<span class="sourceLineNo">122</span>    CustomKernel&lt;TreeFeatureVector&gt; kernel = null;<a name="line.122"></a>
<span class="sourceLineNo">123</span>    <a name="line.123"></a>
<span class="sourceLineNo">124</span>    double cost = Double.parseDouble(cmd.getOptionValue("c", "1"));<a name="line.124"></a>
<span class="sourceLineNo">125</span>    int kernelType = Integer.parseInt(cmd.getOptionValue("t"));<a name="line.125"></a>
<span class="sourceLineNo">126</span>    int secondaryKernel = Integer.parseInt(cmd.getOptionValue("S", "1"));<a name="line.126"></a>
<span class="sourceLineNo">127</span>    int d = Integer.parseInt(cmd.getOptionValue("d", "3"));<a name="line.127"></a>
<span class="sourceLineNo">128</span>    int c = Integer.parseInt(cmd.getOptionValue("r", "1"));<a name="line.128"></a>
<span class="sourceLineNo">129</span>    int s = Integer.parseInt(cmd.getOptionValue("s", "1"));<a name="line.129"></a>
<span class="sourceLineNo">130</span>    double gamma = Double.parseDouble(cmd.getOptionValue("g", "1.0"));<a name="line.130"></a>
<span class="sourceLineNo">131</span>    double lambda = Double.parseDouble(cmd.getOptionValue("L", "0.4"));<a name="line.131"></a>
<span class="sourceLineNo">132</span>    String comboOperator = cmd.getOptionValue("C", "T");<a name="line.132"></a>
<span class="sourceLineNo">133</span>    String sumMethod = cmd.getOptionValue("W", "S");<a name="line.133"></a>
<span class="sourceLineNo">134</span>    int normalize = Integer.parseInt(cmd.getOptionValue("N", "3"));<a name="line.134"></a>
<span class="sourceLineNo">135</span>    double tkWeight = Double.parseDouble(cmd.getOptionValue("T", "1.0"));<a name="line.135"></a>
<span class="sourceLineNo">136</span>    KernelType kType = null;<a name="line.136"></a>
<span class="sourceLineNo">137</span>    int treeComparisonMethod = Integer.parseInt(cmd.getOptionValue("D", "1"));<a name="line.137"></a>
<span class="sourceLineNo">138</span>    <a name="line.138"></a>
<span class="sourceLineNo">139</span>    if(kernelType == 5){<a name="line.139"></a>
<span class="sourceLineNo">140</span>      <a name="line.140"></a>
<span class="sourceLineNo">141</span>      switch(secondaryKernel){<a name="line.141"></a>
<span class="sourceLineNo">142</span>      case 0: fk = new LinearKernel(); break;<a name="line.142"></a>
<span class="sourceLineNo">143</span>      case 1: <a name="line.143"></a>
<span class="sourceLineNo">144</span>        fk = new PolynomialKernel(s, c, d); break;<a name="line.144"></a>
<span class="sourceLineNo">145</span>      case 2:<a name="line.145"></a>
<span class="sourceLineNo">146</span>        fk = new RbfKernel(gamma); break;<a name="line.146"></a>
<span class="sourceLineNo">147</span>      }<a name="line.147"></a>
<span class="sourceLineNo">148</span>      switch(treeComparisonMethod){<a name="line.148"></a>
<span class="sourceLineNo">149</span>      case 0: kType = KernelType.SUBTREE; break;<a name="line.149"></a>
<span class="sourceLineNo">150</span>      case 1: kType = KernelType.SUBSET; break;<a name="line.150"></a>
<span class="sourceLineNo">151</span>      case 2: kType = KernelType.SUBSET_BOW; break;<a name="line.151"></a>
<span class="sourceLineNo">152</span>      case 3: kType = KernelType.PARTIAL; break;<a name="line.152"></a>
<span class="sourceLineNo">153</span>      }<a name="line.153"></a>
<span class="sourceLineNo">154</span>      TreeKernel tk = new TreeKernel(lambda, sumMethod.equals("S") ? ForestSumMethod.SEQUENTIAL : ForestSumMethod.ALL_PAIRS, kType, normalize % 2 &gt; 0);<a name="line.154"></a>
<span class="sourceLineNo">155</span>      ComboOperator op = null;<a name="line.155"></a>
<span class="sourceLineNo">156</span>      if(comboOperator.equals("+")) op = ComboOperator.SUM;<a name="line.156"></a>
<span class="sourceLineNo">157</span>      else if(comboOperator.equals("*")) op = ComboOperator.PRODUCT;<a name="line.157"></a>
<span class="sourceLineNo">158</span>      else if(comboOperator.equals("T")) op = ComboOperator.TREE_ONLY;<a name="line.158"></a>
<span class="sourceLineNo">159</span>      else op = ComboOperator.VECTOR_ONLY;<a name="line.159"></a>
<span class="sourceLineNo">160</span>      Normalize norm = null;<a name="line.160"></a>
<span class="sourceLineNo">161</span>      switch(normalize){<a name="line.161"></a>
<span class="sourceLineNo">162</span>      case 0: norm = Normalize.NEITHER; break;<a name="line.162"></a>
<span class="sourceLineNo">163</span>      case 1: norm = Normalize.TREE; break;<a name="line.163"></a>
<span class="sourceLineNo">164</span>      case 2: norm = Normalize.VECTOR; break;<a name="line.164"></a>
<span class="sourceLineNo">165</span>      case 3: norm = Normalize.BOTH; break;<a name="line.165"></a>
<span class="sourceLineNo">166</span>      }<a name="line.166"></a>
<span class="sourceLineNo">167</span>      kernel = new CustomCompositeKernel(fk, tk, op, tkWeight, norm);<a name="line.167"></a>
<span class="sourceLineNo">168</span>      KernelManager.setCustomKernel(kernel);<a name="line.168"></a>
<span class="sourceLineNo">169</span>    }else{<a name="line.169"></a>
<span class="sourceLineNo">170</span>      throw new Exception("If you are not doing a tree/composite kernel (t = 5) then you should just use the regular libsvm module");<a name="line.170"></a>
<span class="sourceLineNo">171</span>    }<a name="line.171"></a>
<span class="sourceLineNo">172</span>        <a name="line.172"></a>
<span class="sourceLineNo">173</span>    // read in file into Instance array<a name="line.173"></a>
<span class="sourceLineNo">174</span>    List&lt;Instance&lt;TreeFeatureVector&gt;&gt; instances = readInstances(inputFile);<a name="line.174"></a>
<span class="sourceLineNo">175</span>    <a name="line.175"></a>
<span class="sourceLineNo">176</span>    int highestIndex = 0;<a name="line.176"></a>
<span class="sourceLineNo">177</span>    for(Instance&lt;TreeFeatureVector&gt; inst : instances){<a name="line.177"></a>
<span class="sourceLineNo">178</span>      FeatureVector vec = inst.getData().getFeatures();<a name="line.178"></a>
<span class="sourceLineNo">179</span>      for(FeatureVector.Entry entry : vec){<a name="line.179"></a>
<span class="sourceLineNo">180</span>        if(entry.index &gt; highestIndex){<a name="line.180"></a>
<span class="sourceLineNo">181</span>          highestIndex = entry.index;<a name="line.181"></a>
<span class="sourceLineNo">182</span>        }<a name="line.182"></a>
<span class="sourceLineNo">183</span>      }<a name="line.183"></a>
<span class="sourceLineNo">184</span>    }<a name="line.184"></a>
<span class="sourceLineNo">185</span>    <a name="line.185"></a>
<span class="sourceLineNo">186</span>    // give the SVMTrainer the instance array and the kernel parameters<a name="line.186"></a>
<span class="sourceLineNo">187</span>    svm_parameter param = new svm_parameter();<a name="line.187"></a>
<span class="sourceLineNo">188</span>    param.svm_type = svm_parameter.C_SVC;<a name="line.188"></a>
<span class="sourceLineNo">189</span>    param.C = cost;<a name="line.189"></a>
<span class="sourceLineNo">190</span>    param.shrinking = 0;<a name="line.190"></a>
<span class="sourceLineNo">191</span>    String modelFilename = inputFile.getPath() + ".model";<a name="line.191"></a>
<span class="sourceLineNo">192</span>    svm_model&lt;TreeFeatureVector&gt; model = SVMTrainer.train(instances, param);<a name="line.192"></a>
<span class="sourceLineNo">193</span>    <a name="line.193"></a>
<span class="sourceLineNo">194</span>    PrintWriter out = new PrintWriter(modelFilename);<a name="line.194"></a>
<span class="sourceLineNo">195</span>    out.println("cleartk-ml-libsvm-tk wrapper and bridge for svmlight/libsvm tree kernel libraries");<a name="line.195"></a>
<span class="sourceLineNo">196</span>    out.println("5 # kernel type");<a name="line.196"></a>
<span class="sourceLineNo">197</span>    out.print(d);    out.println(" # kernel parameter -d");<a name="line.197"></a>
<span class="sourceLineNo">198</span>    out.print(gamma);     out.println(" # kernel parameter -g");<a name="line.198"></a>
<span class="sourceLineNo">199</span>    out.print(s);    out.println(" # kernel parameter -s");<a name="line.199"></a>
<span class="sourceLineNo">200</span>    out.print(c);    out.println(" # kernel parameter -r");<a name="line.200"></a>
<span class="sourceLineNo">201</span>    out.println("empty# kernel paramater -u");<a name="line.201"></a>
<span class="sourceLineNo">202</span>    out.print(lambda);        out.println(" # kernel parameter -L");<a name="line.202"></a>
<span class="sourceLineNo">203</span>    out.print(tkWeight);      out.println(" # kernel parameter -T");<a name="line.203"></a>
<span class="sourceLineNo">204</span>    out.print(comboOperator); out.println(" # kernel parameter -C");<a name="line.204"></a>
<span class="sourceLineNo">205</span>    out.println("1 # Kernel paramter -F -- don't know what this does");<a name="line.205"></a>
<span class="sourceLineNo">206</span>    out.print(secondaryKernel); out.println(" # kernel parameter -S (secondary kernel)");<a name="line.206"></a>
<span class="sourceLineNo">207</span>    out.print(treeComparisonMethod); out.println(" # kernel parameter -D");<a name="line.207"></a>
<span class="sourceLineNo">208</span>    out.print(normalize); out.println(" # kernel parameter -N");<a name="line.208"></a>
<span class="sourceLineNo">209</span>    out.print("S"); out.println(" # kernel parameter -V");<a name="line.209"></a>
<span class="sourceLineNo">210</span>    out.print("S"); out.println(" # kernel parameter -W");<a name="line.210"></a>
<span class="sourceLineNo">211</span>    out.print(highestIndex); out.println(" # highest feature index");<a name="line.211"></a>
<span class="sourceLineNo">212</span>    out.print(instances.size()); out.println(" # number of training documents");<a name="line.212"></a>
<span class="sourceLineNo">213</span>    out.print(model.l+1); out.println(" # number of support vectors + 1");<a name="line.213"></a>
<span class="sourceLineNo">214</span>    out.print(model.rho[0]); out.println(" # threshold b, each following line is a SV (starting with alpha*y)");<a name="line.214"></a>
<span class="sourceLineNo">215</span>    <a name="line.215"></a>
<span class="sourceLineNo">216</span>    // print out SVs:<a name="line.216"></a>
<span class="sourceLineNo">217</span>    for(int i = 0; i &lt; model.SV.length; i++){<a name="line.217"></a>
<span class="sourceLineNo">218</span>      svm_node&lt;TreeFeatureVector&gt; node = model.SV[i];<a name="line.218"></a>
<span class="sourceLineNo">219</span>      out.print(model.sv_coef[0][i]);<a name="line.219"></a>
<span class="sourceLineNo">220</span>      TreeFeatureVector treeVec = node.data;<a name="line.220"></a>
<span class="sourceLineNo">221</span>      LinkedHashMap&lt;String,String&gt; trees = treeVec.getTrees();<a name="line.221"></a>
<span class="sourceLineNo">222</span>      if(trees.size() &gt; 0){<a name="line.222"></a>
<span class="sourceLineNo">223</span>        for(String tree : trees.values()){<a name="line.223"></a>
<span class="sourceLineNo">224</span>          out.print(" |BT| ");<a name="line.224"></a>
<span class="sourceLineNo">225</span>          out.print(tree);<a name="line.225"></a>
<span class="sourceLineNo">226</span>        }<a name="line.226"></a>
<span class="sourceLineNo">227</span>        out.print(" |ET| ");<a name="line.227"></a>
<span class="sourceLineNo">228</span>      }<a name="line.228"></a>
<span class="sourceLineNo">229</span>      <a name="line.229"></a>
<span class="sourceLineNo">230</span>      FeatureVector featVec = treeVec.getFeatures();<a name="line.230"></a>
<span class="sourceLineNo">231</span>      for(FeatureVector.Entry feat : featVec){<a name="line.231"></a>
<span class="sourceLineNo">232</span>        out.print(feat.index);<a name="line.232"></a>
<span class="sourceLineNo">233</span>        out.print(":");<a name="line.233"></a>
<span class="sourceLineNo">234</span>        out.print(feat.value);<a name="line.234"></a>
<span class="sourceLineNo">235</span>        out.print(" ");<a name="line.235"></a>
<span class="sourceLineNo">236</span>      }<a name="line.236"></a>
<span class="sourceLineNo">237</span>      out.print("|EV|");<a name="line.237"></a>
<span class="sourceLineNo">238</span>      out.println();<a name="line.238"></a>
<span class="sourceLineNo">239</span>    }<a name="line.239"></a>
<span class="sourceLineNo">240</span>    out.close();    <a name="line.240"></a>
<span class="sourceLineNo">241</span>  }<a name="line.241"></a>
<span class="sourceLineNo">242</span><a name="line.242"></a>
<span class="sourceLineNo">243</span>  private List&lt;Instance&lt;TreeFeatureVector&gt;&gt; readInstances(File filePath) throws IOException {<a name="line.243"></a>
<span class="sourceLineNo">244</span>    List&lt;Instance&lt;TreeFeatureVector&gt;&gt; instances = new ArrayList&lt;Instance&lt;TreeFeatureVector&gt;&gt;();<a name="line.244"></a>
<span class="sourceLineNo">245</span>    BufferedReader reader = new BufferedReader(new FileReader(filePath));<a name="line.245"></a>
<span class="sourceLineNo">246</span>    String line = null;<a name="line.246"></a>
<span class="sourceLineNo">247</span>    while((line = reader.readLine()) != null){<a name="line.247"></a>
<span class="sourceLineNo">248</span>      instances.add(readInstance(line));<a name="line.248"></a>
<span class="sourceLineNo">249</span>    }<a name="line.249"></a>
<span class="sourceLineNo">250</span>    reader.close();<a name="line.250"></a>
<span class="sourceLineNo">251</span>    return instances;<a name="line.251"></a>
<span class="sourceLineNo">252</span>  }<a name="line.252"></a>
<span class="sourceLineNo">253</span><a name="line.253"></a>
<span class="sourceLineNo">254</span>  private Instance&lt;TreeFeatureVector&gt; readInstance(String line) throws IOException {<a name="line.254"></a>
<span class="sourceLineNo">255</span>    int firstWhitespace = line.indexOf(' ');<a name="line.255"></a>
<span class="sourceLineNo">256</span>    TreeFeatureVector treeVector = new TreeFeatureVector();<a name="line.256"></a>
<span class="sourceLineNo">257</span>    String label = line.substring(0, firstWhitespace);<a name="line.257"></a>
<span class="sourceLineNo">258</span>    String rest = line.substring(firstWhitespace).trim();<a name="line.258"></a>
<span class="sourceLineNo">259</span>    String treeSect = null;<a name="line.259"></a>
<span class="sourceLineNo">260</span>    String vectSect = null;<a name="line.260"></a>
<span class="sourceLineNo">261</span>    <a name="line.261"></a>
<span class="sourceLineNo">262</span>    // figure out what combination of trees &amp; vectors are in each instance:<a name="line.262"></a>
<span class="sourceLineNo">263</span>    int etInd = rest.indexOf("|ET|");<a name="line.263"></a>
<span class="sourceLineNo">264</span>    if(etInd &gt;= 0){<a name="line.264"></a>
<span class="sourceLineNo">265</span>      treeSect = rest.substring(0, etInd-1).trim();<a name="line.265"></a>
<span class="sourceLineNo">266</span>//      if(rest.substring(etInd).contains("|EV|")) {<a name="line.266"></a>
<span class="sourceLineNo">267</span>      vectSect = rest.substring(etInd + 4); // skip over |ET|<a name="line.267"></a>
<span class="sourceLineNo">268</span>//      }<a name="line.268"></a>
<span class="sourceLineNo">269</span>    }else {<a name="line.269"></a>
<span class="sourceLineNo">270</span>      vectSect = rest;<a name="line.270"></a>
<span class="sourceLineNo">271</span>    }<a name="line.271"></a>
<span class="sourceLineNo">272</span>    <a name="line.272"></a>
<span class="sourceLineNo">273</span>    // read trees:<a name="line.273"></a>
<span class="sourceLineNo">274</span>    LinkedHashMap&lt;String,String&gt; treeFeats = new LinkedHashMap&lt;String,String&gt;();<a name="line.274"></a>
<span class="sourceLineNo">275</span>    if(treeSect != null){<a name="line.275"></a>
<span class="sourceLineNo">276</span>      String[] trees = treeSect.substring(5).split("\\|BT\\|");<a name="line.276"></a>
<span class="sourceLineNo">277</span>      for(int i = 0; i &lt; trees.length; i++){<a name="line.277"></a>
<span class="sourceLineNo">278</span>        treeFeats.put("TK_feat_" + i, trees[i].trim());<a name="line.278"></a>
<span class="sourceLineNo">279</span>      }<a name="line.279"></a>
<span class="sourceLineNo">280</span>    }<a name="line.280"></a>
<span class="sourceLineNo">281</span>    <a name="line.281"></a>
<span class="sourceLineNo">282</span>    // read feature vectors:<a name="line.282"></a>
<span class="sourceLineNo">283</span>    FeatureVector vec = new SparseFeatureVector();<a name="line.283"></a>
<span class="sourceLineNo">284</span>    if (vectSect != null) {<a name="line.284"></a>
<span class="sourceLineNo">285</span>      String[] features = vectSect.trim().split(" +");<a name="line.285"></a>
<span class="sourceLineNo">286</span>      for (int i = 0; i &lt; features.length; i++) {<a name="line.286"></a>
<span class="sourceLineNo">287</span>        String[] parts = features[i].split(":");<a name="line.287"></a>
<span class="sourceLineNo">288</span>        int featureIndex = Integer.valueOf(parts[0]);<a name="line.288"></a>
<span class="sourceLineNo">289</span>        double featureValue = Double.valueOf(parts[1]);<a name="line.289"></a>
<span class="sourceLineNo">290</span>        try {<a name="line.290"></a>
<span class="sourceLineNo">291</span>          vec.set(featureIndex, featureValue);<a name="line.291"></a>
<span class="sourceLineNo">292</span>        } catch (InvalidFeatureVectorValueException e) {<a name="line.292"></a>
<span class="sourceLineNo">293</span>          throw new IOException(e);<a name="line.293"></a>
<span class="sourceLineNo">294</span>        }<a name="line.294"></a>
<span class="sourceLineNo">295</span>      }<a name="line.295"></a>
<span class="sourceLineNo">296</span>    }<a name="line.296"></a>
<span class="sourceLineNo">297</span>    <a name="line.297"></a>
<span class="sourceLineNo">298</span>    treeVector.setTrees(treeFeats);<a name="line.298"></a>
<span class="sourceLineNo">299</span>    treeVector.setFeatures(vec);<a name="line.299"></a>
<span class="sourceLineNo">300</span>        <a name="line.300"></a>
<span class="sourceLineNo">301</span>    return new Instance&lt;TreeFeatureVector&gt;(Double.parseDouble(label), treeVector);<a name="line.301"></a>
<span class="sourceLineNo">302</span>  }<a name="line.302"></a>
<span class="sourceLineNo">303</span><a name="line.303"></a>
<span class="sourceLineNo">304</span>  /**<a name="line.304"></a>
<span class="sourceLineNo">305</span>   * package the classifier found in dir into the a Jar file.<a name="line.305"></a>
<span class="sourceLineNo">306</span>   */<a name="line.306"></a>
<span class="sourceLineNo">307</span>  @Override<a name="line.307"></a>
<span class="sourceLineNo">308</span>  protected void packageClassifier(File dir, JarOutputStream modelStream) throws IOException {<a name="line.308"></a>
<span class="sourceLineNo">309</span>    super.packageClassifier(dir, modelStream);<a name="line.309"></a>
<span class="sourceLineNo">310</span>    JarStreams.putNextJarEntry(modelStream, "model.libsvm", getModelFile(dir));<a name="line.310"></a>
<span class="sourceLineNo">311</span>  }<a name="line.311"></a>
<span class="sourceLineNo">312</span><a name="line.312"></a>
<span class="sourceLineNo">313</span>  /**<a name="line.313"></a>
<span class="sourceLineNo">314</span>   * unpackage the model files found in a JarInputStream.<a name="line.314"></a>
<span class="sourceLineNo">315</span>   */<a name="line.315"></a>
<span class="sourceLineNo">316</span>  @Override<a name="line.316"></a>
<span class="sourceLineNo">317</span>  protected void unpackageClassifier(JarInputStream modelStream) throws IOException {<a name="line.317"></a>
<span class="sourceLineNo">318</span>    super.unpackageClassifier(modelStream);<a name="line.318"></a>
<span class="sourceLineNo">319</span>    JarStreams.getNextJarEntry(modelStream, "model.libsvm");<a name="line.319"></a>
<span class="sourceLineNo">320</span>    model = TreeKernelSvmModel.fromInputStream(modelStream);<a name="line.320"></a>
<span class="sourceLineNo">321</span>  }<a name="line.321"></a>
<span class="sourceLineNo">322</span><a name="line.322"></a>
<span class="sourceLineNo">323</span>  @Override<a name="line.323"></a>
<span class="sourceLineNo">324</span>  protected TreeKernelSvmBooleanOutcomeClassifier newClassifier() {<a name="line.324"></a>
<span class="sourceLineNo">325</span>    return new TreeKernelSvmBooleanOutcomeClassifier(this.featuresEncoder, this.outcomeEncoder, this.model);<a name="line.325"></a>
<span class="sourceLineNo">326</span>  }<a name="line.326"></a>
<span class="sourceLineNo">327</span>}<a name="line.327"></a>




























































</pre>
</div>
</body>
</html>
