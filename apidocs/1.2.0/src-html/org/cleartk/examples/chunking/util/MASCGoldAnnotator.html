<HTML>
<BODY BGCOLOR="white">
<PRE>
<FONT color="green">001</FONT>    /* <a name="line.1"></a>
<FONT color="green">002</FONT>     * Copyright (c) 2012, Regents of the University of Colorado <a name="line.2"></a>
<FONT color="green">003</FONT>     * All rights reserved.<a name="line.3"></a>
<FONT color="green">004</FONT>     * <a name="line.4"></a>
<FONT color="green">005</FONT>     * Redistribution and use in source and binary forms, with or without<a name="line.5"></a>
<FONT color="green">006</FONT>     * modification, are permitted provided that the following conditions are met:<a name="line.6"></a>
<FONT color="green">007</FONT>     * <a name="line.7"></a>
<FONT color="green">008</FONT>     * Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer. <a name="line.8"></a>
<FONT color="green">009</FONT>     * Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution. <a name="line.9"></a>
<FONT color="green">010</FONT>     * Neither the name of the University of Colorado at Boulder nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission. <a name="line.10"></a>
<FONT color="green">011</FONT>     * <a name="line.11"></a>
<FONT color="green">012</FONT>     * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"<a name="line.12"></a>
<FONT color="green">013</FONT>     * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE<a name="line.13"></a>
<FONT color="green">014</FONT>     * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE<a name="line.14"></a>
<FONT color="green">015</FONT>     * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE<a name="line.15"></a>
<FONT color="green">016</FONT>     * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR<a name="line.16"></a>
<FONT color="green">017</FONT>     * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF<a name="line.17"></a>
<FONT color="green">018</FONT>     * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS<a name="line.18"></a>
<FONT color="green">019</FONT>     * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN<a name="line.19"></a>
<FONT color="green">020</FONT>     * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)<a name="line.20"></a>
<FONT color="green">021</FONT>     * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE<a name="line.21"></a>
<FONT color="green">022</FONT>     * POSSIBILITY OF SUCH DAMAGE. <a name="line.22"></a>
<FONT color="green">023</FONT>     */<a name="line.23"></a>
<FONT color="green">024</FONT>    package org.cleartk.examples.chunking.util;<a name="line.24"></a>
<FONT color="green">025</FONT>    <a name="line.25"></a>
<FONT color="green">026</FONT>    import java.io.File;<a name="line.26"></a>
<FONT color="green">027</FONT>    import java.io.IOException;<a name="line.27"></a>
<FONT color="green">028</FONT>    import java.util.HashMap;<a name="line.28"></a>
<FONT color="green">029</FONT>    import java.util.List;<a name="line.29"></a>
<FONT color="green">030</FONT>    import java.util.Map;<a name="line.30"></a>
<FONT color="green">031</FONT>    import java.util.Map.Entry;<a name="line.31"></a>
<FONT color="green">032</FONT>    <a name="line.32"></a>
<FONT color="green">033</FONT>    import org.apache.uima.analysis_engine.AnalysisEngineDescription;<a name="line.33"></a>
<FONT color="green">034</FONT>    import org.apache.uima.analysis_engine.AnalysisEngineProcessException;<a name="line.34"></a>
<FONT color="green">035</FONT>    import org.apache.uima.jcas.JCas;<a name="line.35"></a>
<FONT color="green">036</FONT>    import org.apache.uima.resource.ResourceInitializationException;<a name="line.36"></a>
<FONT color="green">037</FONT>    import org.cleartk.ne.type.NamedEntityMention;<a name="line.37"></a>
<FONT color="green">038</FONT>    import org.cleartk.token.type.Sentence;<a name="line.38"></a>
<FONT color="green">039</FONT>    import org.cleartk.token.type.Token;<a name="line.39"></a>
<FONT color="green">040</FONT>    import org.cleartk.util.ViewURIUtil;<a name="line.40"></a>
<FONT color="green">041</FONT>    import org.jdom2.Element;<a name="line.41"></a>
<FONT color="green">042</FONT>    import org.jdom2.JDOMException;<a name="line.42"></a>
<FONT color="green">043</FONT>    import org.jdom2.Namespace;<a name="line.43"></a>
<FONT color="green">044</FONT>    import org.jdom2.input.SAXBuilder;<a name="line.44"></a>
<FONT color="green">045</FONT>    import org.jdom2.output.XMLOutputter;<a name="line.45"></a>
<FONT color="green">046</FONT>    import org.uimafit.component.JCasAnnotator_ImplBase;<a name="line.46"></a>
<FONT color="green">047</FONT>    import org.uimafit.factory.AnalysisEngineFactory;<a name="line.47"></a>
<FONT color="green">048</FONT>    <a name="line.48"></a>
<FONT color="green">049</FONT>    /**<a name="line.49"></a>
<FONT color="green">050</FONT>     * This class reads MASC (http://www.anc.org/MASC) annotations into the CAS.<a name="line.50"></a>
<FONT color="green">051</FONT>     * <a name="line.51"></a>
<FONT color="green">052</FONT>     * For most people browsing through the chunking examples, this is not worth looking at -- it's just<a name="line.52"></a>
<FONT color="green">053</FONT>     * necessary so that we can have some human-annotated named entity mentions to train on.<a name="line.53"></a>
<FONT color="green">054</FONT>     * <a name="line.54"></a>
<FONT color="green">055</FONT>     * Eventually, this should probably be refined and moved to somewhere else in ClearTK where anyone<a name="line.55"></a>
<FONT color="green">056</FONT>     * working from the MASC corpus could use it.<a name="line.56"></a>
<FONT color="green">057</FONT>     * <a name="line.57"></a>
<FONT color="green">058</FONT>     * &lt;br&gt;<a name="line.58"></a>
<FONT color="green">059</FONT>     * Copyright (c) 2012, Regents of the University of Colorado &lt;br&gt;<a name="line.59"></a>
<FONT color="green">060</FONT>     * All rights reserved.<a name="line.60"></a>
<FONT color="green">061</FONT>     * <a name="line.61"></a>
<FONT color="green">062</FONT>     * @author Steven Bethard<a name="line.62"></a>
<FONT color="green">063</FONT>     */<a name="line.63"></a>
<FONT color="green">064</FONT>    public class MASCGoldAnnotator extends JCasAnnotator_ImplBase {<a name="line.64"></a>
<FONT color="green">065</FONT>    <a name="line.65"></a>
<FONT color="green">066</FONT>      public static AnalysisEngineDescription getDescription() throws ResourceInitializationException {<a name="line.66"></a>
<FONT color="green">067</FONT>        return AnalysisEngineFactory.createPrimitiveDescription(MASCGoldAnnotator.class);<a name="line.67"></a>
<FONT color="green">068</FONT>      }<a name="line.68"></a>
<FONT color="green">069</FONT>    <a name="line.69"></a>
<FONT color="green">070</FONT>      @Override<a name="line.70"></a>
<FONT color="green">071</FONT>      public void process(JCas jCas) throws AnalysisEngineProcessException {<a name="line.71"></a>
<FONT color="green">072</FONT>        File textFile = new File(ViewURIUtil.getURI(jCas));<a name="line.72"></a>
<FONT color="green">073</FONT>        String prefix = textFile.getPath().replaceAll("[.]txt$", "");<a name="line.73"></a>
<FONT color="green">074</FONT>        File sFile = new File(prefix + "-s.xml");<a name="line.74"></a>
<FONT color="green">075</FONT>        File segFile = new File(prefix + "-seg.xml");<a name="line.75"></a>
<FONT color="green">076</FONT>        File pennFile = new File(prefix + "-penn.xml");<a name="line.76"></a>
<FONT color="green">077</FONT>        File neFile = new File(prefix + "-ne.xml");<a name="line.77"></a>
<FONT color="green">078</FONT>    <a name="line.78"></a>
<FONT color="green">079</FONT>        Namespace xmlNS = Namespace.XML_NAMESPACE;<a name="line.79"></a>
<FONT color="green">080</FONT>        Namespace grafNS = Namespace.getNamespace("http://www.xces.org/ns/GrAF/1.0/");<a name="line.80"></a>
<FONT color="green">081</FONT>    <a name="line.81"></a>
<FONT color="green">082</FONT>        // parse sentences<a name="line.82"></a>
<FONT color="green">083</FONT>        Element sRoot = parse(sFile);<a name="line.83"></a>
<FONT color="green">084</FONT>        for (Element regionElem : sRoot.getChildren("region", grafNS)) {<a name="line.84"></a>
<FONT color="green">085</FONT>          // String id = getAttributeValue(regionElem, "id", xmlNS);<a name="line.85"></a>
<FONT color="green">086</FONT>          String anchorsString = getAttributeValue(regionElem, "anchors");<a name="line.86"></a>
<FONT color="green">087</FONT>    <a name="line.87"></a>
<FONT color="green">088</FONT>          String[] beginAndEnd = anchorsString.split("\\s+");<a name="line.88"></a>
<FONT color="green">089</FONT>          if (beginAndEnd.length != 2) {<a name="line.89"></a>
<FONT color="green">090</FONT>            throw new IllegalStateException("expected two anchors, found " + toString(regionElem));<a name="line.90"></a>
<FONT color="green">091</FONT>          }<a name="line.91"></a>
<FONT color="green">092</FONT>    <a name="line.92"></a>
<FONT color="green">093</FONT>          int begin = Integer.parseInt(beginAndEnd[0]);<a name="line.93"></a>
<FONT color="green">094</FONT>          int end = Integer.parseInt(beginAndEnd[1]);<a name="line.94"></a>
<FONT color="green">095</FONT>          Sentence sentence = new Sentence(jCas, begin, end);<a name="line.95"></a>
<FONT color="green">096</FONT>          sentence.addToIndexes();<a name="line.96"></a>
<FONT color="green">097</FONT>        }<a name="line.97"></a>
<FONT color="green">098</FONT>    <a name="line.98"></a>
<FONT color="green">099</FONT>        // parse segment begins and ends<a name="line.99"></a>
<FONT color="green">100</FONT>        Element segRoot = parse(segFile);<a name="line.100"></a>
<FONT color="green">101</FONT>        Map&lt;String, Integer&gt; beginMap = new HashMap&lt;String, Integer&gt;();<a name="line.101"></a>
<FONT color="green">102</FONT>        Map&lt;String, Integer&gt; endMap = new HashMap&lt;String, Integer&gt;();<a name="line.102"></a>
<FONT color="green">103</FONT>        for (Element regionElem : segRoot.getChildren("region", grafNS)) {<a name="line.103"></a>
<FONT color="green">104</FONT>          String id = getAttributeValue(regionElem, "id", xmlNS);<a name="line.104"></a>
<FONT color="green">105</FONT>          String anchorsString = getAttributeValue(regionElem, "anchors");<a name="line.105"></a>
<FONT color="green">106</FONT>    <a name="line.106"></a>
<FONT color="green">107</FONT>          String[] beginAndEnd = anchorsString.split("\\s+");<a name="line.107"></a>
<FONT color="green">108</FONT>          if (beginAndEnd.length != 2) {<a name="line.108"></a>
<FONT color="green">109</FONT>            throw new IllegalStateException("expected two anchors, found " + toString(regionElem));<a name="line.109"></a>
<FONT color="green">110</FONT>          }<a name="line.110"></a>
<FONT color="green">111</FONT>    <a name="line.111"></a>
<FONT color="green">112</FONT>          beginMap.put(id, new Integer(beginAndEnd[0]));<a name="line.112"></a>
<FONT color="green">113</FONT>          endMap.put(id, new Integer(beginAndEnd[1]));<a name="line.113"></a>
<FONT color="green">114</FONT>        }<a name="line.114"></a>
<FONT color="green">115</FONT>    <a name="line.115"></a>
<FONT color="green">116</FONT>        // parse tokens<a name="line.116"></a>
<FONT color="green">117</FONT>        Map&lt;String, Token&gt; idTokenMap = new HashMap&lt;String, Token&gt;();<a name="line.117"></a>
<FONT color="green">118</FONT>        Element pennRoot = parse(pennFile);<a name="line.118"></a>
<FONT color="green">119</FONT>        for (Element nodeElem : pennRoot.getChildren("node", grafNS)) {<a name="line.119"></a>
<FONT color="green">120</FONT>          String id = getAttributeValue(nodeElem, "id", xmlNS);<a name="line.120"></a>
<FONT color="green">121</FONT>          Element linkElem = getChild(nodeElem, "link", grafNS);<a name="line.121"></a>
<FONT color="green">122</FONT>          String targets = getAttributeValue(linkElem, "targets");<a name="line.122"></a>
<FONT color="green">123</FONT>    <a name="line.123"></a>
<FONT color="green">124</FONT>          String[] targetsArray = targets.split("\\s+");<a name="line.124"></a>
<FONT color="green">125</FONT>          String beginID = targetsArray[0];<a name="line.125"></a>
<FONT color="green">126</FONT>          String endID = targetsArray[targetsArray.length - 1];<a name="line.126"></a>
<FONT color="green">127</FONT>          Integer begin = beginMap.get(beginID);<a name="line.127"></a>
<FONT color="green">128</FONT>          if (begin == null) {<a name="line.128"></a>
<FONT color="green">129</FONT>            throw new IllegalStateException("no such segment: " + beginID);<a name="line.129"></a>
<FONT color="green">130</FONT>          }<a name="line.130"></a>
<FONT color="green">131</FONT>          Integer end = endMap.get(endID);<a name="line.131"></a>
<FONT color="green">132</FONT>          if (end == null) {<a name="line.132"></a>
<FONT color="green">133</FONT>            throw new IllegalStateException("no such segment: " + endID);<a name="line.133"></a>
<FONT color="green">134</FONT>          }<a name="line.134"></a>
<FONT color="green">135</FONT>    <a name="line.135"></a>
<FONT color="green">136</FONT>          Token token = new Token(jCas, begin, end);<a name="line.136"></a>
<FONT color="green">137</FONT>          // TODO: parse part-of-speech information out of pennRoot<a name="line.137"></a>
<FONT color="green">138</FONT>          token.addToIndexes();<a name="line.138"></a>
<FONT color="green">139</FONT>          idTokenMap.put(id, token);<a name="line.139"></a>
<FONT color="green">140</FONT>        }<a name="line.140"></a>
<FONT color="green">141</FONT>    <a name="line.141"></a>
<FONT color="green">142</FONT>        // parse named entities<a name="line.142"></a>
<FONT color="green">143</FONT>        Element neRoot = parse(neFile);<a name="line.143"></a>
<FONT color="green">144</FONT>        Map&lt;String, NamedEntityMention&gt; idMentionMap = new HashMap&lt;String, NamedEntityMention&gt;();<a name="line.144"></a>
<FONT color="green">145</FONT>        for (Element edgeElem : neRoot.getChildren("edge", grafNS)) {<a name="line.145"></a>
<FONT color="green">146</FONT>          String mentionID = getAttributeValue(edgeElem, "from");<a name="line.146"></a>
<FONT color="green">147</FONT>          NamedEntityMention mention = idMentionMap.get(mentionID);<a name="line.147"></a>
<FONT color="green">148</FONT>          if (mention == null) {<a name="line.148"></a>
<FONT color="green">149</FONT>            mention = new NamedEntityMention(jCas, jCas.getDocumentText().length(), 0);<a name="line.149"></a>
<FONT color="green">150</FONT>            idMentionMap.put(mentionID, mention);<a name="line.150"></a>
<FONT color="green">151</FONT>          }<a name="line.151"></a>
<FONT color="green">152</FONT>    <a name="line.152"></a>
<FONT color="green">153</FONT>          String tokenID = getAttributeValue(edgeElem, "to");<a name="line.153"></a>
<FONT color="green">154</FONT>          Token token = idTokenMap.get(tokenID);<a name="line.154"></a>
<FONT color="green">155</FONT>          if (token == null) {<a name="line.155"></a>
<FONT color="green">156</FONT>            throw new IllegalStateException("no token with id " + tokenID);<a name="line.156"></a>
<FONT color="green">157</FONT>          }<a name="line.157"></a>
<FONT color="green">158</FONT>    <a name="line.158"></a>
<FONT color="green">159</FONT>          // simplifying assumption - named entity spans continuously across all tokens<a name="line.159"></a>
<FONT color="green">160</FONT>          if (token.getBegin() &lt; mention.getBegin()) {<a name="line.160"></a>
<FONT color="green">161</FONT>            mention.setBegin(token.getBegin());<a name="line.161"></a>
<FONT color="green">162</FONT>          }<a name="line.162"></a>
<FONT color="green">163</FONT>          if (token.getEnd() &gt; mention.getEnd()) {<a name="line.163"></a>
<FONT color="green">164</FONT>            mention.setEnd(token.getEnd());<a name="line.164"></a>
<FONT color="green">165</FONT>          }<a name="line.165"></a>
<FONT color="green">166</FONT>        }<a name="line.166"></a>
<FONT color="green">167</FONT>        for (Element aElem : neRoot.getChildren("a", grafNS)) {<a name="line.167"></a>
<FONT color="green">168</FONT>          String label = getAttributeValue(aElem, "label");<a name="line.168"></a>
<FONT color="green">169</FONT>          String mentionID = getAttributeValue(aElem, "ref");<a name="line.169"></a>
<FONT color="green">170</FONT>          NamedEntityMention mention = idMentionMap.get(mentionID);<a name="line.170"></a>
<FONT color="green">171</FONT>          if (mention == null) {<a name="line.171"></a>
<FONT color="green">172</FONT>            throw new IllegalStateException("no mention for ref in " + toString(aElem));<a name="line.172"></a>
<FONT color="green">173</FONT>          }<a name="line.173"></a>
<FONT color="green">174</FONT>    <a name="line.174"></a>
<FONT color="green">175</FONT>          // TODO: parse out features like gender<a name="line.175"></a>
<FONT color="green">176</FONT>          // Element fsElem = getChild(aElem, "fs", grafNS);<a name="line.176"></a>
<FONT color="green">177</FONT>          // for (Element fElem : fsElem.getChildren("f", grafNS)) {<a name="line.177"></a>
<FONT color="green">178</FONT>          // String name = getAttributeValue(fElem, "name");<a name="line.178"></a>
<FONT color="green">179</FONT>          // String value = getAttributeValue(fElem, "value");<a name="line.179"></a>
<FONT color="green">180</FONT>          // }<a name="line.180"></a>
<FONT color="green">181</FONT>    <a name="line.181"></a>
<FONT color="green">182</FONT>          mention.setMentionType(label);<a name="line.182"></a>
<FONT color="green">183</FONT>        }<a name="line.183"></a>
<FONT color="green">184</FONT>        for (Entry&lt;String, NamedEntityMention&gt; entry : idMentionMap.entrySet()) {<a name="line.184"></a>
<FONT color="green">185</FONT>          NamedEntityMention mention = entry.getValue();<a name="line.185"></a>
<FONT color="green">186</FONT>          if (mention.getMentionType() == null) {<a name="line.186"></a>
<FONT color="green">187</FONT>            throw new IllegalStateException("no mention type for mention " + entry.getKey());<a name="line.187"></a>
<FONT color="green">188</FONT>          }<a name="line.188"></a>
<FONT color="green">189</FONT>          mention.addToIndexes();<a name="line.189"></a>
<FONT color="green">190</FONT>        }<a name="line.190"></a>
<FONT color="green">191</FONT>      }<a name="line.191"></a>
<FONT color="green">192</FONT>    <a name="line.192"></a>
<FONT color="green">193</FONT>      private static Element parse(File file) throws AnalysisEngineProcessException {<a name="line.193"></a>
<FONT color="green">194</FONT>        SAXBuilder sax = new SAXBuilder();<a name="line.194"></a>
<FONT color="green">195</FONT>        try {<a name="line.195"></a>
<FONT color="green">196</FONT>          return sax.build(file).getRootElement();<a name="line.196"></a>
<FONT color="green">197</FONT>        } catch (JDOMException e) {<a name="line.197"></a>
<FONT color="green">198</FONT>          throw new AnalysisEngineProcessException(e);<a name="line.198"></a>
<FONT color="green">199</FONT>        } catch (IOException e) {<a name="line.199"></a>
<FONT color="green">200</FONT>          throw new AnalysisEngineProcessException(e);<a name="line.200"></a>
<FONT color="green">201</FONT>        }<a name="line.201"></a>
<FONT color="green">202</FONT>    <a name="line.202"></a>
<FONT color="green">203</FONT>      }<a name="line.203"></a>
<FONT color="green">204</FONT>    <a name="line.204"></a>
<FONT color="green">205</FONT>      private static Element getChild(Element elem, String name, Namespace namespace) {<a name="line.205"></a>
<FONT color="green">206</FONT>        List&lt;Element&gt; elems = elem.getChildren(name, namespace);<a name="line.206"></a>
<FONT color="green">207</FONT>        if (elems.size() != 1) {<a name="line.207"></a>
<FONT color="green">208</FONT>          throw new IllegalStateException("expected 1 \"" + name + "\" element in " + toString(elem));<a name="line.208"></a>
<FONT color="green">209</FONT>        }<a name="line.209"></a>
<FONT color="green">210</FONT>        return elems.get(0);<a name="line.210"></a>
<FONT color="green">211</FONT>      }<a name="line.211"></a>
<FONT color="green">212</FONT>    <a name="line.212"></a>
<FONT color="green">213</FONT>      private static String getAttributeValue(Element elem, String attrName) {<a name="line.213"></a>
<FONT color="green">214</FONT>        return getAttributeValue(elem, attrName, null);<a name="line.214"></a>
<FONT color="green">215</FONT>      }<a name="line.215"></a>
<FONT color="green">216</FONT>    <a name="line.216"></a>
<FONT color="green">217</FONT>      private static String getAttributeValue(Element elem, String attrName, Namespace namespace) {<a name="line.217"></a>
<FONT color="green">218</FONT>        String value;<a name="line.218"></a>
<FONT color="green">219</FONT>        if (namespace == null) {<a name="line.219"></a>
<FONT color="green">220</FONT>          value = elem.getAttributeValue(attrName);<a name="line.220"></a>
<FONT color="green">221</FONT>        } else {<a name="line.221"></a>
<FONT color="green">222</FONT>          value = elem.getAttributeValue(attrName, namespace);<a name="line.222"></a>
<FONT color="green">223</FONT>        }<a name="line.223"></a>
<FONT color="green">224</FONT>        if (value == null) {<a name="line.224"></a>
<FONT color="green">225</FONT>          throw new IllegalStateException("expected \"" + attrName + "\" attribute in "<a name="line.225"></a>
<FONT color="green">226</FONT>              + toString(elem));<a name="line.226"></a>
<FONT color="green">227</FONT>        }<a name="line.227"></a>
<FONT color="green">228</FONT>        return value;<a name="line.228"></a>
<FONT color="green">229</FONT>      }<a name="line.229"></a>
<FONT color="green">230</FONT>    <a name="line.230"></a>
<FONT color="green">231</FONT>      private static XMLOutputter xmlOutputter = new XMLOutputter();<a name="line.231"></a>
<FONT color="green">232</FONT>    <a name="line.232"></a>
<FONT color="green">233</FONT>      private static String toString(Element elem) {<a name="line.233"></a>
<FONT color="green">234</FONT>        return xmlOutputter.outputString(elem);<a name="line.234"></a>
<FONT color="green">235</FONT>      }<a name="line.235"></a>
<FONT color="green">236</FONT>    }<a name="line.236"></a>




























































</PRE>
</BODY>
</HTML>
