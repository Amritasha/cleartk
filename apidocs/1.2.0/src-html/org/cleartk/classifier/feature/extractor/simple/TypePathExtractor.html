<HTML>
<BODY BGCOLOR="white">
<PRE>
<FONT color="green">001</FONT>    /** <a name="line.1"></a>
<FONT color="green">002</FONT>     * Copyright (c) 2007-2008, Regents of the University of Colorado <a name="line.2"></a>
<FONT color="green">003</FONT>     * All rights reserved.<a name="line.3"></a>
<FONT color="green">004</FONT>     * <a name="line.4"></a>
<FONT color="green">005</FONT>     * Redistribution and use in source and binary forms, with or without<a name="line.5"></a>
<FONT color="green">006</FONT>     * modification, are permitted provided that the following conditions are met:<a name="line.6"></a>
<FONT color="green">007</FONT>     * <a name="line.7"></a>
<FONT color="green">008</FONT>     * Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer. <a name="line.8"></a>
<FONT color="green">009</FONT>     * Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution. <a name="line.9"></a>
<FONT color="green">010</FONT>     * Neither the name of the University of Colorado at Boulder nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission. <a name="line.10"></a>
<FONT color="green">011</FONT>     * <a name="line.11"></a>
<FONT color="green">012</FONT>     * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"<a name="line.12"></a>
<FONT color="green">013</FONT>     * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE<a name="line.13"></a>
<FONT color="green">014</FONT>     * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE<a name="line.14"></a>
<FONT color="green">015</FONT>     * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE<a name="line.15"></a>
<FONT color="green">016</FONT>     * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR<a name="line.16"></a>
<FONT color="green">017</FONT>     * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF<a name="line.17"></a>
<FONT color="green">018</FONT>     * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS<a name="line.18"></a>
<FONT color="green">019</FONT>     * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN<a name="line.19"></a>
<FONT color="green">020</FONT>     * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)<a name="line.20"></a>
<FONT color="green">021</FONT>     * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE<a name="line.21"></a>
<FONT color="green">022</FONT>     * POSSIBILITY OF SUCH DAMAGE. <a name="line.22"></a>
<FONT color="green">023</FONT>     */<a name="line.23"></a>
<FONT color="green">024</FONT>    package org.cleartk.classifier.feature.extractor.simple;<a name="line.24"></a>
<FONT color="green">025</FONT>    <a name="line.25"></a>
<FONT color="green">026</FONT>    import java.util.ArrayList;<a name="line.26"></a>
<FONT color="green">027</FONT>    import java.util.Arrays;<a name="line.27"></a>
<FONT color="green">028</FONT>    import java.util.HashSet;<a name="line.28"></a>
<FONT color="green">029</FONT>    import java.util.List;<a name="line.29"></a>
<FONT color="green">030</FONT>    import java.util.Set;<a name="line.30"></a>
<FONT color="green">031</FONT>    import java.util.logging.Logger;<a name="line.31"></a>
<FONT color="green">032</FONT>    <a name="line.32"></a>
<FONT color="green">033</FONT>    import org.apache.uima.cas.ArrayFS;<a name="line.33"></a>
<FONT color="green">034</FONT>    import org.apache.uima.cas.Feature;<a name="line.34"></a>
<FONT color="green">035</FONT>    import org.apache.uima.cas.FeatureStructure;<a name="line.35"></a>
<FONT color="green">036</FONT>    import org.apache.uima.cas.Type;<a name="line.36"></a>
<FONT color="green">037</FONT>    import org.apache.uima.cas.TypeSystem;<a name="line.37"></a>
<FONT color="green">038</FONT>    import org.apache.uima.jcas.JCas;<a name="line.38"></a>
<FONT color="green">039</FONT>    import org.apache.uima.jcas.cas.BooleanArray;<a name="line.39"></a>
<FONT color="green">040</FONT>    import org.apache.uima.jcas.cas.ByteArray;<a name="line.40"></a>
<FONT color="green">041</FONT>    import org.apache.uima.jcas.cas.DoubleArray;<a name="line.41"></a>
<FONT color="green">042</FONT>    import org.apache.uima.jcas.cas.FSArray;<a name="line.42"></a>
<FONT color="green">043</FONT>    import org.apache.uima.jcas.cas.FloatArray;<a name="line.43"></a>
<FONT color="green">044</FONT>    import org.apache.uima.jcas.cas.IntegerArray;<a name="line.44"></a>
<FONT color="green">045</FONT>    import org.apache.uima.jcas.cas.LongArray;<a name="line.45"></a>
<FONT color="green">046</FONT>    import org.apache.uima.jcas.cas.ShortArray;<a name="line.46"></a>
<FONT color="green">047</FONT>    import org.apache.uima.jcas.cas.StringArray;<a name="line.47"></a>
<FONT color="green">048</FONT>    import org.apache.uima.jcas.tcas.Annotation;<a name="line.48"></a>
<FONT color="green">049</FONT>    import org.cleartk.classifier.feature.extractor.CleartkExtractorException;<a name="line.49"></a>
<FONT color="green">050</FONT>    import org.cleartk.util.UIMAUtil;<a name="line.50"></a>
<FONT color="green">051</FONT>    <a name="line.51"></a>
<FONT color="green">052</FONT>    /**<a name="line.52"></a>
<FONT color="green">053</FONT>     * &lt;br&gt;<a name="line.53"></a>
<FONT color="green">054</FONT>     * Copyright (c) 2007-2008, Regents of the University of Colorado &lt;br&gt;<a name="line.54"></a>
<FONT color="green">055</FONT>     * All rights reserved.<a name="line.55"></a>
<FONT color="green">056</FONT>     * <a name="line.56"></a>
<FONT color="green">057</FONT>     * &lt;p&gt;<a name="line.57"></a>
<FONT color="green">058</FONT>     * <a name="line.58"></a>
<FONT color="green">059</FONT>     * @author Philip Ogren<a name="line.59"></a>
<FONT color="green">060</FONT>     * <a name="line.60"></a>
<FONT color="green">061</FONT>     *         TODO handle cases where the pathValue is not a String so that they are not necessarily<a name="line.61"></a>
<FONT color="green">062</FONT>     *         converted to strings<a name="line.62"></a>
<FONT color="green">063</FONT>     */<a name="line.63"></a>
<FONT color="green">064</FONT>    <a name="line.64"></a>
<FONT color="green">065</FONT>    public class TypePathExtractor implements SimpleFeatureExtractor {<a name="line.65"></a>
<FONT color="green">066</FONT>      Class&lt;? extends Annotation&gt; focusClass;<a name="line.66"></a>
<FONT color="green">067</FONT>    <a name="line.67"></a>
<FONT color="green">068</FONT>      Type type;<a name="line.68"></a>
<FONT color="green">069</FONT>    <a name="line.69"></a>
<FONT color="green">070</FONT>      String path;<a name="line.70"></a>
<FONT color="green">071</FONT>    <a name="line.71"></a>
<FONT color="green">072</FONT>      boolean allPaths;<a name="line.72"></a>
<FONT color="green">073</FONT>    <a name="line.73"></a>
<FONT color="green">074</FONT>      boolean allValues;<a name="line.74"></a>
<FONT color="green">075</FONT>    <a name="line.75"></a>
<FONT color="green">076</FONT>      boolean uniqueValues;<a name="line.76"></a>
<FONT color="green">077</FONT>    <a name="line.77"></a>
<FONT color="green">078</FONT>      boolean pathChecked = false;<a name="line.78"></a>
<FONT color="green">079</FONT>    <a name="line.79"></a>
<FONT color="green">080</FONT>      TypeSystem typeSystem;<a name="line.80"></a>
<FONT color="green">081</FONT>    <a name="line.81"></a>
<FONT color="green">082</FONT>      Logger logger = Logger.getLogger(TypePathExtractor.class.getName());<a name="line.82"></a>
<FONT color="green">083</FONT>    <a name="line.83"></a>
<FONT color="green">084</FONT>      /**<a name="line.84"></a>
<FONT color="green">085</FONT>       * This extractor creates features from attributes of an annotation. For example, if you had a<a name="line.85"></a>
<FONT color="green">086</FONT>       * type called Token with an attribute called 'pos' you could use this extractor to extract a pos<a name="line.86"></a>
<FONT color="green">087</FONT>       * attribute for tokens. This would be done by calling the constructor with the values "pos",<a name="line.87"></a>
<FONT color="green">088</FONT>       * "pos", false, and false.<a name="line.88"></a>
<FONT color="green">089</FONT>       * <a name="line.89"></a>
<FONT color="green">090</FONT>       * The value you want may be nested within the type structure of the annotation that is being<a name="line.90"></a>
<FONT color="green">091</FONT>       * examined. For example, if you might have a type called 'NamedEntity' that has an attribute of<a name="line.91"></a>
<FONT color="green">092</FONT>       * type 'ResourceEntry' that has an attribute of type 'DbRecord' that has a String attribute<a name="line.92"></a>
<FONT color="green">093</FONT>       * called 'identifier'. You may want to extract the value of the identifier as a feature of the<a name="line.93"></a>
<FONT color="green">094</FONT>       * NamedEntity annotation. This could be done by calling the constructor with the values<a name="line.94"></a>
<FONT color="green">095</FONT>       * "identifier", "resourceEntry/dbRecord/identifier", false, and false (or something similar).<a name="line.95"></a>
<FONT color="green">096</FONT>       * <a name="line.96"></a>
<FONT color="green">097</FONT>       * The value you want for your featured may be multi-valued<a name="line.97"></a>
<FONT color="green">098</FONT>       * <a name="line.98"></a>
<FONT color="green">099</FONT>       * @param focusClass<a name="line.99"></a>
<FONT color="green">100</FONT>       *          the type of annotation that you are doing feature extraction on.<a name="line.100"></a>
<FONT color="green">101</FONT>       * @param typePath<a name="line.101"></a>
<FONT color="green">102</FONT>       *          a string representation of the path that should be traversed to extract a feature<a name="line.102"></a>
<FONT color="green">103</FONT>       *          value (e.g. "resourceEntry/dbRecord/identifier" or "pos" from the examples above.)<a name="line.103"></a>
<FONT color="green">104</FONT>       * @param traverseAllPaths<a name="line.104"></a>
<FONT color="green">105</FONT>       *          The path you traverse to the value you are trying to retrieve may include attributes<a name="line.105"></a>
<FONT color="green">106</FONT>       *          that have multiple-values. If true, then all paths are examined and features for each<a name="line.106"></a>
<FONT color="green">107</FONT>       *          traversal are added if possible. If false, then the first path that results in a<a name="line.107"></a>
<FONT color="green">108</FONT>       *          non-null value will be examined.<a name="line.108"></a>
<FONT color="green">109</FONT>       * @param returnAllValues<a name="line.109"></a>
<FONT color="green">110</FONT>       *          The last node of the path may be multi-valued. If true, then all values found in the<a name="line.110"></a>
<FONT color="green">111</FONT>       *          last node will be returned as features. If false, then only the first value of the<a name="line.111"></a>
<FONT color="green">112</FONT>       *          last node is returned. If traverseAllPaths and returnAllValues are both false, then a<a name="line.112"></a>
<FONT color="green">113</FONT>       *          list of size 0 or 1 will be returned. The other three combinations are each valid and<a name="line.113"></a>
<FONT color="green">114</FONT>       *          may return a list of size 0 or greater.<a name="line.114"></a>
<FONT color="green">115</FONT>       * @param uniqueValues<a name="line.115"></a>
<FONT color="green">116</FONT>       *          if true, then the returned values of the extract method will be unique.<a name="line.116"></a>
<FONT color="green">117</FONT>       */<a name="line.117"></a>
<FONT color="green">118</FONT>    <a name="line.118"></a>
<FONT color="green">119</FONT>      public TypePathExtractor(<a name="line.119"></a>
<FONT color="green">120</FONT>          Class&lt;? extends Annotation&gt; focusClass,<a name="line.120"></a>
<FONT color="green">121</FONT>          String typePath,<a name="line.121"></a>
<FONT color="green">122</FONT>          boolean traverseAllPaths,<a name="line.122"></a>
<FONT color="green">123</FONT>          boolean returnAllValues,<a name="line.123"></a>
<FONT color="green">124</FONT>          boolean uniqueValues) {<a name="line.124"></a>
<FONT color="green">125</FONT>        this.focusClass = focusClass;<a name="line.125"></a>
<FONT color="green">126</FONT>        this.path = typePath;<a name="line.126"></a>
<FONT color="green">127</FONT>        this.allPaths = traverseAllPaths;<a name="line.127"></a>
<FONT color="green">128</FONT>        this.allValues = returnAllValues;<a name="line.128"></a>
<FONT color="green">129</FONT>        this.uniqueValues = uniqueValues;<a name="line.129"></a>
<FONT color="green">130</FONT>      }<a name="line.130"></a>
<FONT color="green">131</FONT>    <a name="line.131"></a>
<FONT color="green">132</FONT>      /**<a name="line.132"></a>
<FONT color="green">133</FONT>       * calls this(type, typePath, false, false, true, jCas)<a name="line.133"></a>
<FONT color="green">134</FONT>       */<a name="line.134"></a>
<FONT color="green">135</FONT>      public TypePathExtractor(Class&lt;? extends Annotation&gt; focusClass, String typePath) {<a name="line.135"></a>
<FONT color="green">136</FONT>        this(focusClass, typePath, false, false, true);<a name="line.136"></a>
<FONT color="green">137</FONT>      }<a name="line.137"></a>
<FONT color="green">138</FONT>    <a name="line.138"></a>
<FONT color="green">139</FONT>      public List&lt;org.cleartk.classifier.Feature&gt; extract(JCas view, Annotation focusAnnotation)<a name="line.139"></a>
<FONT color="green">140</FONT>          throws CleartkExtractorException {<a name="line.140"></a>
<FONT color="green">141</FONT>        if (this.type == null)<a name="line.141"></a>
<FONT color="green">142</FONT>          this.type = UIMAUtil.getCasType(view, this.focusClass);<a name="line.142"></a>
<FONT color="green">143</FONT>    <a name="line.143"></a>
<FONT color="green">144</FONT>        this.typeSystem = view.getTypeSystem();<a name="line.144"></a>
<FONT color="green">145</FONT>    <a name="line.145"></a>
<FONT color="green">146</FONT>        if (!isValidPath(view))<a name="line.146"></a>
<FONT color="green">147</FONT>          throw CleartkExtractorException.invalidTypePath(path, type);<a name="line.147"></a>
<FONT color="green">148</FONT>    <a name="line.148"></a>
<FONT color="green">149</FONT>        String[] pathMembers = path.split("/");<a name="line.149"></a>
<FONT color="green">150</FONT>        List&lt;Object&gt; pathValues = new ArrayList&lt;Object&gt;();<a name="line.150"></a>
<FONT color="green">151</FONT>        _extract(view, focusAnnotation, pathMembers, pathValues);<a name="line.151"></a>
<FONT color="green">152</FONT>    <a name="line.152"></a>
<FONT color="green">153</FONT>        List&lt;org.cleartk.classifier.Feature&gt; returnValues = new ArrayList&lt;org.cleartk.classifier.Feature&gt;();<a name="line.153"></a>
<FONT color="green">154</FONT>        Set&lt;Object&gt; values = new HashSet&lt;Object&gt;();<a name="line.154"></a>
<FONT color="green">155</FONT>        for (Object pathValue : pathValues) {<a name="line.155"></a>
<FONT color="green">156</FONT>          if (uniqueValues) {<a name="line.156"></a>
<FONT color="green">157</FONT>            if (!values.contains(pathValue)) {<a name="line.157"></a>
<FONT color="green">158</FONT>              org.cleartk.classifier.Feature feature = new org.cleartk.classifier.feature.TypePathFeature(<a name="line.158"></a>
<FONT color="green">159</FONT>                  null,<a name="line.159"></a>
<FONT color="green">160</FONT>                  pathValue,<a name="line.160"></a>
<FONT color="green">161</FONT>                  this.path);<a name="line.161"></a>
<FONT color="green">162</FONT>              returnValues.add(feature);<a name="line.162"></a>
<FONT color="green">163</FONT>              values.add(pathValue);<a name="line.163"></a>
<FONT color="green">164</FONT>            }<a name="line.164"></a>
<FONT color="green">165</FONT>          } else {<a name="line.165"></a>
<FONT color="green">166</FONT>            org.cleartk.classifier.Feature feature = new org.cleartk.classifier.feature.TypePathFeature(<a name="line.166"></a>
<FONT color="green">167</FONT>                null,<a name="line.167"></a>
<FONT color="green">168</FONT>                pathValue,<a name="line.168"></a>
<FONT color="green">169</FONT>                this.path);<a name="line.169"></a>
<FONT color="green">170</FONT>            returnValues.add(feature);<a name="line.170"></a>
<FONT color="green">171</FONT>          }<a name="line.171"></a>
<FONT color="green">172</FONT>        }<a name="line.172"></a>
<FONT color="green">173</FONT>    <a name="line.173"></a>
<FONT color="green">174</FONT>        return returnValues;<a name="line.174"></a>
<FONT color="green">175</FONT>      }<a name="line.175"></a>
<FONT color="green">176</FONT>    <a name="line.176"></a>
<FONT color="green">177</FONT>      private void _extract(<a name="line.177"></a>
<FONT color="green">178</FONT>          JCas view,<a name="line.178"></a>
<FONT color="green">179</FONT>          FeatureStructure featureStructure,<a name="line.179"></a>
<FONT color="green">180</FONT>          String[] pathMembers,<a name="line.180"></a>
<FONT color="green">181</FONT>          List&lt;Object&gt; pathValues) throws CleartkExtractorException {<a name="line.181"></a>
<FONT color="green">182</FONT>        if (pathMembers.length == 1) {<a name="line.182"></a>
<FONT color="green">183</FONT>          Feature feature = featureStructure.getType().getFeatureByBaseName(pathMembers[0]);<a name="line.183"></a>
<FONT color="green">184</FONT>          if (feature == null) {<a name="line.184"></a>
<FONT color="green">185</FONT>            return;<a name="line.185"></a>
<FONT color="green">186</FONT>          }<a name="line.186"></a>
<FONT color="green">187</FONT>          Type featureType = feature.getRange();<a name="line.187"></a>
<FONT color="green">188</FONT>          if (featureType.isPrimitive()) {<a name="line.188"></a>
<FONT color="green">189</FONT>            Object pathValue = getPrimitiveFeatureValue(view, featureStructure, feature);<a name="line.189"></a>
<FONT color="green">190</FONT>            if (pathValue != null)<a name="line.190"></a>
<FONT color="green">191</FONT>              pathValues.add(pathValue);<a name="line.191"></a>
<FONT color="green">192</FONT>          } else if (typeSystem.subsumes(typeSystem.getType("uima.tcas.Annotation"), featureType)) {<a name="line.192"></a>
<FONT color="green">193</FONT>            String coveredText = ((Annotation) featureStructure.getFeatureValue(feature)).getCoveredText();<a name="line.193"></a>
<FONT color="green">194</FONT>            if (coveredText != null)<a name="line.194"></a>
<FONT color="green">195</FONT>              pathValues.add(coveredText);<a name="line.195"></a>
<FONT color="green">196</FONT>          } else if (featureType.isArray()) {<a name="line.196"></a>
<FONT color="green">197</FONT>            Type componentType = featureType.getComponentType();<a name="line.197"></a>
<FONT color="green">198</FONT>            if (componentType.isPrimitive()) {<a name="line.198"></a>
<FONT color="green">199</FONT>              Object[] values = getPrimitiveArrayFeatureValue(view, featureStructure, feature);<a name="line.199"></a>
<FONT color="green">200</FONT>              if (allValues)<a name="line.200"></a>
<FONT color="green">201</FONT>                pathValues.addAll(Arrays.asList(values));<a name="line.201"></a>
<FONT color="green">202</FONT>              else if (values.length &gt; 0)<a name="line.202"></a>
<FONT color="green">203</FONT>                pathValues.add(values[0]);<a name="line.203"></a>
<FONT color="green">204</FONT>            } else if (typeSystem.subsumes(typeSystem.getType("uima.tcas.Annotation"), componentType)) {<a name="line.204"></a>
<FONT color="green">205</FONT>              ArrayFS fsArray = (ArrayFS) featureStructure.getFeatureValue(feature);<a name="line.205"></a>
<FONT color="green">206</FONT>              FeatureStructure[] array = fsArray.toArray();<a name="line.206"></a>
<FONT color="green">207</FONT>              if (allValues) {<a name="line.207"></a>
<FONT color="green">208</FONT>                for (FeatureStructure ftr : array)<a name="line.208"></a>
<FONT color="green">209</FONT>                  pathValues.add(((Annotation) ftr).getCoveredText());<a name="line.209"></a>
<FONT color="green">210</FONT>              } else {<a name="line.210"></a>
<FONT color="green">211</FONT>                if (array.length &gt; 0)<a name="line.211"></a>
<FONT color="green">212</FONT>                  pathValues.add(((Annotation) array[0]).getCoveredText());<a name="line.212"></a>
<FONT color="green">213</FONT>              }<a name="line.213"></a>
<FONT color="green">214</FONT>            }<a name="line.214"></a>
<FONT color="green">215</FONT>          }<a name="line.215"></a>
<FONT color="green">216</FONT>          // TODO else if type is a List type<a name="line.216"></a>
<FONT color="green">217</FONT>        } else {<a name="line.217"></a>
<FONT color="green">218</FONT>          String[] remainingPathMembers = new String[pathMembers.length - 1];<a name="line.218"></a>
<FONT color="green">219</FONT>          System.arraycopy(pathMembers, 1, remainingPathMembers, 0, pathMembers.length - 1);<a name="line.219"></a>
<FONT color="green">220</FONT>    <a name="line.220"></a>
<FONT color="green">221</FONT>          Feature feature = featureStructure.getType().getFeatureByBaseName(pathMembers[0]);<a name="line.221"></a>
<FONT color="green">222</FONT>          FeatureStructure featureValue = featureStructure.getFeatureValue(feature);<a name="line.222"></a>
<FONT color="green">223</FONT>          if (featureValue == null)<a name="line.223"></a>
<FONT color="green">224</FONT>            return;<a name="line.224"></a>
<FONT color="green">225</FONT>          if (featureValue instanceof FSArray) {<a name="line.225"></a>
<FONT color="green">226</FONT>            FSArray fsArray = (FSArray) featureValue;<a name="line.226"></a>
<FONT color="green">227</FONT>            if (allPaths) {<a name="line.227"></a>
<FONT color="green">228</FONT>              for (int i = 0; i &lt; fsArray.size(); i++) {<a name="line.228"></a>
<FONT color="green">229</FONT>                FeatureStructure fs = fsArray.get(i);<a name="line.229"></a>
<FONT color="green">230</FONT>                _extract(view, fs, remainingPathMembers, pathValues);<a name="line.230"></a>
<FONT color="green">231</FONT>              }<a name="line.231"></a>
<FONT color="green">232</FONT>            } else {<a name="line.232"></a>
<FONT color="green">233</FONT>              if (fsArray.size() &gt; 0)<a name="line.233"></a>
<FONT color="green">234</FONT>                _extract(view, fsArray.get(0), remainingPathMembers, pathValues);<a name="line.234"></a>
<FONT color="green">235</FONT>            }<a name="line.235"></a>
<FONT color="green">236</FONT>          }<a name="line.236"></a>
<FONT color="green">237</FONT>          // TODO else if(featureValue instanceof FSList)<a name="line.237"></a>
<FONT color="green">238</FONT>          else {<a name="line.238"></a>
<FONT color="green">239</FONT>            _extract(view, featureValue, remainingPathMembers, pathValues);<a name="line.239"></a>
<FONT color="green">240</FONT>          }<a name="line.240"></a>
<FONT color="green">241</FONT>        }<a name="line.241"></a>
<FONT color="green">242</FONT>      }<a name="line.242"></a>
<FONT color="green">243</FONT>    <a name="line.243"></a>
<FONT color="green">244</FONT>      private boolean isValidPath(JCas view) {<a name="line.244"></a>
<FONT color="green">245</FONT>        if (!pathChecked) {<a name="line.245"></a>
<FONT color="green">246</FONT>          boolean validPath = isValidPath(type, path, view);<a name="line.246"></a>
<FONT color="green">247</FONT>          if (validPath)<a name="line.247"></a>
<FONT color="green">248</FONT>            pathChecked = true;<a name="line.248"></a>
<FONT color="green">249</FONT>          return validPath;<a name="line.249"></a>
<FONT color="green">250</FONT>        } else<a name="line.250"></a>
<FONT color="green">251</FONT>          return true;<a name="line.251"></a>
<FONT color="green">252</FONT>      }<a name="line.252"></a>
<FONT color="green">253</FONT>    <a name="line.253"></a>
<FONT color="green">254</FONT>      // TODO should be possible to just get the Feature from the type system and<a name="line.254"></a>
<FONT color="green">255</FONT>      // return<a name="line.255"></a>
<FONT color="green">256</FONT>      // true if it is not null.<a name="line.256"></a>
<FONT color="green">257</FONT>      public static boolean isValidPath(Type type, String path, JCas view) {<a name="line.257"></a>
<FONT color="green">258</FONT>        String[] pathMembers = path.split("/");<a name="line.258"></a>
<FONT color="green">259</FONT>        Type pathMemberType = type; // will be set to type of last path member<a name="line.259"></a>
<FONT color="green">260</FONT>        // feature type<a name="line.260"></a>
<FONT color="green">261</FONT>        for (String pathMember : pathMembers) {<a name="line.261"></a>
<FONT color="green">262</FONT>          Feature feature = pathMemberType.getFeatureByBaseName(pathMember);<a name="line.262"></a>
<FONT color="green">263</FONT>          if (feature == null) {<a name="line.263"></a>
<FONT color="green">264</FONT>            return false;<a name="line.264"></a>
<FONT color="green">265</FONT>          }<a name="line.265"></a>
<FONT color="green">266</FONT>          pathMemberType = feature.getRange();<a name="line.266"></a>
<FONT color="green">267</FONT>          if (pathMemberType.isArray())<a name="line.267"></a>
<FONT color="green">268</FONT>            pathMemberType = pathMemberType.getComponentType();<a name="line.268"></a>
<FONT color="green">269</FONT>        }<a name="line.269"></a>
<FONT color="green">270</FONT>        return isValidType(pathMemberType, view.getTypeSystem());<a name="line.270"></a>
<FONT color="green">271</FONT>      }<a name="line.271"></a>
<FONT color="green">272</FONT>    <a name="line.272"></a>
<FONT color="green">273</FONT>      private static final String[] HANDLED_TYPES = new String[] {<a name="line.273"></a>
<FONT color="green">274</FONT>          "uima.cas.Boolean",<a name="line.274"></a>
<FONT color="green">275</FONT>          "uima.cas.BooleanArray",<a name="line.275"></a>
<FONT color="green">276</FONT>          "uima.cas.Byte",<a name="line.276"></a>
<FONT color="green">277</FONT>          "uima.cas.ByteArray",<a name="line.277"></a>
<FONT color="green">278</FONT>          "uima.cas.Double",<a name="line.278"></a>
<FONT color="green">279</FONT>          "uima.cas.DoubleArray",<a name="line.279"></a>
<FONT color="green">280</FONT>          "uima.cas.Float",<a name="line.280"></a>
<FONT color="green">281</FONT>          "uima.cas.FloatArray",<a name="line.281"></a>
<FONT color="green">282</FONT>          "uima.cas.FloatList",<a name="line.282"></a>
<FONT color="green">283</FONT>          "uima.cas.Integer",<a name="line.283"></a>
<FONT color="green">284</FONT>          "uima.cas.IntegerArray",<a name="line.284"></a>
<FONT color="green">285</FONT>          "uima.cas.IntegerList",<a name="line.285"></a>
<FONT color="green">286</FONT>          "uima.cas.Long",<a name="line.286"></a>
<FONT color="green">287</FONT>          "uima.cas.LongArray",<a name="line.287"></a>
<FONT color="green">288</FONT>          "uima.cas.Short",<a name="line.288"></a>
<FONT color="green">289</FONT>          "uima.cas.ShortArray",<a name="line.289"></a>
<FONT color="green">290</FONT>          "uima.cas.String",<a name="line.290"></a>
<FONT color="green">291</FONT>          "uima.cas.StringArray",<a name="line.291"></a>
<FONT color="green">292</FONT>          "uima.cas.StringList",<a name="line.292"></a>
<FONT color="green">293</FONT>          "uima.tcas.Annotation" };<a name="line.293"></a>
<FONT color="green">294</FONT>    <a name="line.294"></a>
<FONT color="green">295</FONT>      public static boolean isValidType(Type type, TypeSystem typeSystem) {<a name="line.295"></a>
<FONT color="green">296</FONT>        String typeName = type.getName();<a name="line.296"></a>
<FONT color="green">297</FONT>        for (String handledType : HANDLED_TYPES) {<a name="line.297"></a>
<FONT color="green">298</FONT>          if (typeName.equals(handledType))<a name="line.298"></a>
<FONT color="green">299</FONT>            return true;<a name="line.299"></a>
<FONT color="green">300</FONT>        }<a name="line.300"></a>
<FONT color="green">301</FONT>    <a name="line.301"></a>
<FONT color="green">302</FONT>        // see section 2.3.4 of UIMA References<a name="line.302"></a>
<FONT color="green">303</FONT>        if (typeSystem.subsumes(typeSystem.getType("uima.cas.String"), type))<a name="line.303"></a>
<FONT color="green">304</FONT>          return true;<a name="line.304"></a>
<FONT color="green">305</FONT>        if (typeSystem.subsumes(typeSystem.getType("uima.tcas.Annotation"), type))<a name="line.305"></a>
<FONT color="green">306</FONT>          return true;<a name="line.306"></a>
<FONT color="green">307</FONT>    <a name="line.307"></a>
<FONT color="green">308</FONT>        return false;<a name="line.308"></a>
<FONT color="green">309</FONT>      }<a name="line.309"></a>
<FONT color="green">310</FONT>    <a name="line.310"></a>
<FONT color="green">311</FONT>      /**<a name="line.311"></a>
<FONT color="green">312</FONT>       * see section 4.2.1 of the UIMA References documentation.<a name="line.312"></a>
<FONT color="green">313</FONT>       * <a name="line.313"></a>
<FONT color="green">314</FONT>       * @param view<a name="line.314"></a>
<FONT color="green">315</FONT>       * @param featureStructure<a name="line.315"></a>
<FONT color="green">316</FONT>       * @param feature<a name="line.316"></a>
<FONT color="green">317</FONT>       * @return The feature value.<a name="line.317"></a>
<FONT color="green">318</FONT>       */<a name="line.318"></a>
<FONT color="green">319</FONT>      private static Object getPrimitiveFeatureValue(<a name="line.319"></a>
<FONT color="green">320</FONT>          JCas view,<a name="line.320"></a>
<FONT color="green">321</FONT>          FeatureStructure featureStructure,<a name="line.321"></a>
<FONT color="green">322</FONT>          Feature feature) throws CleartkExtractorException {<a name="line.322"></a>
<FONT color="green">323</FONT>        TypeSystem typeSystem = view.getTypeSystem();<a name="line.323"></a>
<FONT color="green">324</FONT>        Type type = feature.getRange();<a name="line.324"></a>
<FONT color="green">325</FONT>        if (type.equals(typeSystem.getType("uima.cas.Boolean")))<a name="line.325"></a>
<FONT color="green">326</FONT>          return featureStructure.getBooleanValue(feature);<a name="line.326"></a>
<FONT color="green">327</FONT>        else if (type.equals(typeSystem.getType("uima.cas.Double")))<a name="line.327"></a>
<FONT color="green">328</FONT>          return featureStructure.getDoubleValue(feature);<a name="line.328"></a>
<FONT color="green">329</FONT>        else if (type.equals(typeSystem.getType("uima.cas.Float")))<a name="line.329"></a>
<FONT color="green">330</FONT>          return featureStructure.getFloatValue(feature);<a name="line.330"></a>
<FONT color="green">331</FONT>        else if (type.equals(typeSystem.getType("uima.cas.Byte")))<a name="line.331"></a>
<FONT color="green">332</FONT>          return featureStructure.getByteValue(feature);<a name="line.332"></a>
<FONT color="green">333</FONT>        else if (type.equals(typeSystem.getType("uima.cas.Short")))<a name="line.333"></a>
<FONT color="green">334</FONT>          return featureStructure.getShortValue(feature);<a name="line.334"></a>
<FONT color="green">335</FONT>        else if (type.equals(typeSystem.getType("uima.cas.Integer")))<a name="line.335"></a>
<FONT color="green">336</FONT>          return featureStructure.getIntValue(feature);<a name="line.336"></a>
<FONT color="green">337</FONT>        else if (type.equals(typeSystem.getType("uima.cas.Long")))<a name="line.337"></a>
<FONT color="green">338</FONT>          return featureStructure.getLongValue(feature);<a name="line.338"></a>
<FONT color="green">339</FONT>        else if (type.equals(typeSystem.getType("uima.cas.String")))<a name="line.339"></a>
<FONT color="green">340</FONT>          return featureStructure.getStringValue(feature);<a name="line.340"></a>
<FONT color="green">341</FONT>        else<a name="line.341"></a>
<FONT color="green">342</FONT>          throw CleartkExtractorException.notPrimitive(feature);<a name="line.342"></a>
<FONT color="green">343</FONT>      }<a name="line.343"></a>
<FONT color="green">344</FONT>    <a name="line.344"></a>
<FONT color="green">345</FONT>      private static Object[] getPrimitiveArrayFeatureValue(<a name="line.345"></a>
<FONT color="green">346</FONT>          JCas view,<a name="line.346"></a>
<FONT color="green">347</FONT>          FeatureStructure featureStructure,<a name="line.347"></a>
<FONT color="green">348</FONT>          Feature feature) throws CleartkExtractorException {<a name="line.348"></a>
<FONT color="green">349</FONT>        TypeSystem typeSystem = view.getTypeSystem();<a name="line.349"></a>
<FONT color="green">350</FONT>        Type type = feature.getRange();<a name="line.350"></a>
<FONT color="green">351</FONT>        if (type.isArray()) {<a name="line.351"></a>
<FONT color="green">352</FONT>          Type componentType = type.getComponentType();<a name="line.352"></a>
<FONT color="green">353</FONT>          FeatureStructure featureValue = featureStructure.getFeatureValue(feature);<a name="line.353"></a>
<FONT color="green">354</FONT>          if (componentType.equals(typeSystem.getType("uima.cas.String"))) {<a name="line.354"></a>
<FONT color="green">355</FONT>            return ((StringArray) featureValue).toArray();<a name="line.355"></a>
<FONT color="green">356</FONT>          } else if (componentType.equals(typeSystem.getType("uima.cas.Boolean"))) {<a name="line.356"></a>
<FONT color="green">357</FONT>            return Arrays.asList(((BooleanArray) featureValue).toArray()).toArray();<a name="line.357"></a>
<FONT color="green">358</FONT>          } else if (componentType.equals(typeSystem.getType("uima.cas.Double"))) {<a name="line.358"></a>
<FONT color="green">359</FONT>            return Arrays.asList(((DoubleArray) featureValue).toArray()).toArray();<a name="line.359"></a>
<FONT color="green">360</FONT>          } else if (componentType.equals(typeSystem.getType("uima.cas.Float"))) {<a name="line.360"></a>
<FONT color="green">361</FONT>            return Arrays.asList(((FloatArray) featureValue).toArray()).toArray();<a name="line.361"></a>
<FONT color="green">362</FONT>          } else if (componentType.equals(typeSystem.getType("uima.cas.Byte"))) {<a name="line.362"></a>
<FONT color="green">363</FONT>            return Arrays.asList(((ByteArray) featureValue).toArray()).toArray();<a name="line.363"></a>
<FONT color="green">364</FONT>          } else if (componentType.equals(typeSystem.getType("uima.cas.Short"))) {<a name="line.364"></a>
<FONT color="green">365</FONT>            return Arrays.asList(((ShortArray) featureValue).toArray()).toArray();<a name="line.365"></a>
<FONT color="green">366</FONT>          } else if (componentType.equals(typeSystem.getType("uima.cas.Integer"))) {<a name="line.366"></a>
<FONT color="green">367</FONT>            return Arrays.asList(((IntegerArray) featureValue).toArray()).toArray();<a name="line.367"></a>
<FONT color="green">368</FONT>          } else if (componentType.equals(typeSystem.getType("uima.cas.Long"))) {<a name="line.368"></a>
<FONT color="green">369</FONT>            return Arrays.asList(((LongArray) featureValue).toArray()).toArray();<a name="line.369"></a>
<FONT color="green">370</FONT>          }<a name="line.370"></a>
<FONT color="green">371</FONT>        } else<a name="line.371"></a>
<FONT color="green">372</FONT>          throw CleartkExtractorException.notPrimitiveArray(feature);<a name="line.372"></a>
<FONT color="green">373</FONT>        return null;<a name="line.373"></a>
<FONT color="green">374</FONT>      }<a name="line.374"></a>
<FONT color="green">375</FONT>    <a name="line.375"></a>
<FONT color="green">376</FONT>      public boolean isAllPaths() {<a name="line.376"></a>
<FONT color="green">377</FONT>        return allPaths;<a name="line.377"></a>
<FONT color="green">378</FONT>      }<a name="line.378"></a>
<FONT color="green">379</FONT>    <a name="line.379"></a>
<FONT color="green">380</FONT>      public boolean isAllValues() {<a name="line.380"></a>
<FONT color="green">381</FONT>        return allValues;<a name="line.381"></a>
<FONT color="green">382</FONT>      }<a name="line.382"></a>
<FONT color="green">383</FONT>    <a name="line.383"></a>
<FONT color="green">384</FONT>      public Class&lt;? extends Annotation&gt; getFocusClass() {<a name="line.384"></a>
<FONT color="green">385</FONT>        return focusClass;<a name="line.385"></a>
<FONT color="green">386</FONT>      }<a name="line.386"></a>
<FONT color="green">387</FONT>    <a name="line.387"></a>
<FONT color="green">388</FONT>      public String getPath() {<a name="line.388"></a>
<FONT color="green">389</FONT>        return path;<a name="line.389"></a>
<FONT color="green">390</FONT>      }<a name="line.390"></a>
<FONT color="green">391</FONT>    <a name="line.391"></a>
<FONT color="green">392</FONT>      public boolean isUniqueValues() {<a name="line.392"></a>
<FONT color="green">393</FONT>        return uniqueValues;<a name="line.393"></a>
<FONT color="green">394</FONT>      }<a name="line.394"></a>
<FONT color="green">395</FONT>    <a name="line.395"></a>
<FONT color="green">396</FONT>    }<a name="line.396"></a>




























































</PRE>
</BODY>
</HTML>
