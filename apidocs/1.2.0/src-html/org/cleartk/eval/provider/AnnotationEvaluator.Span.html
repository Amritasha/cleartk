<HTML>
<BODY BGCOLOR="white">
<PRE>
<FONT color="green">001</FONT>    /*<a name="line.1"></a>
<FONT color="green">002</FONT>     * Copyright (c) 2011, Regents of the University of Colorado <a name="line.2"></a>
<FONT color="green">003</FONT>     * All rights reserved.<a name="line.3"></a>
<FONT color="green">004</FONT>     * <a name="line.4"></a>
<FONT color="green">005</FONT>     * Redistribution and use in source and binary forms, with or without<a name="line.5"></a>
<FONT color="green">006</FONT>     * modification, are permitted provided that the following conditions are met:<a name="line.6"></a>
<FONT color="green">007</FONT>     * <a name="line.7"></a>
<FONT color="green">008</FONT>     * Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer. <a name="line.8"></a>
<FONT color="green">009</FONT>     * Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution. <a name="line.9"></a>
<FONT color="green">010</FONT>     * Neither the name of the University of Colorado at Boulder nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission. <a name="line.10"></a>
<FONT color="green">011</FONT>     * <a name="line.11"></a>
<FONT color="green">012</FONT>     * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"<a name="line.12"></a>
<FONT color="green">013</FONT>     * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE<a name="line.13"></a>
<FONT color="green">014</FONT>     * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE<a name="line.14"></a>
<FONT color="green">015</FONT>     * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE<a name="line.15"></a>
<FONT color="green">016</FONT>     * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR<a name="line.16"></a>
<FONT color="green">017</FONT>     * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF<a name="line.17"></a>
<FONT color="green">018</FONT>     * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS<a name="line.18"></a>
<FONT color="green">019</FONT>     * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN<a name="line.19"></a>
<FONT color="green">020</FONT>     * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)<a name="line.20"></a>
<FONT color="green">021</FONT>     * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE<a name="line.21"></a>
<FONT color="green">022</FONT>     * POSSIBILITY OF SUCH DAMAGE. <a name="line.22"></a>
<FONT color="green">023</FONT>     */<a name="line.23"></a>
<FONT color="green">024</FONT>    package org.cleartk.eval.provider;<a name="line.24"></a>
<FONT color="green">025</FONT>    <a name="line.25"></a>
<FONT color="green">026</FONT>    import java.util.ArrayList;<a name="line.26"></a>
<FONT color="green">027</FONT>    import java.util.Arrays;<a name="line.27"></a>
<FONT color="green">028</FONT>    import java.util.Collections;<a name="line.28"></a>
<FONT color="green">029</FONT>    import java.util.HashMap;<a name="line.29"></a>
<FONT color="green">030</FONT>    import java.util.HashSet;<a name="line.30"></a>
<FONT color="green">031</FONT>    import java.util.List;<a name="line.31"></a>
<FONT color="green">032</FONT>    import java.util.Map;<a name="line.32"></a>
<FONT color="green">033</FONT>    import java.util.Set;<a name="line.33"></a>
<FONT color="green">034</FONT>    <a name="line.34"></a>
<FONT color="green">035</FONT>    import org.apache.uima.UimaContext;<a name="line.35"></a>
<FONT color="green">036</FONT>    import org.apache.uima.analysis_engine.AnalysisEngineDescription;<a name="line.36"></a>
<FONT color="green">037</FONT>    import org.apache.uima.analysis_engine.AnalysisEngineProcessException;<a name="line.37"></a>
<FONT color="green">038</FONT>    import org.apache.uima.cas.CASException;<a name="line.38"></a>
<FONT color="green">039</FONT>    import org.apache.uima.cas.Feature;<a name="line.39"></a>
<FONT color="green">040</FONT>    import org.apache.uima.jcas.JCas;<a name="line.40"></a>
<FONT color="green">041</FONT>    import org.apache.uima.jcas.tcas.Annotation;<a name="line.41"></a>
<FONT color="green">042</FONT>    import org.apache.uima.resource.ResourceInitializationException;<a name="line.42"></a>
<FONT color="green">043</FONT>    import org.apache.uima.util.Level;<a name="line.43"></a>
<FONT color="green">044</FONT>    import org.apache.uima.util.Logger;<a name="line.44"></a>
<FONT color="green">045</FONT>    import org.cleartk.eval.AnnotationStatistics;<a name="line.45"></a>
<FONT color="green">046</FONT>    import org.cleartk.eval.Evaluation_ImplBase;<a name="line.46"></a>
<FONT color="green">047</FONT>    import org.cleartk.util.ViewURIUtil;<a name="line.47"></a>
<FONT color="green">048</FONT>    import org.uimafit.component.JCasAnnotator_ImplBase;<a name="line.48"></a>
<FONT color="green">049</FONT>    import org.uimafit.descriptor.ConfigurationParameter;<a name="line.49"></a>
<FONT color="green">050</FONT>    import org.uimafit.factory.AnalysisEngineFactory;<a name="line.50"></a>
<FONT color="green">051</FONT>    import org.uimafit.factory.ConfigurationParameterFactory;<a name="line.51"></a>
<FONT color="green">052</FONT>    import org.uimafit.factory.initializable.InitializableFactory;<a name="line.52"></a>
<FONT color="green">053</FONT>    import org.uimafit.util.JCasUtil;<a name="line.53"></a>
<FONT color="green">054</FONT>    <a name="line.54"></a>
<FONT color="green">055</FONT>    /**<a name="line.55"></a>
<FONT color="green">056</FONT>     * An annotator that compares the annotations in a gold (human-annotated) view to the annotations in<a name="line.56"></a>
<FONT color="green">057</FONT>     * a system-annotated view. It can be used either to compare annotation spans (e.g. for a task like<a name="line.57"></a>
<FONT color="green">058</FONT>     * named entity recognition) or to compare annotation attributes (e.g. for a task like document<a name="line.58"></a>
<FONT color="green">059</FONT>     * classification).<a name="line.59"></a>
<FONT color="green">060</FONT>     * <a name="line.60"></a>
<FONT color="green">061</FONT>     * Evaluation statistics (e.g. precision, recall, F1) for each batch as defined by<a name="line.61"></a>
<FONT color="green">062</FONT>     * {@link #batchProcessComplete()} and for the overall collection as defined by<a name="line.62"></a>
<FONT color="green">063</FONT>     * {@link #collectionProcessComplete()} will be logged at {@link Level#WARNING}. Additionally,<a name="line.63"></a>
<FONT color="green">064</FONT>     * information about each system error will be logged at {@link Level#INFO}.<a name="line.64"></a>
<FONT color="green">065</FONT>     * <a name="line.65"></a>
<FONT color="green">066</FONT>     * (Though it might have been preferable to log the main evaluation statistics at {@link Level#INFO}<a name="line.66"></a>
<FONT color="green">067</FONT>     * and the fine-grained error information at {@link Level#FINE}, this is not practical because UIMA<a name="line.67"></a>
<FONT color="green">068</FONT>     * already logs lots of useless method begin/end messages at {@link Level#FINE}.)<a name="line.68"></a>
<FONT color="green">069</FONT>     * <a name="line.69"></a>
<FONT color="green">070</FONT>     * &lt;br&gt;<a name="line.70"></a>
<FONT color="green">071</FONT>     * Copyright (c) 2011, Regents of the University of Colorado &lt;br&gt;<a name="line.71"></a>
<FONT color="green">072</FONT>     * All rights reserved.<a name="line.72"></a>
<FONT color="green">073</FONT>     * <a name="line.73"></a>
<FONT color="green">074</FONT>     * @author Steven Bethard<a name="line.74"></a>
<FONT color="green">075</FONT>     * @deprecated Use {@link Evaluation_ImplBase} with {@link AnnotationStatistics}<a name="line.75"></a>
<FONT color="green">076</FONT>     */<a name="line.76"></a>
<FONT color="green">077</FONT>    @Deprecated<a name="line.77"></a>
<FONT color="green">078</FONT>    public class AnnotationEvaluator&lt;T extends Comparable&lt;? super T&gt;&gt; extends JCasAnnotator_ImplBase {<a name="line.78"></a>
<FONT color="green">079</FONT>    <a name="line.79"></a>
<FONT color="green">080</FONT>      public static interface SpanExtractor&lt;T extends Comparable&lt;? super T&gt;&gt; {<a name="line.80"></a>
<FONT color="green">081</FONT>        public T getSpan(Annotation annotation);<a name="line.81"></a>
<FONT color="green">082</FONT>      }<a name="line.82"></a>
<FONT color="green">083</FONT>    <a name="line.83"></a>
<FONT color="green">084</FONT>      public static class AnnotationSpanExtractor implements SpanExtractor&lt;AnnotationSpan&gt; {<a name="line.84"></a>
<FONT color="green">085</FONT>        @Override<a name="line.85"></a>
<FONT color="green">086</FONT>        public AnnotationSpan getSpan(Annotation annotation) {<a name="line.86"></a>
<FONT color="green">087</FONT>          return new AnnotationSpan(annotation);<a name="line.87"></a>
<FONT color="green">088</FONT>        }<a name="line.88"></a>
<FONT color="green">089</FONT>      }<a name="line.89"></a>
<FONT color="green">090</FONT>    <a name="line.90"></a>
<FONT color="green">091</FONT>      public static interface AnnotationGrouper {<a name="line.91"></a>
<FONT color="green">092</FONT>        public List&lt;String&gt; getGroups(Annotation annotation);<a name="line.92"></a>
<FONT color="green">093</FONT>      }<a name="line.93"></a>
<FONT color="green">094</FONT>    <a name="line.94"></a>
<FONT color="green">095</FONT>      public static class SingleGroupAnnotationGrouper implements AnnotationGrouper {<a name="line.95"></a>
<FONT color="green">096</FONT>        @Override<a name="line.96"></a>
<FONT color="green">097</FONT>        public List&lt;String&gt; getGroups(Annotation annotation) {<a name="line.97"></a>
<FONT color="green">098</FONT>          return Arrays.asList("");<a name="line.98"></a>
<FONT color="green">099</FONT>        }<a name="line.99"></a>
<FONT color="green">100</FONT>      }<a name="line.100"></a>
<FONT color="green">101</FONT>    <a name="line.101"></a>
<FONT color="green">102</FONT>      public static AnalysisEngineDescription getSpanDescription(<a name="line.102"></a>
<FONT color="green">103</FONT>          Class&lt;? extends Annotation&gt; annotationClass,<a name="line.103"></a>
<FONT color="green">104</FONT>          String goldView,<a name="line.104"></a>
<FONT color="green">105</FONT>          String systemView) throws ResourceInitializationException {<a name="line.105"></a>
<FONT color="green">106</FONT>        return AnalysisEngineFactory.createPrimitiveDescription(<a name="line.106"></a>
<FONT color="green">107</FONT>            AnnotationEvaluator.class,<a name="line.107"></a>
<FONT color="green">108</FONT>            PARAM_ANNOTATION_CLASS_NAME,<a name="line.108"></a>
<FONT color="green">109</FONT>            annotationClass.getName(),<a name="line.109"></a>
<FONT color="green">110</FONT>            PARAM_GOLD_VIEW_NAME,<a name="line.110"></a>
<FONT color="green">111</FONT>            goldView,<a name="line.111"></a>
<FONT color="green">112</FONT>            PARAM_SYSTEM_VIEW_NAME,<a name="line.112"></a>
<FONT color="green">113</FONT>            systemView);<a name="line.113"></a>
<FONT color="green">114</FONT>      }<a name="line.114"></a>
<FONT color="green">115</FONT>    <a name="line.115"></a>
<FONT color="green">116</FONT>      public static AnalysisEngineDescription getAttributeDescription(<a name="line.116"></a>
<FONT color="green">117</FONT>          Class&lt;? extends Annotation&gt; annotationClass,<a name="line.117"></a>
<FONT color="green">118</FONT>          String annotationAttributeName,<a name="line.118"></a>
<FONT color="green">119</FONT>          String goldView,<a name="line.119"></a>
<FONT color="green">120</FONT>          String systemView) throws ResourceInitializationException {<a name="line.120"></a>
<FONT color="green">121</FONT>        return AnalysisEngineFactory.createPrimitiveDescription(<a name="line.121"></a>
<FONT color="green">122</FONT>            AnnotationEvaluator.class,<a name="line.122"></a>
<FONT color="green">123</FONT>            PARAM_ANNOTATION_CLASS_NAME,<a name="line.123"></a>
<FONT color="green">124</FONT>            annotationClass.getName(),<a name="line.124"></a>
<FONT color="green">125</FONT>            PARAM_ANNOTATION_ATTRIBUTE_NAME,<a name="line.125"></a>
<FONT color="green">126</FONT>            annotationAttributeName,<a name="line.126"></a>
<FONT color="green">127</FONT>            PARAM_GOLD_VIEW_NAME,<a name="line.127"></a>
<FONT color="green">128</FONT>            goldView,<a name="line.128"></a>
<FONT color="green">129</FONT>            PARAM_SYSTEM_VIEW_NAME,<a name="line.129"></a>
<FONT color="green">130</FONT>            systemView);<a name="line.130"></a>
<FONT color="green">131</FONT>      }<a name="line.131"></a>
<FONT color="green">132</FONT>    <a name="line.132"></a>
<FONT color="green">133</FONT>      @ConfigurationParameter(<a name="line.133"></a>
<FONT color="green">134</FONT>          mandatory = true,<a name="line.134"></a>
<FONT color="green">135</FONT>          description = "The annotation class whose gold and system spans should be compared")<a name="line.135"></a>
<FONT color="green">136</FONT>      private String annotationClassName;<a name="line.136"></a>
<FONT color="green">137</FONT>    <a name="line.137"></a>
<FONT color="green">138</FONT>      @ConfigurationParameter(<a name="line.138"></a>
<FONT color="green">139</FONT>          description = "The attribute whose gold and system values should be compared (if null, only "<a name="line.139"></a>
<FONT color="green">140</FONT>              + "the annotation spans will be compared)")<a name="line.140"></a>
<FONT color="green">141</FONT>      private String annotationAttributeName;<a name="line.141"></a>
<FONT color="green">142</FONT>    <a name="line.142"></a>
<FONT color="green">143</FONT>      @ConfigurationParameter(<a name="line.143"></a>
<FONT color="green">144</FONT>          defaultValue = "org.cleartk.eval.provider.AnnotationEvaluator$AnnotationSpanExtractor",<a name="line.144"></a>
<FONT color="green">145</FONT>          description = "The name of the class that extracts the span of an annotation. Defaults to "<a name="line.145"></a>
<FONT color="green">146</FONT>              + "an extractor that looks at the annotation begin and end offsets.")<a name="line.146"></a>
<FONT color="green">147</FONT>      private String spanExtractorClassName;<a name="line.147"></a>
<FONT color="green">148</FONT>    <a name="line.148"></a>
<FONT color="green">149</FONT>      @ConfigurationParameter(<a name="line.149"></a>
<FONT color="green">150</FONT>          defaultValue = "org.cleartk.eval.provider.AnnotationEvaluator$SingleGroupAnnotationGrouper",<a name="line.150"></a>
<FONT color="green">151</FONT>          description = "The name of a subclass of AnnotationGrouper that assigns a group to each "<a name="line.151"></a>
<FONT color="green">152</FONT>              + "annotation. This is useful for, e.g. reporting results split by part of speech.")<a name="line.152"></a>
<FONT color="green">153</FONT>      private String annotationGrouperClassName;<a name="line.153"></a>
<FONT color="green">154</FONT>    <a name="line.154"></a>
<FONT color="green">155</FONT>      @ConfigurationParameter(<a name="line.155"></a>
<FONT color="green">156</FONT>          mandatory = true,<a name="line.156"></a>
<FONT color="green">157</FONT>          description = "The name of the CAS view containing the gold (manual) annotations")<a name="line.157"></a>
<FONT color="green">158</FONT>      private String goldViewName;<a name="line.158"></a>
<FONT color="green">159</FONT>    <a name="line.159"></a>
<FONT color="green">160</FONT>      @ConfigurationParameter(<a name="line.160"></a>
<FONT color="green">161</FONT>          mandatory = true,<a name="line.161"></a>
<FONT color="green">162</FONT>          description = "The name of the CAS view containing the system (automatic) annotations")<a name="line.162"></a>
<FONT color="green">163</FONT>      private String systemViewName;<a name="line.163"></a>
<FONT color="green">164</FONT>    <a name="line.164"></a>
<FONT color="green">165</FONT>      @ConfigurationParameter(<a name="line.165"></a>
<FONT color="green">166</FONT>          defaultValue = "false",<a name="line.166"></a>
<FONT color="green">167</FONT>          description = "Ignore additional spans produced by the system that do not match any of the "<a name="line.167"></a>
<FONT color="green">168</FONT>              + "gold spans. This can be useful when doing an attribute classification task where "<a name="line.168"></a>
<FONT color="green">169</FONT>              + "gold standard data is only available for a subset of all possible classifications.")<a name="line.169"></a>
<FONT color="green">170</FONT>      private boolean ignoreSystemSpansNotInGold;<a name="line.170"></a>
<FONT color="green">171</FONT>    <a name="line.171"></a>
<FONT color="green">172</FONT>      public static final String PARAM_ANNOTATION_CLASS_NAME = ConfigurationParameterFactory.createConfigurationParameterName(<a name="line.172"></a>
<FONT color="green">173</FONT>          AnnotationEvaluator.class,<a name="line.173"></a>
<FONT color="green">174</FONT>          "annotationClassName");<a name="line.174"></a>
<FONT color="green">175</FONT>    <a name="line.175"></a>
<FONT color="green">176</FONT>      public static final String PARAM_ANNOTATION_ATTRIBUTE_NAME = ConfigurationParameterFactory.createConfigurationParameterName(<a name="line.176"></a>
<FONT color="green">177</FONT>          AnnotationEvaluator.class,<a name="line.177"></a>
<FONT color="green">178</FONT>          "annotationAttributeName");<a name="line.178"></a>
<FONT color="green">179</FONT>    <a name="line.179"></a>
<FONT color="green">180</FONT>      public static final String PARAM_SPAN_EXTRACTOR_CLASS_NAME = ConfigurationParameterFactory.createConfigurationParameterName(<a name="line.180"></a>
<FONT color="green">181</FONT>          AnnotationEvaluator.class,<a name="line.181"></a>
<FONT color="green">182</FONT>          "spanExtractorClassName");<a name="line.182"></a>
<FONT color="green">183</FONT>    <a name="line.183"></a>
<FONT color="green">184</FONT>      public static final String PARAM_ANNOTATION_GROUPER_CLASS_NAME = ConfigurationParameterFactory.createConfigurationParameterName(<a name="line.184"></a>
<FONT color="green">185</FONT>          AnnotationEvaluator.class,<a name="line.185"></a>
<FONT color="green">186</FONT>          "annotationGrouperClassName");<a name="line.186"></a>
<FONT color="green">187</FONT>    <a name="line.187"></a>
<FONT color="green">188</FONT>      public static final String PARAM_GOLD_VIEW_NAME = ConfigurationParameterFactory.createConfigurationParameterName(<a name="line.188"></a>
<FONT color="green">189</FONT>          AnnotationEvaluator.class,<a name="line.189"></a>
<FONT color="green">190</FONT>          "goldViewName");<a name="line.190"></a>
<FONT color="green">191</FONT>    <a name="line.191"></a>
<FONT color="green">192</FONT>      public static final String PARAM_SYSTEM_VIEW_NAME = ConfigurationParameterFactory.createConfigurationParameterName(<a name="line.192"></a>
<FONT color="green">193</FONT>          AnnotationEvaluator.class,<a name="line.193"></a>
<FONT color="green">194</FONT>          "systemViewName");<a name="line.194"></a>
<FONT color="green">195</FONT>    <a name="line.195"></a>
<FONT color="green">196</FONT>      public static final String PARAM_IGNORE_SYSTEM_SPANS_NOT_IN_GOLD = ConfigurationParameterFactory.createConfigurationParameterName(<a name="line.196"></a>
<FONT color="green">197</FONT>          AnnotationEvaluator.class,<a name="line.197"></a>
<FONT color="green">198</FONT>          "ignoreSystemSpansNotInGold");<a name="line.198"></a>
<FONT color="green">199</FONT>    <a name="line.199"></a>
<FONT color="green">200</FONT>      private Class&lt;? extends Annotation&gt; annotationClass;<a name="line.200"></a>
<FONT color="green">201</FONT>    <a name="line.201"></a>
<FONT color="green">202</FONT>      private SpanExtractor&lt;T&gt; spanExtractor;<a name="line.202"></a>
<FONT color="green">203</FONT>    <a name="line.203"></a>
<FONT color="green">204</FONT>      private AnnotationGrouper grouper;<a name="line.204"></a>
<FONT color="green">205</FONT>    <a name="line.205"></a>
<FONT color="green">206</FONT>      private int batch;<a name="line.206"></a>
<FONT color="green">207</FONT>    <a name="line.207"></a>
<FONT color="green">208</FONT>      private Map&lt;String, Stats&gt; collectionGroupStats;<a name="line.208"></a>
<FONT color="green">209</FONT>    <a name="line.209"></a>
<FONT color="green">210</FONT>      private Map&lt;String, Stats&gt; batchGroupStats;<a name="line.210"></a>
<FONT color="green">211</FONT>    <a name="line.211"></a>
<FONT color="green">212</FONT>      private Logger logger;<a name="line.212"></a>
<FONT color="green">213</FONT>    <a name="line.213"></a>
<FONT color="green">214</FONT>      @Override<a name="line.214"></a>
<FONT color="green">215</FONT>      @SuppressWarnings("unchecked")<a name="line.215"></a>
<FONT color="green">216</FONT>      public void initialize(UimaContext context) throws ResourceInitializationException {<a name="line.216"></a>
<FONT color="green">217</FONT>        super.initialize(context);<a name="line.217"></a>
<FONT color="green">218</FONT>        this.logger = context.getLogger();<a name="line.218"></a>
<FONT color="green">219</FONT>        this.annotationClass = InitializableFactory.getClass(this.annotationClassName, Annotation.class);<a name="line.219"></a>
<FONT color="green">220</FONT>        this.spanExtractor = InitializableFactory.create(<a name="line.220"></a>
<FONT color="green">221</FONT>            context,<a name="line.221"></a>
<FONT color="green">222</FONT>            this.spanExtractorClassName,<a name="line.222"></a>
<FONT color="green">223</FONT>            SpanExtractor.class);<a name="line.223"></a>
<FONT color="green">224</FONT>        this.grouper = InitializableFactory.create(<a name="line.224"></a>
<FONT color="green">225</FONT>            context,<a name="line.225"></a>
<FONT color="green">226</FONT>            this.annotationGrouperClassName,<a name="line.226"></a>
<FONT color="green">227</FONT>            AnnotationGrouper.class);<a name="line.227"></a>
<FONT color="green">228</FONT>        this.collectionGroupStats = new HashMap&lt;String, Stats&gt;();<a name="line.228"></a>
<FONT color="green">229</FONT>        this.batchGroupStats = new HashMap&lt;String, Stats&gt;();<a name="line.229"></a>
<FONT color="green">230</FONT>        this.batch = 0;<a name="line.230"></a>
<FONT color="green">231</FONT>      }<a name="line.231"></a>
<FONT color="green">232</FONT>    <a name="line.232"></a>
<FONT color="green">233</FONT>      @Override<a name="line.233"></a>
<FONT color="green">234</FONT>      public void process(JCas jCas) throws AnalysisEngineProcessException {<a name="line.234"></a>
<FONT color="green">235</FONT>        JCas goldView, systemView;<a name="line.235"></a>
<FONT color="green">236</FONT>        try {<a name="line.236"></a>
<FONT color="green">237</FONT>          goldView = jCas.getView(this.goldViewName);<a name="line.237"></a>
<FONT color="green">238</FONT>          systemView = jCas.getView(this.systemViewName);<a name="line.238"></a>
<FONT color="green">239</FONT>        } catch (CASException e) {<a name="line.239"></a>
<FONT color="green">240</FONT>          throw new AnalysisEngineProcessException(e);<a name="line.240"></a>
<FONT color="green">241</FONT>        }<a name="line.241"></a>
<FONT color="green">242</FONT>    <a name="line.242"></a>
<FONT color="green">243</FONT>        // convert the annotations in the CAS views to group-&gt;span-&gt;tag maps<a name="line.243"></a>
<FONT color="green">244</FONT>        Map&lt;String, Map&lt;T, String&gt;&gt; goldGroupedSpanTags = this.getGroupedSpanTags(goldView);<a name="line.244"></a>
<FONT color="green">245</FONT>        Map&lt;String, Map&lt;T, String&gt;&gt; systemGroupedSpanTags = this.getGroupedSpanTags(systemView);<a name="line.245"></a>
<FONT color="green">246</FONT>    <a name="line.246"></a>
<FONT color="green">247</FONT>        // determine the groups, and make sure gold and system have all the same groups<a name="line.247"></a>
<FONT color="green">248</FONT>        Set&lt;String&gt; groups = new HashSet&lt;String&gt;();<a name="line.248"></a>
<FONT color="green">249</FONT>        groups.addAll(goldGroupedSpanTags.keySet());<a name="line.249"></a>
<FONT color="green">250</FONT>        groups.addAll(systemGroupedSpanTags.keySet());<a name="line.250"></a>
<FONT color="green">251</FONT>        for (String group : groups) {<a name="line.251"></a>
<FONT color="green">252</FONT>          if (!goldGroupedSpanTags.containsKey(group)) {<a name="line.252"></a>
<FONT color="green">253</FONT>            goldGroupedSpanTags.put(group, new HashMap&lt;T, String&gt;());<a name="line.253"></a>
<FONT color="green">254</FONT>          }<a name="line.254"></a>
<FONT color="green">255</FONT>          if (!systemGroupedSpanTags.containsKey(group)) {<a name="line.255"></a>
<FONT color="green">256</FONT>            systemGroupedSpanTags.put(group, new HashMap&lt;T, String&gt;());<a name="line.256"></a>
<FONT color="green">257</FONT>          }<a name="line.257"></a>
<FONT color="green">258</FONT>        }<a name="line.258"></a>
<FONT color="green">259</FONT>    <a name="line.259"></a>
<FONT color="green">260</FONT>        for (String group : groups) {<a name="line.260"></a>
<FONT color="green">261</FONT>          Map&lt;T, String&gt; goldSpanTags = goldGroupedSpanTags.get(group);<a name="line.261"></a>
<FONT color="green">262</FONT>          Map&lt;T, String&gt; systemSpanTags = systemGroupedSpanTags.get(group);<a name="line.262"></a>
<FONT color="green">263</FONT>    <a name="line.263"></a>
<FONT color="green">264</FONT>          // remove some system spans if requested<a name="line.264"></a>
<FONT color="green">265</FONT>          if (this.ignoreSystemSpansNotInGold) {<a name="line.265"></a>
<FONT color="green">266</FONT>            for (T span : new HashSet&lt;T&gt;(systemSpanTags.keySet())) {<a name="line.266"></a>
<FONT color="green">267</FONT>              if (!goldSpanTags.containsKey(span)) {<a name="line.267"></a>
<FONT color="green">268</FONT>                systemSpanTags.remove(span);<a name="line.268"></a>
<FONT color="green">269</FONT>              }<a name="line.269"></a>
<FONT color="green">270</FONT>            }<a name="line.270"></a>
<FONT color="green">271</FONT>          }<a name="line.271"></a>
<FONT color="green">272</FONT>    <a name="line.272"></a>
<FONT color="green">273</FONT>          // find the span+tags that were labeled correctly<a name="line.273"></a>
<FONT color="green">274</FONT>          Set&lt;T&gt; matchingSpans = new HashSet&lt;T&gt;();<a name="line.274"></a>
<FONT color="green">275</FONT>          matchingSpans.addAll(goldSpanTags.keySet());<a name="line.275"></a>
<FONT color="green">276</FONT>          matchingSpans.retainAll(systemSpanTags.keySet());<a name="line.276"></a>
<FONT color="green">277</FONT>          Map&lt;T, String&gt; matchingSpanTags = new HashMap&lt;T, String&gt;();<a name="line.277"></a>
<FONT color="green">278</FONT>          for (T span : matchingSpans) {<a name="line.278"></a>
<FONT color="green">279</FONT>            if (this.annotationAttributeName == null) {<a name="line.279"></a>
<FONT color="green">280</FONT>              matchingSpanTags.put(span, null);<a name="line.280"></a>
<FONT color="green">281</FONT>            } else {<a name="line.281"></a>
<FONT color="green">282</FONT>              String goldTag = goldSpanTags.get(span);<a name="line.282"></a>
<FONT color="green">283</FONT>              String systemTag = systemSpanTags.get(span);<a name="line.283"></a>
<FONT color="green">284</FONT>              if (goldTag.equals(systemTag)) {<a name="line.284"></a>
<FONT color="green">285</FONT>                matchingSpanTags.put(span, goldTag);<a name="line.285"></a>
<FONT color="green">286</FONT>              }<a name="line.286"></a>
<FONT color="green">287</FONT>            }<a name="line.287"></a>
<FONT color="green">288</FONT>          }<a name="line.288"></a>
<FONT color="green">289</FONT>    <a name="line.289"></a>
<FONT color="green">290</FONT>          // update collection-level counts<a name="line.290"></a>
<FONT color="green">291</FONT>          int gold = goldSpanTags.size();<a name="line.291"></a>
<FONT color="green">292</FONT>          int system = systemSpanTags.size();<a name="line.292"></a>
<FONT color="green">293</FONT>          int matching = matchingSpanTags.size();<a name="line.293"></a>
<FONT color="green">294</FONT>          if (!this.collectionGroupStats.containsKey(group)) {<a name="line.294"></a>
<FONT color="green">295</FONT>            this.collectionGroupStats.put(group, new Stats());<a name="line.295"></a>
<FONT color="green">296</FONT>          }<a name="line.296"></a>
<FONT color="green">297</FONT>          Stats collectionStats = this.collectionGroupStats.get(group);<a name="line.297"></a>
<FONT color="green">298</FONT>          collectionStats.gold += gold;<a name="line.298"></a>
<FONT color="green">299</FONT>          collectionStats.system += system;<a name="line.299"></a>
<FONT color="green">300</FONT>          collectionStats.matching += matching;<a name="line.300"></a>
<FONT color="green">301</FONT>    <a name="line.301"></a>
<FONT color="green">302</FONT>          // update batch-level counts<a name="line.302"></a>
<FONT color="green">303</FONT>          if (!this.batchGroupStats.containsKey(group)) {<a name="line.303"></a>
<FONT color="green">304</FONT>            this.batchGroupStats.put(group, new Stats());<a name="line.304"></a>
<FONT color="green">305</FONT>          }<a name="line.305"></a>
<FONT color="green">306</FONT>          Stats batchStats = this.batchGroupStats.get(group);<a name="line.306"></a>
<FONT color="green">307</FONT>          batchStats.gold += gold;<a name="line.307"></a>
<FONT color="green">308</FONT>          batchStats.system += system;<a name="line.308"></a>
<FONT color="green">309</FONT>          batchStats.matching += matching;<a name="line.309"></a>
<FONT color="green">310</FONT>    <a name="line.310"></a>
<FONT color="green">311</FONT>          // print out the errors<a name="line.311"></a>
<FONT color="green">312</FONT>          Set&lt;T&gt; spans = new HashSet&lt;T&gt;();<a name="line.312"></a>
<FONT color="green">313</FONT>          spans.addAll(goldSpanTags.keySet());<a name="line.313"></a>
<FONT color="green">314</FONT>          spans.addAll(systemSpanTags.keySet());<a name="line.314"></a>
<FONT color="green">315</FONT>          if (!spans.equals(matchingSpanTags.keySet())) {<a name="line.315"></a>
<FONT color="green">316</FONT>            StringBuilder message = new StringBuilder();<a name="line.316"></a>
<FONT color="green">317</FONT>            message.append(ViewURIUtil.getURI(jCas)).append('\n');<a name="line.317"></a>
<FONT color="green">318</FONT>            List&lt;T&gt; spansList = new ArrayList&lt;T&gt;(spans);<a name="line.318"></a>
<FONT color="green">319</FONT>            Collections.sort(spansList);<a name="line.319"></a>
<FONT color="green">320</FONT>            for (T span : spansList) {<a name="line.320"></a>
<FONT color="green">321</FONT>              String goldTag = goldSpanTags.get(span);<a name="line.321"></a>
<FONT color="green">322</FONT>              String systemTag = systemSpanTags.get(span);<a name="line.322"></a>
<FONT color="green">323</FONT>              if (!matchingSpanTags.containsKey(span)) {<a name="line.323"></a>
<FONT color="green">324</FONT>                boolean isGold = goldSpanTags.containsKey(span);<a name="line.324"></a>
<FONT color="green">325</FONT>                boolean isSystem = systemSpanTags.containsKey(span);<a name="line.325"></a>
<FONT color="green">326</FONT>                if (isGold &amp;&amp; isSystem) {<a name="line.326"></a>
<FONT color="green">327</FONT>                  message.append(String.format(<a name="line.327"></a>
<FONT color="green">328</FONT>                      "WRONG: system=%s gold=%s %s\n",<a name="line.328"></a>
<FONT color="green">329</FONT>                      systemTag,<a name="line.329"></a>
<FONT color="green">330</FONT>                      goldTag,<a name="line.330"></a>
<FONT color="green">331</FONT>                      span));<a name="line.331"></a>
<FONT color="green">332</FONT>                } else if (isGold) {<a name="line.332"></a>
<FONT color="green">333</FONT>                  String attr = goldTag == null ? "" : String.format("gold=%s ", goldTag);<a name="line.333"></a>
<FONT color="green">334</FONT>                  message.append(String.format("DROPPED: %s%s\n", attr, span));<a name="line.334"></a>
<FONT color="green">335</FONT>                } else if (isSystem) {<a name="line.335"></a>
<FONT color="green">336</FONT>                  if (!this.ignoreSystemSpansNotInGold) {<a name="line.336"></a>
<FONT color="green">337</FONT>                    String attr = systemTag == null ? "" : String.format("system=%s ", systemTag);<a name="line.337"></a>
<FONT color="green">338</FONT>                    message.append(String.format("ADDED: %s%s\n", attr, span));<a name="line.338"></a>
<FONT color="green">339</FONT>                  }<a name="line.339"></a>
<FONT color="green">340</FONT>                }<a name="line.340"></a>
<FONT color="green">341</FONT>              }<a name="line.341"></a>
<FONT color="green">342</FONT>            }<a name="line.342"></a>
<FONT color="green">343</FONT>            this.logger.log(Level.INFO, message.toString().trim());<a name="line.343"></a>
<FONT color="green">344</FONT>          }<a name="line.344"></a>
<FONT color="green">345</FONT>        }<a name="line.345"></a>
<FONT color="green">346</FONT>      }<a name="line.346"></a>
<FONT color="green">347</FONT>    <a name="line.347"></a>
<FONT color="green">348</FONT>      @Override<a name="line.348"></a>
<FONT color="green">349</FONT>      public void collectionProcessComplete() throws AnalysisEngineProcessException {<a name="line.349"></a>
<FONT color="green">350</FONT>        super.collectionProcessComplete();<a name="line.350"></a>
<FONT color="green">351</FONT>        for (String group : this.getGroups(this.collectionGroupStats)) {<a name="line.351"></a>
<FONT color="green">352</FONT>          Stats collectionStats = this.collectionGroupStats.get(group);<a name="line.352"></a>
<FONT color="green">353</FONT>          this.logStats("Collection " + group, collectionStats);<a name="line.353"></a>
<FONT color="green">354</FONT>          this.collectionGroupStats.put(group, new Stats());<a name="line.354"></a>
<FONT color="green">355</FONT>        }<a name="line.355"></a>
<FONT color="green">356</FONT>      }<a name="line.356"></a>
<FONT color="green">357</FONT>    <a name="line.357"></a>
<FONT color="green">358</FONT>      @Override<a name="line.358"></a>
<FONT color="green">359</FONT>      public void batchProcessComplete() throws AnalysisEngineProcessException {<a name="line.359"></a>
<FONT color="green">360</FONT>        super.batchProcessComplete();<a name="line.360"></a>
<FONT color="green">361</FONT>        for (String group : this.getGroups(this.batchGroupStats)) {<a name="line.361"></a>
<FONT color="green">362</FONT>          Stats collectionStats = this.batchGroupStats.get(group);<a name="line.362"></a>
<FONT color="green">363</FONT>          this.logStats("Batch " + this.batch + " " + group, collectionStats);<a name="line.363"></a>
<FONT color="green">364</FONT>          this.batchGroupStats.put(group, new Stats());<a name="line.364"></a>
<FONT color="green">365</FONT>        }<a name="line.365"></a>
<FONT color="green">366</FONT>        this.batch += 1;<a name="line.366"></a>
<FONT color="green">367</FONT>      }<a name="line.367"></a>
<FONT color="green">368</FONT>    <a name="line.368"></a>
<FONT color="green">369</FONT>      private List&lt;String&gt; getGroups(Map&lt;String, Stats&gt; groupStats) {<a name="line.369"></a>
<FONT color="green">370</FONT>        List&lt;String&gt; groups = new ArrayList&lt;String&gt;(groupStats.keySet());<a name="line.370"></a>
<FONT color="green">371</FONT>        Collections.sort(groups);<a name="line.371"></a>
<FONT color="green">372</FONT>        return groups;<a name="line.372"></a>
<FONT color="green">373</FONT>      }<a name="line.373"></a>
<FONT color="green">374</FONT>    <a name="line.374"></a>
<FONT color="green">375</FONT>      private void logStats(String heading, Stats stats) {<a name="line.375"></a>
<FONT color="green">376</FONT>        String annotationName = this.annotationClass.getSimpleName();<a name="line.376"></a>
<FONT color="green">377</FONT>        String name;<a name="line.377"></a>
<FONT color="green">378</FONT>        if (this.annotationAttributeName != null) {<a name="line.378"></a>
<FONT color="green">379</FONT>          name = String.format("%s:%s", annotationName, this.annotationAttributeName);<a name="line.379"></a>
<FONT color="green">380</FONT>        } else {<a name="line.380"></a>
<FONT color="green">381</FONT>          name = annotationName;<a name="line.381"></a>
<FONT color="green">382</FONT>        }<a name="line.382"></a>
<FONT color="green">383</FONT>        // @formatter:off<a name="line.383"></a>
<FONT color="green">384</FONT>        String message = String.format(<a name="line.384"></a>
<FONT color="green">385</FONT>            "%s %s\n" +<a name="line.385"></a>
<FONT color="green">386</FONT>            "gold      = %d\n" +<a name="line.386"></a>
<FONT color="green">387</FONT>            "system    = %d\n" +<a name="line.387"></a>
<FONT color="green">388</FONT>            "matching  = %d\n" + <a name="line.388"></a>
<FONT color="green">389</FONT>            "precision = %.3f\n" +<a name="line.389"></a>
<FONT color="green">390</FONT>            "recall    = %.3f\n" +<a name="line.390"></a>
<FONT color="green">391</FONT>            "f1        = %.3f",<a name="line.391"></a>
<FONT color="green">392</FONT>            name, heading,<a name="line.392"></a>
<FONT color="green">393</FONT>            stats.gold, stats.system, stats.matching,<a name="line.393"></a>
<FONT color="green">394</FONT>            stats.precision(), stats.recall(), stats.f1());<a name="line.394"></a>
<FONT color="green">395</FONT>        // @formatter:on<a name="line.395"></a>
<FONT color="green">396</FONT>        this.logger.log(Level.WARNING, message);<a name="line.396"></a>
<FONT color="green">397</FONT>      }<a name="line.397"></a>
<FONT color="green">398</FONT>    <a name="line.398"></a>
<FONT color="green">399</FONT>      private Map&lt;String, Map&lt;T, String&gt;&gt; getGroupedSpanTags(JCas view) {<a name="line.399"></a>
<FONT color="green">400</FONT>        Map&lt;String, Map&lt;T, String&gt;&gt; groupedSpans = new HashMap&lt;String, Map&lt;T, String&gt;&gt;();<a name="line.400"></a>
<FONT color="green">401</FONT>        for (Annotation ann : JCasUtil.select(view, this.annotationClass)) {<a name="line.401"></a>
<FONT color="green">402</FONT>          List&lt;String&gt; groups = this.grouper.getGroups(ann);<a name="line.402"></a>
<FONT color="green">403</FONT>          for (String group : groups) {<a name="line.403"></a>
<FONT color="green">404</FONT>            if (!groupedSpans.containsKey(group)) {<a name="line.404"></a>
<FONT color="green">405</FONT>              groupedSpans.put(group, new HashMap&lt;T, String&gt;());<a name="line.405"></a>
<FONT color="green">406</FONT>            }<a name="line.406"></a>
<FONT color="green">407</FONT>          }<a name="line.407"></a>
<FONT color="green">408</FONT>          T span = this.spanExtractor.getSpan(ann);<a name="line.408"></a>
<FONT color="green">409</FONT>          if (this.annotationAttributeName == null) {<a name="line.409"></a>
<FONT color="green">410</FONT>            for (String group : groups) {<a name="line.410"></a>
<FONT color="green">411</FONT>              groupedSpans.get(group).put(span, null);<a name="line.411"></a>
<FONT color="green">412</FONT>            }<a name="line.412"></a>
<FONT color="green">413</FONT>          } else {<a name="line.413"></a>
<FONT color="green">414</FONT>            Feature feature = ann.getType().getFeatureByBaseName(this.annotationAttributeName);<a name="line.414"></a>
<FONT color="green">415</FONT>            String featureValue = ann.getFeatureValueAsString(feature);<a name="line.415"></a>
<FONT color="green">416</FONT>            if (featureValue != null) {<a name="line.416"></a>
<FONT color="green">417</FONT>              for (String group : groups) {<a name="line.417"></a>
<FONT color="green">418</FONT>                groupedSpans.get(group).put(span, featureValue);<a name="line.418"></a>
<FONT color="green">419</FONT>              }<a name="line.419"></a>
<FONT color="green">420</FONT>            }<a name="line.420"></a>
<FONT color="green">421</FONT>          }<a name="line.421"></a>
<FONT color="green">422</FONT>        }<a name="line.422"></a>
<FONT color="green">423</FONT>        return groupedSpans;<a name="line.423"></a>
<FONT color="green">424</FONT>      }<a name="line.424"></a>
<FONT color="green">425</FONT>    <a name="line.425"></a>
<FONT color="green">426</FONT>      private static class Stats {<a name="line.426"></a>
<FONT color="green">427</FONT>        public int gold;<a name="line.427"></a>
<FONT color="green">428</FONT>    <a name="line.428"></a>
<FONT color="green">429</FONT>        public int system;<a name="line.429"></a>
<FONT color="green">430</FONT>    <a name="line.430"></a>
<FONT color="green">431</FONT>        public int matching;<a name="line.431"></a>
<FONT color="green">432</FONT>    <a name="line.432"></a>
<FONT color="green">433</FONT>        public Stats() {<a name="line.433"></a>
<FONT color="green">434</FONT>          this.gold = 0;<a name="line.434"></a>
<FONT color="green">435</FONT>          this.system = 0;<a name="line.435"></a>
<FONT color="green">436</FONT>          this.matching = 0;<a name="line.436"></a>
<FONT color="green">437</FONT>    <a name="line.437"></a>
<FONT color="green">438</FONT>        }<a name="line.438"></a>
<FONT color="green">439</FONT>    <a name="line.439"></a>
<FONT color="green">440</FONT>        public double precision() {<a name="line.440"></a>
<FONT color="green">441</FONT>          return this.system == 0 ? 1.0 : this.matching / (double) this.system;<a name="line.441"></a>
<FONT color="green">442</FONT>        }<a name="line.442"></a>
<FONT color="green">443</FONT>    <a name="line.443"></a>
<FONT color="green">444</FONT>        public double recall() {<a name="line.444"></a>
<FONT color="green">445</FONT>          return this.gold == 0 ? 1.0 : this.matching / (double) this.gold;<a name="line.445"></a>
<FONT color="green">446</FONT>        }<a name="line.446"></a>
<FONT color="green">447</FONT>    <a name="line.447"></a>
<FONT color="green">448</FONT>        public double f1() {<a name="line.448"></a>
<FONT color="green">449</FONT>          double p = this.precision();<a name="line.449"></a>
<FONT color="green">450</FONT>          double r = this.recall();<a name="line.450"></a>
<FONT color="green">451</FONT>          return 2 * p * r / (p + r);<a name="line.451"></a>
<FONT color="green">452</FONT>        }<a name="line.452"></a>
<FONT color="green">453</FONT>      }<a name="line.453"></a>
<FONT color="green">454</FONT>    <a name="line.454"></a>
<FONT color="green">455</FONT>      public static class Span&lt;T extends Comparable&lt;? super T&gt;&gt; implements Comparable&lt;Span&lt;T&gt;&gt; {<a name="line.455"></a>
<FONT color="green">456</FONT>    <a name="line.456"></a>
<FONT color="green">457</FONT>        protected T begin;<a name="line.457"></a>
<FONT color="green">458</FONT>    <a name="line.458"></a>
<FONT color="green">459</FONT>        protected T end;<a name="line.459"></a>
<FONT color="green">460</FONT>    <a name="line.460"></a>
<FONT color="green">461</FONT>        public Span(T begin, T end) {<a name="line.461"></a>
<FONT color="green">462</FONT>          this.begin = begin;<a name="line.462"></a>
<FONT color="green">463</FONT>          this.end = end;<a name="line.463"></a>
<FONT color="green">464</FONT>        }<a name="line.464"></a>
<FONT color="green">465</FONT>    <a name="line.465"></a>
<FONT color="green">466</FONT>        @Override<a name="line.466"></a>
<FONT color="green">467</FONT>        public String toString() {<a name="line.467"></a>
<FONT color="green">468</FONT>          return String.format("%s(%s, %s)", this.getClass().getSimpleName(), this.begin, this.end);<a name="line.468"></a>
<FONT color="green">469</FONT>        }<a name="line.469"></a>
<FONT color="green">470</FONT>    <a name="line.470"></a>
<FONT color="green">471</FONT>        @Override<a name="line.471"></a>
<FONT color="green">472</FONT>        public int hashCode() {<a name="line.472"></a>
<FONT color="green">473</FONT>          return Arrays.hashCode(new Object[] { this.begin, this.end });<a name="line.473"></a>
<FONT color="green">474</FONT>        }<a name="line.474"></a>
<FONT color="green">475</FONT>    <a name="line.475"></a>
<FONT color="green">476</FONT>        @Override<a name="line.476"></a>
<FONT color="green">477</FONT>        public boolean equals(Object obj) {<a name="line.477"></a>
<FONT color="green">478</FONT>          boolean equals = false;<a name="line.478"></a>
<FONT color="green">479</FONT>          if (obj instanceof Span) {<a name="line.479"></a>
<FONT color="green">480</FONT>            Span&lt;?&gt; that = (Span&lt;?&gt;) obj;<a name="line.480"></a>
<FONT color="green">481</FONT>            equals = this.begin.equals(that.begin) &amp;&amp; this.end.equals(that.end);<a name="line.481"></a>
<FONT color="green">482</FONT>          }<a name="line.482"></a>
<FONT color="green">483</FONT>          return equals;<a name="line.483"></a>
<FONT color="green">484</FONT>        }<a name="line.484"></a>
<FONT color="green">485</FONT>    <a name="line.485"></a>
<FONT color="green">486</FONT>        @Override<a name="line.486"></a>
<FONT color="green">487</FONT>        public int compareTo(Span&lt;T&gt; that) {<a name="line.487"></a>
<FONT color="green">488</FONT>          int diff = this.begin.compareTo(that.begin);<a name="line.488"></a>
<FONT color="green">489</FONT>          if (diff == 0) {<a name="line.489"></a>
<FONT color="green">490</FONT>            diff = this.end.compareTo(that.end);<a name="line.490"></a>
<FONT color="green">491</FONT>          }<a name="line.491"></a>
<FONT color="green">492</FONT>          return diff;<a name="line.492"></a>
<FONT color="green">493</FONT>        }<a name="line.493"></a>
<FONT color="green">494</FONT>    <a name="line.494"></a>
<FONT color="green">495</FONT>      }<a name="line.495"></a>
<FONT color="green">496</FONT>    <a name="line.496"></a>
<FONT color="green">497</FONT>      public static class AnnotationSpan extends Span&lt;Integer&gt; {<a name="line.497"></a>
<FONT color="green">498</FONT>    <a name="line.498"></a>
<FONT color="green">499</FONT>        protected String textWindow;<a name="line.499"></a>
<FONT color="green">500</FONT>    <a name="line.500"></a>
<FONT color="green">501</FONT>        public AnnotationSpan(Annotation annotation) {<a name="line.501"></a>
<FONT color="green">502</FONT>          super(annotation.getBegin(), annotation.getEnd());<a name="line.502"></a>
<FONT color="green">503</FONT>          int nChars = 20;<a name="line.503"></a>
<FONT color="green">504</FONT>          String docText = annotation.getCAS().getDocumentText();<a name="line.504"></a>
<FONT color="green">505</FONT>          int windowBegin = Math.max(this.begin - nChars, 0);<a name="line.505"></a>
<FONT color="green">506</FONT>          int windowEnd = Math.min(this.end + nChars, docText.length());<a name="line.506"></a>
<FONT color="green">507</FONT>          this.textWindow = String.format(<a name="line.507"></a>
<FONT color="green">508</FONT>              "%s%s[%s]%s%s",<a name="line.508"></a>
<FONT color="green">509</FONT>              windowBegin == 0 ? "" : "...",<a name="line.509"></a>
<FONT color="green">510</FONT>              docText.substring(windowBegin, this.begin),<a name="line.510"></a>
<FONT color="green">511</FONT>              annotation.getCoveredText(),<a name="line.511"></a>
<FONT color="green">512</FONT>              docText.substring(this.end, windowEnd),<a name="line.512"></a>
<FONT color="green">513</FONT>              windowEnd == docText.length() ? "" : "...").replace('\n', ' ');<a name="line.513"></a>
<FONT color="green">514</FONT>        }<a name="line.514"></a>
<FONT color="green">515</FONT>    <a name="line.515"></a>
<FONT color="green">516</FONT>        @Override<a name="line.516"></a>
<FONT color="green">517</FONT>        public String toString() {<a name="line.517"></a>
<FONT color="green">518</FONT>          String name = this.getClass().getSimpleName();<a name="line.518"></a>
<FONT color="green">519</FONT>          return String.format("%s(%s, %s, %s)", name, this.begin, this.end, this.textWindow);<a name="line.519"></a>
<FONT color="green">520</FONT>        }<a name="line.520"></a>
<FONT color="green">521</FONT>      }<a name="line.521"></a>
<FONT color="green">522</FONT>    }<a name="line.522"></a>




























































</PRE>
</BODY>
</HTML>
