<HTML>
<BODY BGCOLOR="white">
<PRE>
<FONT color="green">001</FONT>    /** <a name="line.1"></a>
<FONT color="green">002</FONT>     * Copyright (c) 2007-2008, Regents of the University of Colorado <a name="line.2"></a>
<FONT color="green">003</FONT>     * All rights reserved.<a name="line.3"></a>
<FONT color="green">004</FONT>     * <a name="line.4"></a>
<FONT color="green">005</FONT>     * Redistribution and use in source and binary forms, with or without<a name="line.5"></a>
<FONT color="green">006</FONT>     * modification, are permitted provided that the following conditions are met:<a name="line.6"></a>
<FONT color="green">007</FONT>     * <a name="line.7"></a>
<FONT color="green">008</FONT>     * Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer. <a name="line.8"></a>
<FONT color="green">009</FONT>     * Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution. <a name="line.9"></a>
<FONT color="green">010</FONT>     * Neither the name of the University of Colorado at Boulder nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission. <a name="line.10"></a>
<FONT color="green">011</FONT>     * <a name="line.11"></a>
<FONT color="green">012</FONT>     * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"<a name="line.12"></a>
<FONT color="green">013</FONT>     * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE<a name="line.13"></a>
<FONT color="green">014</FONT>     * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE<a name="line.14"></a>
<FONT color="green">015</FONT>     * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE<a name="line.15"></a>
<FONT color="green">016</FONT>     * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR<a name="line.16"></a>
<FONT color="green">017</FONT>     * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF<a name="line.17"></a>
<FONT color="green">018</FONT>     * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS<a name="line.18"></a>
<FONT color="green">019</FONT>     * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN<a name="line.19"></a>
<FONT color="green">020</FONT>     * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)<a name="line.20"></a>
<FONT color="green">021</FONT>     * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE<a name="line.21"></a>
<FONT color="green">022</FONT>     * POSSIBILITY OF SUCH DAMAGE. <a name="line.22"></a>
<FONT color="green">023</FONT>     */<a name="line.23"></a>
<FONT color="green">024</FONT>    package org.cleartk.util;<a name="line.24"></a>
<FONT color="green">025</FONT>    <a name="line.25"></a>
<FONT color="green">026</FONT>    import java.util.ArrayList;<a name="line.26"></a>
<FONT color="green">027</FONT>    import java.util.List;<a name="line.27"></a>
<FONT color="green">028</FONT>    import java.util.NoSuchElementException;<a name="line.28"></a>
<FONT color="green">029</FONT>    <a name="line.29"></a>
<FONT color="green">030</FONT>    import org.apache.uima.cas.ConstraintFactory;<a name="line.30"></a>
<FONT color="green">031</FONT>    import org.apache.uima.cas.FSIndex;<a name="line.31"></a>
<FONT color="green">032</FONT>    import org.apache.uima.cas.FSIntConstraint;<a name="line.32"></a>
<FONT color="green">033</FONT>    import org.apache.uima.cas.FSIterator;<a name="line.33"></a>
<FONT color="green">034</FONT>    import org.apache.uima.cas.FSMatchConstraint;<a name="line.34"></a>
<FONT color="green">035</FONT>    import org.apache.uima.cas.FSTypeConstraint;<a name="line.35"></a>
<FONT color="green">036</FONT>    import org.apache.uima.cas.Feature;<a name="line.36"></a>
<FONT color="green">037</FONT>    import org.apache.uima.cas.FeaturePath;<a name="line.37"></a>
<FONT color="green">038</FONT>    import org.apache.uima.cas.FeatureStructure;<a name="line.38"></a>
<FONT color="green">039</FONT>    import org.apache.uima.cas.Type;<a name="line.39"></a>
<FONT color="green">040</FONT>    import org.apache.uima.cas.text.AnnotationIndex;<a name="line.40"></a>
<FONT color="green">041</FONT>    import org.apache.uima.jcas.JCas;<a name="line.41"></a>
<FONT color="green">042</FONT>    import org.apache.uima.jcas.tcas.Annotation;<a name="line.42"></a>
<FONT color="green">043</FONT>    import org.apache.uima.jcas.tcas.DocumentAnnotation;<a name="line.43"></a>
<FONT color="green">044</FONT>    import org.cleartk.type.SplitAnnotation;<a name="line.44"></a>
<FONT color="green">045</FONT>    <a name="line.45"></a>
<FONT color="green">046</FONT>    <a name="line.46"></a>
<FONT color="green">047</FONT>    /**<a name="line.47"></a>
<FONT color="green">048</FONT>     * &lt;br&gt;Copyright (c) 2007-2008, Regents of the University of Colorado <a name="line.48"></a>
<FONT color="green">049</FONT>     * &lt;br&gt;All rights reserved.<a name="line.49"></a>
<FONT color="green">050</FONT>    <a name="line.50"></a>
<FONT color="green">051</FONT>     * &lt;p&gt;<a name="line.51"></a>
<FONT color="green">052</FONT>     * <a name="line.52"></a>
<FONT color="green">053</FONT>     * @author Philip Ogren<a name="line.53"></a>
<FONT color="green">054</FONT>     * @author Philipp Wetzler<a name="line.54"></a>
<FONT color="green">055</FONT>     * @author Steven Bethard<a name="line.55"></a>
<FONT color="green">056</FONT>     */<a name="line.56"></a>
<FONT color="green">057</FONT>    public class AnnotationRetrieval {<a name="line.57"></a>
<FONT color="green">058</FONT>            /**<a name="line.58"></a>
<FONT color="green">059</FONT>             * This method exists simply as a convenience method for unit testing. It is<a name="line.59"></a>
<FONT color="green">060</FONT>             * not very efficient and should not, in general be used outside the context<a name="line.60"></a>
<FONT color="green">061</FONT>             * of unit testing.<a name="line.61"></a>
<FONT color="green">062</FONT>             */<a name="line.62"></a>
<FONT color="green">063</FONT>            public static &lt;T extends Annotation&gt; T get(JCas jCas, Class&lt;T&gt; cls, int index) {<a name="line.63"></a>
<FONT color="green">064</FONT>                    int type;<a name="line.64"></a>
<FONT color="green">065</FONT>                    try {<a name="line.65"></a>
<FONT color="green">066</FONT>                            type = (Integer) cls.getField("type").get(null);<a name="line.66"></a>
<FONT color="green">067</FONT>                    }<a name="line.67"></a>
<FONT color="green">068</FONT>                    catch (IllegalAccessException e) {<a name="line.68"></a>
<FONT color="green">069</FONT>                            throw new RuntimeException();<a name="line.69"></a>
<FONT color="green">070</FONT>                    }<a name="line.70"></a>
<FONT color="green">071</FONT>                    catch (NoSuchFieldException e) {<a name="line.71"></a>
<FONT color="green">072</FONT>                            throw new RuntimeException();<a name="line.72"></a>
<FONT color="green">073</FONT>                    }<a name="line.73"></a>
<FONT color="green">074</FONT>    <a name="line.74"></a>
<FONT color="green">075</FONT>                    // TODO we should probably iterate from the end rather than<a name="line.75"></a>
<FONT color="green">076</FONT>                    // iterating forward from the begining.<a name="line.76"></a>
<FONT color="green">077</FONT>                    FSIndex fsIndex = jCas.getAnnotationIndex(type);<a name="line.77"></a>
<FONT color="green">078</FONT>                    if (index &lt; 0) index = fsIndex.size() + index;<a name="line.78"></a>
<FONT color="green">079</FONT>    <a name="line.79"></a>
<FONT color="green">080</FONT>                    if (index &lt; 0 || index &gt;= fsIndex.size()) return null;<a name="line.80"></a>
<FONT color="green">081</FONT>                    FSIterator iterator = fsIndex.iterator();<a name="line.81"></a>
<FONT color="green">082</FONT>                    Object returnValue = iterator.next();<a name="line.82"></a>
<FONT color="green">083</FONT>                    for (int i = 0; i &lt; index; i++) {<a name="line.83"></a>
<FONT color="green">084</FONT>                            returnValue = iterator.next();<a name="line.84"></a>
<FONT color="green">085</FONT>                    }<a name="line.85"></a>
<FONT color="green">086</FONT>                    return cls.cast(returnValue);<a name="line.86"></a>
<FONT color="green">087</FONT>            }<a name="line.87"></a>
<FONT color="green">088</FONT>    <a name="line.88"></a>
<FONT color="green">089</FONT>            public static &lt;T extends Annotation&gt; T get(JCas jCas, T annotation, int relativePosition) {<a name="line.89"></a>
<FONT color="green">090</FONT>                    return get(jCas, annotation, relativePosition, null);<a name="line.90"></a>
<FONT color="green">091</FONT>            }<a name="line.91"></a>
<FONT color="green">092</FONT>    <a name="line.92"></a>
<FONT color="green">093</FONT>            public static &lt;T extends Annotation&gt; T get(JCas jCas, T annotation, int relativePosition,<a name="line.93"></a>
<FONT color="green">094</FONT>                            Annotation windowAnnotation) {<a name="line.94"></a>
<FONT color="green">095</FONT>                    FSIterator cursor = jCas.getAnnotationIndex(annotation.getType()).iterator();<a name="line.95"></a>
<FONT color="green">096</FONT>                    cursor.moveTo(annotation);<a name="line.96"></a>
<FONT color="green">097</FONT>    <a name="line.97"></a>
<FONT color="green">098</FONT>                    if (relativePosition &gt; 0) {<a name="line.98"></a>
<FONT color="green">099</FONT>                            for (int i = 0; i &lt; relativePosition &amp;&amp; cursor.isValid(); i++)<a name="line.99"></a>
<FONT color="green">100</FONT>                                    cursor.moveToNext();<a name="line.100"></a>
<FONT color="green">101</FONT>                    }<a name="line.101"></a>
<FONT color="green">102</FONT>                    else {<a name="line.102"></a>
<FONT color="green">103</FONT>                            for (int i = 0; i &lt; -relativePosition &amp;&amp; cursor.isValid(); i++)<a name="line.103"></a>
<FONT color="green">104</FONT>                                    cursor.moveToPrevious();<a name="line.104"></a>
<FONT color="green">105</FONT>                    }<a name="line.105"></a>
<FONT color="green">106</FONT>                    if (cursor.isValid()) {<a name="line.106"></a>
<FONT color="green">107</FONT>                            Annotation relativeAnnotation = (Annotation) cursor.get();<a name="line.107"></a>
<FONT color="green">108</FONT>    <a name="line.108"></a>
<FONT color="green">109</FONT>                            T returnValue = ReflectionUtil.&lt;Class&lt;T&gt;&gt;uncheckedCast(annotation.getClass()).cast(relativeAnnotation);<a name="line.109"></a>
<FONT color="green">110</FONT>    <a name="line.110"></a>
<FONT color="green">111</FONT>                            if (windowAnnotation != null) {<a name="line.111"></a>
<FONT color="green">112</FONT>                                    if (AnnotationUtil.contains(windowAnnotation, relativeAnnotation)) return returnValue;<a name="line.112"></a>
<FONT color="green">113</FONT>                                    else return null;<a name="line.113"></a>
<FONT color="green">114</FONT>                            }<a name="line.114"></a>
<FONT color="green">115</FONT>                            else return returnValue;<a name="line.115"></a>
<FONT color="green">116</FONT>                    }<a name="line.116"></a>
<FONT color="green">117</FONT>                    else return null;<a name="line.117"></a>
<FONT color="green">118</FONT>            }<a name="line.118"></a>
<FONT color="green">119</FONT>    <a name="line.119"></a>
<FONT color="green">120</FONT>            public static &lt;RETURN_TYPE extends Annotation&gt; RETURN_TYPE get(JCas jCas, Annotation annotation, Class&lt;RETURN_TYPE&gt; returnCls, int relativePosition) {<a name="line.120"></a>
<FONT color="green">121</FONT>                    if(relativePosition == 0) {<a name="line.121"></a>
<FONT color="green">122</FONT>                            return getFirstAnnotation(jCas, annotation, returnCls);<a name="line.122"></a>
<FONT color="green">123</FONT>                    }<a name="line.123"></a>
<FONT color="green">124</FONT>                    else if(relativePosition &lt; 0) {<a name="line.124"></a>
<FONT color="green">125</FONT>                            RETURN_TYPE returnValue = getAdjacentAnnotation(jCas, annotation, returnCls, true);<a name="line.125"></a>
<FONT color="green">126</FONT>                            if(returnValue == null)<a name="line.126"></a>
<FONT color="green">127</FONT>                                    return null;<a name="line.127"></a>
<FONT color="green">128</FONT>                            if(relativePosition == -1)<a name="line.128"></a>
<FONT color="green">129</FONT>                                    return returnValue;<a name="line.129"></a>
<FONT color="green">130</FONT>                            return get(jCas, returnValue, relativePosition + 1);<a name="line.130"></a>
<FONT color="green">131</FONT>                    } else {<a name="line.131"></a>
<FONT color="green">132</FONT>                            RETURN_TYPE returnValue = getAdjacentAnnotation(jCas, annotation, returnCls, false);<a name="line.132"></a>
<FONT color="green">133</FONT>                            if(returnValue == null)<a name="line.133"></a>
<FONT color="green">134</FONT>                                    return null;<a name="line.134"></a>
<FONT color="green">135</FONT>                            if(relativePosition == 1)<a name="line.135"></a>
<FONT color="green">136</FONT>                                    return returnValue;<a name="line.136"></a>
<FONT color="green">137</FONT>                            return get(jCas, returnValue, relativePosition - 1);<a name="line.137"></a>
<FONT color="green">138</FONT>                    } <a name="line.138"></a>
<FONT color="green">139</FONT>            }<a name="line.139"></a>
<FONT color="green">140</FONT>    <a name="line.140"></a>
<FONT color="green">141</FONT>            /**<a name="line.141"></a>
<FONT color="green">142</FONT>             * We initially used the AnnotationIndex.subiterator() but ran into issues<a name="line.142"></a>
<FONT color="green">143</FONT>             * that we wanted to work around concerning the use of type priorities when<a name="line.143"></a>
<FONT color="green">144</FONT>             * the window and windowed annotations have the same begin and end offsets.<a name="line.144"></a>
<FONT color="green">145</FONT>             * By using our own iterator we can back up to the first annotation that has<a name="line.145"></a>
<FONT color="green">146</FONT>             * the same beginning as the window annotation and avoid having to set type<a name="line.146"></a>
<FONT color="green">147</FONT>             * priorities.<a name="line.147"></a>
<FONT color="green">148</FONT>             * <a name="line.148"></a>
<FONT color="green">149</FONT>             * @param jCas<a name="line.149"></a>
<FONT color="green">150</FONT>             * @param windowAnnotation<a name="line.150"></a>
<FONT color="green">151</FONT>             * @return an FSIterator that is at the correct position<a name="line.151"></a>
<FONT color="green">152</FONT>             */<a name="line.152"></a>
<FONT color="green">153</FONT>            private static FSIterator initializeWindowCursor(JCas jCas, Annotation windowAnnotation) {<a name="line.153"></a>
<FONT color="green">154</FONT>    <a name="line.154"></a>
<FONT color="green">155</FONT>                    FSIterator cursor = jCas.getAnnotationIndex().iterator();<a name="line.155"></a>
<FONT color="green">156</FONT>                    <a name="line.156"></a>
<FONT color="green">157</FONT>                    cursor.moveTo(windowAnnotation);<a name="line.157"></a>
<FONT color="green">158</FONT>                    <a name="line.158"></a>
<FONT color="green">159</FONT>                    // if cursor is invalid now we're past the end of the index<a name="line.159"></a>
<FONT color="green">160</FONT>                    if( !cursor.isValid() )<a name="line.160"></a>
<FONT color="green">161</FONT>                            return cursor;<a name="line.161"></a>
<FONT color="green">162</FONT>    <a name="line.162"></a>
<FONT color="green">163</FONT>                    while (cursor.isValid() &amp;&amp; ((Annotation) cursor.get()).getBegin() &gt;= windowAnnotation.getBegin()) {<a name="line.163"></a>
<FONT color="green">164</FONT>                            cursor.moveToPrevious();<a name="line.164"></a>
<FONT color="green">165</FONT>                    }<a name="line.165"></a>
<FONT color="green">166</FONT>    <a name="line.166"></a>
<FONT color="green">167</FONT>                    if (cursor.isValid()) {<a name="line.167"></a>
<FONT color="green">168</FONT>                            cursor.moveToNext();<a name="line.168"></a>
<FONT color="green">169</FONT>                    }<a name="line.169"></a>
<FONT color="green">170</FONT>                    else {<a name="line.170"></a>
<FONT color="green">171</FONT>                            cursor.moveToFirst();<a name="line.171"></a>
<FONT color="green">172</FONT>                    }<a name="line.172"></a>
<FONT color="green">173</FONT>    <a name="line.173"></a>
<FONT color="green">174</FONT>                    return cursor;<a name="line.174"></a>
<FONT color="green">175</FONT>            }<a name="line.175"></a>
<FONT color="green">176</FONT>    <a name="line.176"></a>
<FONT color="green">177</FONT>            /**<a name="line.177"></a>
<FONT color="green">178</FONT>             * @param &lt;T&gt;<a name="line.178"></a>
<FONT color="green">179</FONT>             *            determines the return type of the method<a name="line.179"></a>
<FONT color="green">180</FONT>             * @param jCas<a name="line.180"></a>
<FONT color="green">181</FONT>             *            the current jCas or view<a name="line.181"></a>
<FONT color="green">182</FONT>             * @param windowAnnotation<a name="line.182"></a>
<FONT color="green">183</FONT>             *            an annotation that defines a window<a name="line.183"></a>
<FONT color="green">184</FONT>             * @param cls<a name="line.184"></a>
<FONT color="green">185</FONT>             *            determines the return type of the method<a name="line.185"></a>
<FONT color="green">186</FONT>             * @return the last annotation of type cls that is "inside" the window<a name="line.186"></a>
<FONT color="green">187</FONT>             * @see #getAnnotations(JCas, Annotation, Class)<a name="line.187"></a>
<FONT color="green">188</FONT>             */<a name="line.188"></a>
<FONT color="green">189</FONT>            public static &lt;T extends Annotation&gt; T getLastAnnotation(JCas jCas, Annotation windowAnnotation, Class&lt;T&gt; cls) {<a name="line.189"></a>
<FONT color="green">190</FONT>                    FSIterator cursor = initializeWindowCursor(jCas, windowAnnotation);<a name="line.190"></a>
<FONT color="green">191</FONT>    <a name="line.191"></a>
<FONT color="green">192</FONT>                    T currentBestGuess = null;<a name="line.192"></a>
<FONT color="green">193</FONT>                    while (cursor.isValid() &amp;&amp; ((Annotation) cursor.get()).getBegin() &lt;= windowAnnotation.getEnd()) {<a name="line.193"></a>
<FONT color="green">194</FONT>                            Annotation annotation = (Annotation) cursor.get();<a name="line.194"></a>
<FONT color="green">195</FONT>    <a name="line.195"></a>
<FONT color="green">196</FONT>                            if (cls.isInstance(annotation) &amp;&amp; annotation.getEnd() &lt;= windowAnnotation.getEnd()) currentBestGuess = cls<a name="line.196"></a>
<FONT color="green">197</FONT>                            .cast(annotation);<a name="line.197"></a>
<FONT color="green">198</FONT>                            cursor.moveToNext();<a name="line.198"></a>
<FONT color="green">199</FONT>                    }<a name="line.199"></a>
<FONT color="green">200</FONT>                    return currentBestGuess;<a name="line.200"></a>
<FONT color="green">201</FONT>            }<a name="line.201"></a>
<FONT color="green">202</FONT>    <a name="line.202"></a>
<FONT color="green">203</FONT>            /**<a name="line.203"></a>
<FONT color="green">204</FONT>             * @param &lt;T&gt;<a name="line.204"></a>
<FONT color="green">205</FONT>             *            determines the return type of the method<a name="line.205"></a>
<FONT color="green">206</FONT>             * @param jCas<a name="line.206"></a>
<FONT color="green">207</FONT>             *            the current jCas or view<a name="line.207"></a>
<FONT color="green">208</FONT>             * @param windowAnnotation<a name="line.208"></a>
<FONT color="green">209</FONT>             *            an annotation that defines a window<a name="line.209"></a>
<FONT color="green">210</FONT>             * @param cls<a name="line.210"></a>
<FONT color="green">211</FONT>             *            determines the return type of the method<a name="line.211"></a>
<FONT color="green">212</FONT>             * @return the first annotation of type cls that is "inside" the window<a name="line.212"></a>
<FONT color="green">213</FONT>             * @see #getAnnotations(JCas, Annotation, Class)<a name="line.213"></a>
<FONT color="green">214</FONT>             */<a name="line.214"></a>
<FONT color="green">215</FONT>            public static &lt;T extends Annotation&gt; T getFirstAnnotation(JCas jCas, Annotation windowAnnotation, Class&lt;T&gt; cls) {<a name="line.215"></a>
<FONT color="green">216</FONT>                    FSIterator cursor = initializeWindowCursor(jCas, windowAnnotation);<a name="line.216"></a>
<FONT color="green">217</FONT>    <a name="line.217"></a>
<FONT color="green">218</FONT>                    // I left in the while loop because the first annotation we see might<a name="line.218"></a>
<FONT color="green">219</FONT>                    // not be the right class<a name="line.219"></a>
<FONT color="green">220</FONT>                    while (cursor.isValid() &amp;&amp; ((Annotation) cursor.get()).getBegin() &lt;= windowAnnotation.getEnd()) {<a name="line.220"></a>
<FONT color="green">221</FONT>                            Annotation annotation = (Annotation) cursor.get();<a name="line.221"></a>
<FONT color="green">222</FONT>                            if (cls.isInstance(annotation) &amp;&amp; annotation.getEnd() &lt;= windowAnnotation.getEnd()) return cls<a name="line.222"></a>
<FONT color="green">223</FONT>                            .cast(annotation);<a name="line.223"></a>
<FONT color="green">224</FONT>                            cursor.moveToNext();<a name="line.224"></a>
<FONT color="green">225</FONT>                    }<a name="line.225"></a>
<FONT color="green">226</FONT>                    return null;<a name="line.226"></a>
<FONT color="green">227</FONT>            }<a name="line.227"></a>
<FONT color="green">228</FONT>            <a name="line.228"></a>
<FONT color="green">229</FONT>            /**<a name="line.229"></a>
<FONT color="green">230</FONT>             * @param &lt;T&gt;<a name="line.230"></a>
<FONT color="green">231</FONT>             *            determines the return type of the method<a name="line.231"></a>
<FONT color="green">232</FONT>             * @param view<a name="line.232"></a>
<FONT color="green">233</FONT>             *            the jCAS view<a name="line.233"></a>
<FONT color="green">234</FONT>             * @param cls<a name="line.234"></a>
<FONT color="green">235</FONT>             *            determines the return type of the method<a name="line.235"></a>
<FONT color="green">236</FONT>             * @return the first annotation of type cls in this view<a name="line.236"></a>
<FONT color="green">237</FONT>             */<a name="line.237"></a>
<FONT color="green">238</FONT>            public static &lt;T extends Annotation&gt; T getFirstAnnotation(JCas view, Class&lt;T&gt; cls) {<a name="line.238"></a>
<FONT color="green">239</FONT>                    FSIterator cursor = view.getAnnotationIndex().iterator();<a name="line.239"></a>
<FONT color="green">240</FONT>                    cursor.moveToFirst();<a name="line.240"></a>
<FONT color="green">241</FONT>    <a name="line.241"></a>
<FONT color="green">242</FONT>                    while( cursor.isValid() ) {<a name="line.242"></a>
<FONT color="green">243</FONT>                            Annotation annotation = (Annotation) cursor.get();<a name="line.243"></a>
<FONT color="green">244</FONT>                            if( cls.isInstance(annotation) ) return cls.cast(annotation);<a name="line.244"></a>
<FONT color="green">245</FONT>                            cursor.moveToNext();<a name="line.245"></a>
<FONT color="green">246</FONT>                    }<a name="line.246"></a>
<FONT color="green">247</FONT>                    return null;<a name="line.247"></a>
<FONT color="green">248</FONT>            }<a name="line.248"></a>
<FONT color="green">249</FONT>    <a name="line.249"></a>
<FONT color="green">250</FONT>            /*<a name="line.250"></a>
<FONT color="green">251</FONT>             * Find an annotation of a different type that covers the same span.<a name="line.251"></a>
<FONT color="green">252</FONT>             * <a name="line.252"></a>
<FONT color="green">253</FONT>             * @param &lt;T&gt; is the type of annotation we're looking for @param jCas is the<a name="line.253"></a>
<FONT color="green">254</FONT>             * current CAS view @param windowAnnotation determines the span of the<a name="line.254"></a>
<FONT color="green">255</FONT>             * annotation @return the first annotation in the index that has the same<a name="line.255"></a>
<FONT color="green">256</FONT>             * span as windowAnnotation<a name="line.256"></a>
<FONT color="green">257</FONT>             */<a name="line.257"></a>
<FONT color="green">258</FONT>            public static &lt;T extends Annotation&gt; T getMatchingAnnotation(JCas jCas, Annotation windowAnnotation, Class&lt;T&gt; cls) {<a name="line.258"></a>
<FONT color="green">259</FONT>                    if (cls.isInstance(windowAnnotation)) return cls.cast(windowAnnotation);<a name="line.259"></a>
<FONT color="green">260</FONT>    <a name="line.260"></a>
<FONT color="green">261</FONT>                    FSIterator cursor = jCas.getAnnotationIndex().iterator();<a name="line.261"></a>
<FONT color="green">262</FONT>    <a name="line.262"></a>
<FONT color="green">263</FONT>                    cursor.moveTo(windowAnnotation);<a name="line.263"></a>
<FONT color="green">264</FONT>                    Annotation cursorAnnotation = (Annotation) cursor.get();<a name="line.264"></a>
<FONT color="green">265</FONT>                    if (cursorAnnotation.getBegin() != windowAnnotation.getBegin()<a name="line.265"></a>
<FONT color="green">266</FONT>                                    || cursorAnnotation.getEnd() != windowAnnotation.getEnd()) return null;<a name="line.266"></a>
<FONT color="green">267</FONT>    <a name="line.267"></a>
<FONT color="green">268</FONT>                    while (cursor.isValid() &amp;&amp; cursorAnnotation.getBegin() == windowAnnotation.getBegin()<a name="line.268"></a>
<FONT color="green">269</FONT>                                    &amp;&amp; cursorAnnotation.getEnd() == windowAnnotation.getEnd()) {<a name="line.269"></a>
<FONT color="green">270</FONT>                            cursor.moveToPrevious();<a name="line.270"></a>
<FONT color="green">271</FONT>                            if (cursor.isValid()) cursorAnnotation = (Annotation) cursor.get();<a name="line.271"></a>
<FONT color="green">272</FONT>                            else cursorAnnotation = null;<a name="line.272"></a>
<FONT color="green">273</FONT>                    }<a name="line.273"></a>
<FONT color="green">274</FONT>    <a name="line.274"></a>
<FONT color="green">275</FONT>                    if (cursor.isValid()) {<a name="line.275"></a>
<FONT color="green">276</FONT>                            cursor.moveToNext();<a name="line.276"></a>
<FONT color="green">277</FONT>                            cursorAnnotation = (Annotation) cursor.get();<a name="line.277"></a>
<FONT color="green">278</FONT>                    }<a name="line.278"></a>
<FONT color="green">279</FONT>                    else {<a name="line.279"></a>
<FONT color="green">280</FONT>                            cursor.moveToFirst();<a name="line.280"></a>
<FONT color="green">281</FONT>                            cursorAnnotation = (Annotation) cursor.get();<a name="line.281"></a>
<FONT color="green">282</FONT>                    }<a name="line.282"></a>
<FONT color="green">283</FONT>    <a name="line.283"></a>
<FONT color="green">284</FONT>                    while (cursor.isValid() &amp;&amp; cursorAnnotation.getBegin() == windowAnnotation.getBegin()<a name="line.284"></a>
<FONT color="green">285</FONT>                                    &amp;&amp; cursorAnnotation.getEnd() == windowAnnotation.getEnd()) {<a name="line.285"></a>
<FONT color="green">286</FONT>                            if (cls.isInstance(cursorAnnotation)) return cls.cast(cursorAnnotation);<a name="line.286"></a>
<FONT color="green">287</FONT>                            cursor.moveToNext();<a name="line.287"></a>
<FONT color="green">288</FONT>                            if (cursor.isValid()) cursorAnnotation = (Annotation) cursor.get();<a name="line.288"></a>
<FONT color="green">289</FONT>                            else cursorAnnotation = null;<a name="line.289"></a>
<FONT color="green">290</FONT>                    }<a name="line.290"></a>
<FONT color="green">291</FONT>    <a name="line.291"></a>
<FONT color="green">292</FONT>                    return null;<a name="line.292"></a>
<FONT color="green">293</FONT>            }<a name="line.293"></a>
<FONT color="green">294</FONT>    <a name="line.294"></a>
<FONT color="green">295</FONT>            /**<a name="line.295"></a>
<FONT color="green">296</FONT>             * Returns a List of all annotations of a given type.<a name="line.296"></a>
<FONT color="green">297</FONT>             * <a name="line.297"></a>
<FONT color="green">298</FONT>             * @param &lt;T&gt;<a name="line.298"></a>
<FONT color="green">299</FONT>             *            The type of Annotation being collected.<a name="line.299"></a>
<FONT color="green">300</FONT>             * @param jCas<a name="line.300"></a>
<FONT color="green">301</FONT>             *            The JCas from which annotations should be collected.<a name="line.301"></a>
<FONT color="green">302</FONT>             * @param annotationClass<a name="line.302"></a>
<FONT color="green">303</FONT>             *            The Annotation class.<a name="line.303"></a>
<FONT color="green">304</FONT>             * @return A List of all Annotations of the given type.<a name="line.304"></a>
<FONT color="green">305</FONT>             */<a name="line.305"></a>
<FONT color="green">306</FONT>            public static &lt;T extends Annotation&gt; List&lt;T&gt; getAnnotations(JCas jCas, Class&lt;T&gt; annotationClass) {<a name="line.306"></a>
<FONT color="green">307</FONT>                    // get the integer type from the annotation class<a name="line.307"></a>
<FONT color="green">308</FONT>                    // not that T.type doesn't work because that gives us Annotation.type<a name="line.308"></a>
<FONT color="green">309</FONT>                    // (why?)<a name="line.309"></a>
<FONT color="green">310</FONT>                    int type;<a name="line.310"></a>
<FONT color="green">311</FONT>                    try {<a name="line.311"></a>
<FONT color="green">312</FONT>                            type = annotationClass.getField("type").getInt(null);<a name="line.312"></a>
<FONT color="green">313</FONT>                    }<a name="line.313"></a>
<FONT color="green">314</FONT>                    catch (IllegalArgumentException e) {<a name="line.314"></a>
<FONT color="green">315</FONT>                            throw new RuntimeException(e);<a name="line.315"></a>
<FONT color="green">316</FONT>                    }<a name="line.316"></a>
<FONT color="green">317</FONT>                    catch (SecurityException e) {<a name="line.317"></a>
<FONT color="green">318</FONT>                            throw new RuntimeException(e);<a name="line.318"></a>
<FONT color="green">319</FONT>                    }<a name="line.319"></a>
<FONT color="green">320</FONT>                    catch (IllegalAccessException e) {<a name="line.320"></a>
<FONT color="green">321</FONT>                            throw new RuntimeException(e);<a name="line.321"></a>
<FONT color="green">322</FONT>                    }<a name="line.322"></a>
<FONT color="green">323</FONT>                    catch (NoSuchFieldException e) {<a name="line.323"></a>
<FONT color="green">324</FONT>                            throw new RuntimeException(e);<a name="line.324"></a>
<FONT color="green">325</FONT>                    }<a name="line.325"></a>
<FONT color="green">326</FONT>    <a name="line.326"></a>
<FONT color="green">327</FONT>                    // collect all annotations of the given type into a list<a name="line.327"></a>
<FONT color="green">328</FONT>                    AnnotationIndex index = jCas.getAnnotationIndex(type);<a name="line.328"></a>
<FONT color="green">329</FONT>                    List&lt;T&gt; annotations = new ArrayList&lt;T&gt;();<a name="line.329"></a>
<FONT color="green">330</FONT>                    for (FSIterator iter = index.iterator(); iter.hasNext();) {<a name="line.330"></a>
<FONT color="green">331</FONT>                            Object next = iter.next();<a name="line.331"></a>
<FONT color="green">332</FONT>                            annotations.add(annotationClass.cast(next));<a name="line.332"></a>
<FONT color="green">333</FONT>                    }<a name="line.333"></a>
<FONT color="green">334</FONT>                    return annotations;<a name="line.334"></a>
<FONT color="green">335</FONT>            }<a name="line.335"></a>
<FONT color="green">336</FONT>    <a name="line.336"></a>
<FONT color="green">337</FONT>            /**<a name="line.337"></a>
<FONT color="green">338</FONT>             * This method returns all annotations (in order) that are inside a "window"<a name="line.338"></a>
<FONT color="green">339</FONT>             * annotation of a particular kind. The functionality provided is similar to<a name="line.339"></a>
<FONT color="green">340</FONT>             * using AnnotationIndex.subiterator(), however we found the use of type<a name="line.340"></a>
<FONT color="green">341</FONT>             * priorities which is documented in detail in their javadocs to be<a name="line.341"></a>
<FONT color="green">342</FONT>             * distasteful. This method does not require that type priorities be set in<a name="line.342"></a>
<FONT color="green">343</FONT>             * order to work as expected for the condition where the window annotation<a name="line.343"></a>
<FONT color="green">344</FONT>             * and the "windowed" annotation have the same size and location.<a name="line.344"></a>
<FONT color="green">345</FONT>             * <a name="line.345"></a>
<FONT color="green">346</FONT>             * @param &lt;T&gt;<a name="line.346"></a>
<FONT color="green">347</FONT>             *            determines the return type of the method<a name="line.347"></a>
<FONT color="green">348</FONT>             * @param jCas<a name="line.348"></a>
<FONT color="green">349</FONT>             *            the current jCas or view<a name="line.349"></a>
<FONT color="green">350</FONT>             * @param windowAnnotation<a name="line.350"></a>
<FONT color="green">351</FONT>             *            an annotation that defines a window<a name="line.351"></a>
<FONT color="green">352</FONT>             * @param cls<a name="line.352"></a>
<FONT color="green">353</FONT>             *            determines the return type of the method<a name="line.353"></a>
<FONT color="green">354</FONT>             * @return a list of annotations of type cls that are "inside" the window<a name="line.354"></a>
<FONT color="green">355</FONT>             * @see AnnotationIndex#subiterator(org.apache.uima.cas.text.AnnotationFS)<a name="line.355"></a>
<FONT color="green">356</FONT>             */<a name="line.356"></a>
<FONT color="green">357</FONT>            public static &lt;T extends Annotation&gt; List&lt;T&gt; getAnnotations(JCas jCas, Annotation windowAnnotation, Class&lt;T&gt; cls) {<a name="line.357"></a>
<FONT color="green">358</FONT>                    if (windowAnnotation instanceof SplitAnnotation) return getAnnotations(jCas,<a name="line.358"></a>
<FONT color="green">359</FONT>                                    (SplitAnnotation) windowAnnotation, cls);<a name="line.359"></a>
<FONT color="green">360</FONT>    <a name="line.360"></a>
<FONT color="green">361</FONT>                    FSIterator cursor = initializeWindowCursor(jCas, windowAnnotation);<a name="line.361"></a>
<FONT color="green">362</FONT>    <a name="line.362"></a>
<FONT color="green">363</FONT>                    List&lt;T&gt; annotations = new ArrayList&lt;T&gt;();<a name="line.363"></a>
<FONT color="green">364</FONT>                    while (cursor.isValid() &amp;&amp; ((Annotation) cursor.get()).getBegin() &lt;= windowAnnotation.getEnd()) {<a name="line.364"></a>
<FONT color="green">365</FONT>                            Annotation annotation = (Annotation) cursor.get();<a name="line.365"></a>
<FONT color="green">366</FONT>    <a name="line.366"></a>
<FONT color="green">367</FONT>                            if (cls.isInstance(annotation) &amp;&amp; annotation.getEnd() &lt;= windowAnnotation.getEnd()) annotations.add(cls<a name="line.367"></a>
<FONT color="green">368</FONT>                                            .cast(annotation));<a name="line.368"></a>
<FONT color="green">369</FONT>    <a name="line.369"></a>
<FONT color="green">370</FONT>                            cursor.moveToNext();<a name="line.370"></a>
<FONT color="green">371</FONT>                    }<a name="line.371"></a>
<FONT color="green">372</FONT>                    return annotations;<a name="line.372"></a>
<FONT color="green">373</FONT>            }<a name="line.373"></a>
<FONT color="green">374</FONT>    <a name="line.374"></a>
<FONT color="green">375</FONT>            public static &lt;T extends Annotation&gt; List&lt;T&gt; getAnnotations(JCas jCas, Annotation windowAnnotation, Class&lt;T&gt; cls,<a name="line.375"></a>
<FONT color="green">376</FONT>                            boolean exactSpan) {<a name="line.376"></a>
<FONT color="green">377</FONT>                    if (windowAnnotation instanceof SplitAnnotation) return getAnnotations(jCas,<a name="line.377"></a>
<FONT color="green">378</FONT>                                    (SplitAnnotation) windowAnnotation, cls);<a name="line.378"></a>
<FONT color="green">379</FONT>    <a name="line.379"></a>
<FONT color="green">380</FONT>                    if (!exactSpan) return getAnnotations(jCas, windowAnnotation, cls);<a name="line.380"></a>
<FONT color="green">381</FONT>                    else {<a name="line.381"></a>
<FONT color="green">382</FONT>                            FSIterator cursor = initializeWindowCursor(jCas, windowAnnotation);<a name="line.382"></a>
<FONT color="green">383</FONT>    <a name="line.383"></a>
<FONT color="green">384</FONT>                            List&lt;T&gt; annotations = new ArrayList&lt;T&gt;();<a name="line.384"></a>
<FONT color="green">385</FONT>                            while (cursor.isValid() &amp;&amp; ((Annotation) cursor.get()).getBegin() &lt;= windowAnnotation.getEnd()) {<a name="line.385"></a>
<FONT color="green">386</FONT>                                    Annotation annotation = (Annotation) cursor.get();<a name="line.386"></a>
<FONT color="green">387</FONT>    <a name="line.387"></a>
<FONT color="green">388</FONT>                                    if (cls.isInstance(annotation) &amp;&amp; annotation.getBegin() == windowAnnotation.getBegin()<a name="line.388"></a>
<FONT color="green">389</FONT>                                                    &amp;&amp; annotation.getEnd() == windowAnnotation.getEnd()) annotations.add(cls.cast(annotation));<a name="line.389"></a>
<FONT color="green">390</FONT>    <a name="line.390"></a>
<FONT color="green">391</FONT>                                    cursor.moveToNext();<a name="line.391"></a>
<FONT color="green">392</FONT>                            }<a name="line.392"></a>
<FONT color="green">393</FONT>                            return annotations;<a name="line.393"></a>
<FONT color="green">394</FONT>                    }<a name="line.394"></a>
<FONT color="green">395</FONT>            }<a name="line.395"></a>
<FONT color="green">396</FONT>    <a name="line.396"></a>
<FONT color="green">397</FONT>            public static &lt;T extends Annotation&gt; List&lt;T&gt; getAnnotations(JCas jCas, int begin, int end, Class&lt;T&gt; cls,<a name="line.397"></a>
<FONT color="green">398</FONT>                            boolean exactSpan) {<a name="line.398"></a>
<FONT color="green">399</FONT>                    if(begin &gt; end)<a name="line.399"></a>
<FONT color="green">400</FONT>                            return null;<a name="line.400"></a>
<FONT color="green">401</FONT>                    if (!exactSpan) {<a name="line.401"></a>
<FONT color="green">402</FONT>                            return getAnnotations(jCas, begin, end, cls);<a name="line.402"></a>
<FONT color="green">403</FONT>                    }<a name="line.403"></a>
<FONT color="green">404</FONT>                    else {<a name="line.404"></a>
<FONT color="green">405</FONT>                            return getAnnotations(jCas, new Annotation(jCas, begin, end), cls, exactSpan);<a name="line.405"></a>
<FONT color="green">406</FONT>                    }<a name="line.406"></a>
<FONT color="green">407</FONT>    <a name="line.407"></a>
<FONT color="green">408</FONT>            }<a name="line.408"></a>
<FONT color="green">409</FONT>    <a name="line.409"></a>
<FONT color="green">410</FONT>            public static &lt;T extends Annotation&gt; List&lt;T&gt; getAnnotations(JCas jCas, SplitAnnotation splitAnnotation, Class&lt;T&gt; cls) {<a name="line.410"></a>
<FONT color="green">411</FONT>                    List&lt;T&gt; returnValues = new ArrayList&lt;T&gt;();<a name="line.411"></a>
<FONT color="green">412</FONT>    <a name="line.412"></a>
<FONT color="green">413</FONT>                    for (FeatureStructure subAnnotation : splitAnnotation.getAnnotations().toArray()) {<a name="line.413"></a>
<FONT color="green">414</FONT>                            returnValues.addAll(getAnnotations(jCas, (Annotation) subAnnotation, cls));<a name="line.414"></a>
<FONT color="green">415</FONT>                    }<a name="line.415"></a>
<FONT color="green">416</FONT>    <a name="line.416"></a>
<FONT color="green">417</FONT>                    return returnValues;<a name="line.417"></a>
<FONT color="green">418</FONT>            }<a name="line.418"></a>
<FONT color="green">419</FONT>    <a name="line.419"></a>
<FONT color="green">420</FONT>            public static &lt;T extends Annotation&gt; List&lt;T&gt; getAnnotations(JCas jCas, int begin, int end, Class&lt;T&gt; cls) {<a name="line.420"></a>
<FONT color="green">421</FONT>                    if(begin &gt; end)<a name="line.421"></a>
<FONT color="green">422</FONT>                            return null;<a name="line.422"></a>
<FONT color="green">423</FONT>                    Annotation annotation = new Annotation(jCas, begin, end);<a name="line.423"></a>
<FONT color="green">424</FONT>                    return getAnnotations(jCas, annotation, cls);<a name="line.424"></a>
<FONT color="green">425</FONT>            }<a name="line.425"></a>
<FONT color="green">426</FONT>    <a name="line.426"></a>
<FONT color="green">427</FONT>            /**<a name="line.427"></a>
<FONT color="green">428</FONT>             * This method provides a way to have multiple annotations define the window<a name="line.428"></a>
<FONT color="green">429</FONT>             * that is used to constrain the annotations in the returned list. The<a name="line.429"></a>
<FONT color="green">430</FONT>             * intersection of the windows is determined and used. This method will<a name="line.430"></a>
<FONT color="green">431</FONT>             * treat any split annotations in the list as a contiguous annotation.<a name="line.431"></a>
<FONT color="green">432</FONT>             * <a name="line.432"></a>
<FONT color="green">433</FONT>             * @see #getAnnotations(JCas, Annotation, Class)<a name="line.433"></a>
<FONT color="green">434</FONT>             * @see #getAnnotations(JCas, SplitAnnotation, Class)<a name="line.434"></a>
<FONT color="green">435</FONT>             */<a name="line.435"></a>
<FONT color="green">436</FONT>            public static &lt;T extends Annotation&gt; List&lt;T&gt; getAnnotations(JCas jCas, List&lt;Annotation&gt; windowAnnotations,<a name="line.436"></a>
<FONT color="green">437</FONT>                            Class&lt;T&gt; cls) {<a name="line.437"></a>
<FONT color="green">438</FONT>                    if (windowAnnotations == null || windowAnnotations.size() == 0) return null;<a name="line.438"></a>
<FONT color="green">439</FONT>    <a name="line.439"></a>
<FONT color="green">440</FONT>                    int windowBegin = Integer.MIN_VALUE;<a name="line.440"></a>
<FONT color="green">441</FONT>                    int windowEnd = Integer.MAX_VALUE;<a name="line.441"></a>
<FONT color="green">442</FONT>                    for (Annotation windowAnnotation : windowAnnotations) {<a name="line.442"></a>
<FONT color="green">443</FONT>                            if (windowAnnotation.getBegin() &gt; windowBegin) windowBegin = windowAnnotation.getBegin();<a name="line.443"></a>
<FONT color="green">444</FONT>                            if (windowAnnotation.getEnd() &lt; windowEnd) windowEnd = windowAnnotation.getEnd();<a name="line.444"></a>
<FONT color="green">445</FONT>                    }<a name="line.445"></a>
<FONT color="green">446</FONT>                    return getAnnotations(jCas, windowBegin, windowEnd, cls);<a name="line.446"></a>
<FONT color="green">447</FONT>            }<a name="line.447"></a>
<FONT color="green">448</FONT>    <a name="line.448"></a>
<FONT color="green">449</FONT>            // TODO think about how to make this method faster by avoiding using a<a name="line.449"></a>
<FONT color="green">450</FONT>            // constrained iterator. See TODO note for<a name="line.450"></a>
<FONT color="green">451</FONT>            // get adjacent annotation.<a name="line.451"></a>
<FONT color="green">452</FONT>            /**<a name="line.452"></a>
<FONT color="green">453</FONT>             * returns getContainingAnnotation(jCas, focusAnnotation, cls, false)<a name="line.453"></a>
<FONT color="green">454</FONT>             */<a name="line.454"></a>
<FONT color="green">455</FONT>            public static &lt;T extends Annotation&gt; T getContainingAnnotation(JCas jCas, Annotation focusAnnotation, Class&lt;T&gt; cls) {<a name="line.455"></a>
<FONT color="green">456</FONT>                    return getContainingAnnotation(jCas, focusAnnotation, cls, false);<a name="line.456"></a>
<FONT color="green">457</FONT>            }<a name="line.457"></a>
<FONT color="green">458</FONT>    <a name="line.458"></a>
<FONT color="green">459</FONT>            /**<a name="line.459"></a>
<FONT color="green">460</FONT>             * This method finds the smallest annotation of type cls that contains the<a name="line.460"></a>
<FONT color="green">461</FONT>             * focus annotation.<a name="line.461"></a>
<FONT color="green">462</FONT>             * <a name="line.462"></a>
<FONT color="green">463</FONT>             * @param jCas<a name="line.463"></a>
<FONT color="green">464</FONT>             * @param focusAnnotation<a name="line.464"></a>
<FONT color="green">465</FONT>             *            an annotation that will be contained by the returned value<a name="line.465"></a>
<FONT color="green">466</FONT>             * @param cls<a name="line.466"></a>
<FONT color="green">467</FONT>             *            determines the type of the returned annotation<a name="line.467"></a>
<FONT color="green">468</FONT>             * @param exclusiveContain<a name="line.468"></a>
<FONT color="green">469</FONT>             *            if true, then the method will only return an annotation if it<a name="line.469"></a>
<FONT color="green">470</FONT>             *            is larger than the focus annotation. If false, then an<a name="line.470"></a>
<FONT color="green">471</FONT>             *            annotation of the same size can be returned if one exists of<a name="line.471"></a>
<FONT color="green">472</FONT>             *            the type specified by the cls param. This may be undesirable<a name="line.472"></a>
<FONT color="green">473</FONT>             *            if the focus annotation is the same type as the cls param<a name="line.473"></a>
<FONT color="green">474</FONT>             *            because it will return the focus annotation when you might<a name="line.474"></a>
<FONT color="green">475</FONT>             *            actually want the next biggest annotation that contains the<a name="line.475"></a>
<FONT color="green">476</FONT>             *            focus annotation.<a name="line.476"></a>
<FONT color="green">477</FONT>             * @return an annotation of type cls that contains the focus annotation or<a name="line.477"></a>
<FONT color="green">478</FONT>             *         null it one does not exist.<a name="line.478"></a>
<FONT color="green">479</FONT>             */<a name="line.479"></a>
<FONT color="green">480</FONT>    <a name="line.480"></a>
<FONT color="green">481</FONT>            public static &lt;T extends Annotation&gt; T getContainingAnnotation(JCas jCas, Annotation focusAnnotation, Class&lt;T&gt; cls,<a name="line.481"></a>
<FONT color="green">482</FONT>                            boolean exclusiveContain) {<a name="line.482"></a>
<FONT color="green">483</FONT>    <a name="line.483"></a>
<FONT color="green">484</FONT>                    if(focusAnnotation == null)<a name="line.484"></a>
<FONT color="green">485</FONT>                            throw new IllegalArgumentException("focus annotation may not be null");<a name="line.485"></a>
<FONT color="green">486</FONT>    <a name="line.486"></a>
<FONT color="green">487</FONT>    <a name="line.487"></a>
<FONT color="green">488</FONT>                    FSIterator cursor = jCas.getAnnotationIndex().iterator();<a name="line.488"></a>
<FONT color="green">489</FONT>    <a name="line.489"></a>
<FONT color="green">490</FONT>                    //the goal is to move the cursor to the last annotation that begins at the same index as the focus annotation <a name="line.490"></a>
<FONT color="green">491</FONT>                    cursor.moveTo(focusAnnotation);<a name="line.491"></a>
<FONT color="green">492</FONT>                    while (cursor.isValid()) {<a name="line.492"></a>
<FONT color="green">493</FONT>                            cursor.moveToNext();<a name="line.493"></a>
<FONT color="green">494</FONT>    <a name="line.494"></a>
<FONT color="green">495</FONT>                            //if we have moved past the last element, then move cursor to last element and be done<a name="line.495"></a>
<FONT color="green">496</FONT>                            if(!cursor.isValid()) {<a name="line.496"></a>
<FONT color="green">497</FONT>                                    cursor.moveToLast();<a name="line.497"></a>
<FONT color="green">498</FONT>                                    break;<a name="line.498"></a>
<FONT color="green">499</FONT>                            }<a name="line.499"></a>
<FONT color="green">500</FONT>    <a name="line.500"></a>
<FONT color="green">501</FONT>                            //if we have moved to an annotation that does not be begin at the same index as the focus annotation,<a name="line.501"></a>
<FONT color="green">502</FONT>                            //then move to previous.  <a name="line.502"></a>
<FONT color="green">503</FONT>                            Annotation nextAnnotation = (Annotation) cursor.get();<a name="line.503"></a>
<FONT color="green">504</FONT>                            if(nextAnnotation.getBegin() != focusAnnotation.getBegin()) {<a name="line.504"></a>
<FONT color="green">505</FONT>                                    cursor.moveToPrevious();<a name="line.505"></a>
<FONT color="green">506</FONT>                                    break;<a name="line.506"></a>
<FONT color="green">507</FONT>                            }<a name="line.507"></a>
<FONT color="green">508</FONT>                    }<a name="line.508"></a>
<FONT color="green">509</FONT>    <a name="line.509"></a>
<FONT color="green">510</FONT>    <a name="line.510"></a>
<FONT color="green">511</FONT>                    while (cursor.isValid()) {<a name="line.511"></a>
<FONT color="green">512</FONT>                            Annotation annotation = (Annotation) cursor.get();<a name="line.512"></a>
<FONT color="green">513</FONT>                            if (exclusiveContain) {<a name="line.513"></a>
<FONT color="green">514</FONT>                                    if (cls.isInstance(annotation) &amp;&amp; annotation.getBegin() &lt;= focusAnnotation.getBegin()<a name="line.514"></a>
<FONT color="green">515</FONT>                                                    &amp;&amp; annotation.getEnd() &gt;= focusAnnotation.getEnd()<a name="line.515"></a>
<FONT color="green">516</FONT>                                                    &amp;&amp; AnnotationUtil.size(annotation) &gt; AnnotationUtil.size(focusAnnotation)) {<a name="line.516"></a>
<FONT color="green">517</FONT>                                            return cls.cast(annotation);<a name="line.517"></a>
<FONT color="green">518</FONT>                                    }<a name="line.518"></a>
<FONT color="green">519</FONT>                            }<a name="line.519"></a>
<FONT color="green">520</FONT>                            else {<a name="line.520"></a>
<FONT color="green">521</FONT>                                    if (cls.isInstance(annotation) &amp;&amp; annotation.getBegin() &lt;= focusAnnotation.getBegin()<a name="line.521"></a>
<FONT color="green">522</FONT>                                                    &amp;&amp; annotation.getEnd() &gt;= focusAnnotation.getEnd()) {<a name="line.522"></a>
<FONT color="green">523</FONT>                                            return cls.cast(annotation);<a name="line.523"></a>
<FONT color="green">524</FONT>                                    }<a name="line.524"></a>
<FONT color="green">525</FONT>                            }<a name="line.525"></a>
<FONT color="green">526</FONT>                            cursor.moveToPrevious();<a name="line.526"></a>
<FONT color="green">527</FONT>                    }<a name="line.527"></a>
<FONT color="green">528</FONT>                    return null;<a name="line.528"></a>
<FONT color="green">529</FONT>    <a name="line.529"></a>
<FONT color="green">530</FONT>            }<a name="line.530"></a>
<FONT color="green">531</FONT>    <a name="line.531"></a>
<FONT color="green">532</FONT>            public static &lt;T extends Annotation&gt; List&lt;T&gt; getOverlappingAnnotations(JCas jCas, Annotation focusAnnotation, Class&lt;T&gt; cls, boolean before) {<a name="line.532"></a>
<FONT color="green">533</FONT>                    List&lt;T&gt; annotations = new ArrayList&lt;T&gt;();<a name="line.533"></a>
<FONT color="green">534</FONT>    <a name="line.534"></a>
<FONT color="green">535</FONT>                    ConstraintFactory constraintFactory = jCas.getConstraintFactory();<a name="line.535"></a>
<FONT color="green">536</FONT>    <a name="line.536"></a>
<FONT color="green">537</FONT>                    FSTypeConstraint typeConstraint = constraintFactory.createTypeConstraint();<a name="line.537"></a>
<FONT color="green">538</FONT>                    Type type = UIMAUtil.getCasType(jCas, cls);<a name="line.538"></a>
<FONT color="green">539</FONT>                    typeConstraint.add(type);<a name="line.539"></a>
<FONT color="green">540</FONT>                    <a name="line.540"></a>
<FONT color="green">541</FONT>                    <a name="line.541"></a>
<FONT color="green">542</FONT>                    FSMatchConstraint overlapConstraint; <a name="line.542"></a>
<FONT color="green">543</FONT>                    if(before)<a name="line.543"></a>
<FONT color="green">544</FONT>                            overlapConstraint = getOverlapBeforeConstraint(jCas, focusAnnotation, constraintFactory);<a name="line.544"></a>
<FONT color="green">545</FONT>                    else<a name="line.545"></a>
<FONT color="green">546</FONT>                            overlapConstraint = getOverlapAfterConstraint(jCas, focusAnnotation, constraintFactory);<a name="line.546"></a>
<FONT color="green">547</FONT>    <a name="line.547"></a>
<FONT color="green">548</FONT>                    FSIterator iterator = jCas.createFilteredIterator(jCas.getAnnotationIndex(type).iterator(), overlapConstraint);<a name="line.548"></a>
<FONT color="green">549</FONT>                    while(iterator.hasNext()) {<a name="line.549"></a>
<FONT color="green">550</FONT>                            T annotation = cls.cast(iterator.next()); <a name="line.550"></a>
<FONT color="green">551</FONT>                            annotations.add(annotation);<a name="line.551"></a>
<FONT color="green">552</FONT>                    }<a name="line.552"></a>
<FONT color="green">553</FONT>                    <a name="line.553"></a>
<FONT color="green">554</FONT>                    return annotations;<a name="line.554"></a>
<FONT color="green">555</FONT>            }<a name="line.555"></a>
<FONT color="green">556</FONT>    <a name="line.556"></a>
<FONT color="green">557</FONT>            private static FSMatchConstraint getOverlapBeforeConstraint(JCas jCas, Annotation focusAnnotation, ConstraintFactory constraintFactory) {<a name="line.557"></a>
<FONT color="green">558</FONT>    <a name="line.558"></a>
<FONT color="green">559</FONT>                    FSIntConstraint beginIntConstraint = constraintFactory.createIntConstraint();<a name="line.559"></a>
<FONT color="green">560</FONT>                    beginIntConstraint.lt(focusAnnotation.getBegin());<a name="line.560"></a>
<FONT color="green">561</FONT>                    FeaturePath beginPath = jCas.createFeaturePath();<a name="line.561"></a>
<FONT color="green">562</FONT>                    Feature beginFeature = jCas.getTypeSystem().getFeatureByFullName("uima.tcas.Annotation:begin");<a name="line.562"></a>
<FONT color="green">563</FONT>                    beginPath.addFeature(beginFeature);<a name="line.563"></a>
<FONT color="green">564</FONT>                    FSMatchConstraint beginConstraint = constraintFactory.embedConstraint(beginPath, beginIntConstraint);<a name="line.564"></a>
<FONT color="green">565</FONT>                    <a name="line.565"></a>
<FONT color="green">566</FONT>                    FSIntConstraint endIntConstraint = constraintFactory.createIntConstraint();<a name="line.566"></a>
<FONT color="green">567</FONT>                    endIntConstraint.gt(focusAnnotation.getBegin());<a name="line.567"></a>
<FONT color="green">568</FONT>                    endIntConstraint.leq(focusAnnotation.getEnd());<a name="line.568"></a>
<FONT color="green">569</FONT>                    FeaturePath endPath = jCas.createFeaturePath();<a name="line.569"></a>
<FONT color="green">570</FONT>                    Feature endFeature = jCas.getTypeSystem().getFeatureByFullName("uima.tcas.Annotation:end");<a name="line.570"></a>
<FONT color="green">571</FONT>                    endPath.addFeature(endFeature);<a name="line.571"></a>
<FONT color="green">572</FONT>                    FSMatchConstraint endConstraint = constraintFactory.embedConstraint(endPath, endIntConstraint);<a name="line.572"></a>
<FONT color="green">573</FONT>    <a name="line.573"></a>
<FONT color="green">574</FONT>                    return constraintFactory.and(beginConstraint, endConstraint);<a name="line.574"></a>
<FONT color="green">575</FONT>            }<a name="line.575"></a>
<FONT color="green">576</FONT>    <a name="line.576"></a>
<FONT color="green">577</FONT>            private static FSMatchConstraint getOverlapAfterConstraint(JCas jCas, Annotation focusAnnotation, ConstraintFactory constraintFactory) {<a name="line.577"></a>
<FONT color="green">578</FONT>    <a name="line.578"></a>
<FONT color="green">579</FONT>                    FSIntConstraint beginIntConstraint = constraintFactory.createIntConstraint();<a name="line.579"></a>
<FONT color="green">580</FONT>                    beginIntConstraint.geq(focusAnnotation.getBegin());<a name="line.580"></a>
<FONT color="green">581</FONT>                    beginIntConstraint.lt(focusAnnotation.getEnd());<a name="line.581"></a>
<FONT color="green">582</FONT>                    <a name="line.582"></a>
<FONT color="green">583</FONT>                    FeaturePath beginPath = jCas.createFeaturePath();<a name="line.583"></a>
<FONT color="green">584</FONT>                    Feature beginFeature = jCas.getTypeSystem().getFeatureByFullName("uima.tcas.Annotation:begin");<a name="line.584"></a>
<FONT color="green">585</FONT>                    beginPath.addFeature(beginFeature);<a name="line.585"></a>
<FONT color="green">586</FONT>                    FSMatchConstraint beginConstraint = constraintFactory.embedConstraint(beginPath, beginIntConstraint);<a name="line.586"></a>
<FONT color="green">587</FONT>                    <a name="line.587"></a>
<FONT color="green">588</FONT>                    FSIntConstraint endIntConstraint = constraintFactory.createIntConstraint();<a name="line.588"></a>
<FONT color="green">589</FONT>                    endIntConstraint.gt(focusAnnotation.getEnd());<a name="line.589"></a>
<FONT color="green">590</FONT>                    FeaturePath endPath = jCas.createFeaturePath();<a name="line.590"></a>
<FONT color="green">591</FONT>                    Feature endFeature = jCas.getTypeSystem().getFeatureByFullName("uima.tcas.Annotation:end");<a name="line.591"></a>
<FONT color="green">592</FONT>                    endPath.addFeature(endFeature);<a name="line.592"></a>
<FONT color="green">593</FONT>                    FSMatchConstraint endConstraint = constraintFactory.embedConstraint(endPath, endIntConstraint);<a name="line.593"></a>
<FONT color="green">594</FONT>    <a name="line.594"></a>
<FONT color="green">595</FONT>                    return constraintFactory.and(beginConstraint, endConstraint);<a name="line.595"></a>
<FONT color="green">596</FONT>            }<a name="line.596"></a>
<FONT color="green">597</FONT>    <a name="line.597"></a>
<FONT color="green">598</FONT>            /**<a name="line.598"></a>
<FONT color="green">599</FONT>             * Finds and returns the annotation of the provided type that is adjacent to<a name="line.599"></a>
<FONT color="green">600</FONT>             * the focus annotation in either to the left or right. Adjacent simply<a name="line.600"></a>
<FONT color="green">601</FONT>             * means the last annotation of the passed in type that ends before the<a name="line.601"></a>
<FONT color="green">602</FONT>             * start of the focus annotation (for the left side) or the first annotation<a name="line.602"></a>
<FONT color="green">603</FONT>             * that starts after the end of the focus annotation (for the right side).<a name="line.603"></a>
<FONT color="green">604</FONT>             * Thus, adacent refers to order of annotations at the annotation level<a name="line.604"></a>
<FONT color="green">605</FONT>             * (e.g. give me the first annotation of type x to the left of the focus<a name="line.605"></a>
<FONT color="green">606</FONT>             * annotation) and does not mean that the annotations are adjacenct at the<a name="line.606"></a>
<FONT color="green">607</FONT>             * character offset level.<a name="line.607"></a>
<FONT color="green">608</FONT>             * <a name="line.608"></a>
<FONT color="green">609</FONT>             * &lt;br&gt;<a name="line.609"></a>
<FONT color="green">610</FONT>             * &lt;b&gt;note:&lt;/b&gt; This method runs &lt;b&gt;much&lt;/b&gt; faster if the type of the<a name="line.610"></a>
<FONT color="green">611</FONT>             * passed in annotation and the passed in type are the same.<a name="line.611"></a>
<FONT color="green">612</FONT>             * <a name="line.612"></a>
<FONT color="green">613</FONT>             * @param jCas<a name="line.613"></a>
<FONT color="green">614</FONT>             * @param focusAnnotation<a name="line.614"></a>
<FONT color="green">615</FONT>             *            an annotation that you want to find an annotation adjacent to<a name="line.615"></a>
<FONT color="green">616</FONT>             *            this.<a name="line.616"></a>
<FONT color="green">617</FONT>             * @param adjacentClass<a name="line.617"></a>
<FONT color="green">618</FONT>             *            the type of annotation that you want to find<a name="line.618"></a>
<FONT color="green">619</FONT>             * @param adjacentBefore<a name="line.619"></a>
<FONT color="green">620</FONT>             *            if true then returns an annotation to the left of the passed<a name="line.620"></a>
<FONT color="green">621</FONT>             *            in annotation, otherwise an annotation to the right will be<a name="line.621"></a>
<FONT color="green">622</FONT>             *            returned.<a name="line.622"></a>
<FONT color="green">623</FONT>             * @return an annotation of type adjacentType or null<a name="line.623"></a>
<FONT color="green">624</FONT>             */<a name="line.624"></a>
<FONT color="green">625</FONT>            public static &lt;T extends Annotation&gt; T getAdjacentAnnotation(JCas jCas, Annotation focusAnnotation,<a name="line.625"></a>
<FONT color="green">626</FONT>                            Class&lt;T&gt; adjacentClass, boolean adjacentBefore) {<a name="line.626"></a>
<FONT color="green">627</FONT>                    try {<a name="line.627"></a>
<FONT color="green">628</FONT>                            Type adjacentType = UIMAUtil.getCasType(jCas, adjacentClass);<a name="line.628"></a>
<FONT color="green">629</FONT>                            if (focusAnnotation.getType().equals(adjacentType)) {<a name="line.629"></a>
<FONT color="green">630</FONT>                                    FSIterator iterator = jCas.getAnnotationIndex(adjacentType).iterator();<a name="line.630"></a>
<FONT color="green">631</FONT>                                    iterator.moveTo(focusAnnotation);<a name="line.631"></a>
<FONT color="green">632</FONT>                                    if (adjacentBefore) iterator.moveToPrevious();<a name="line.632"></a>
<FONT color="green">633</FONT>                                    else iterator.moveToNext();<a name="line.633"></a>
<FONT color="green">634</FONT>                                    return adjacentClass.cast(iterator.get());<a name="line.634"></a>
<FONT color="green">635</FONT>                            }<a name="line.635"></a>
<FONT color="green">636</FONT>                            else {<a name="line.636"></a>
<FONT color="green">637</FONT>                                    FSIterator cursor = jCas.getAnnotationIndex().iterator();<a name="line.637"></a>
<FONT color="green">638</FONT>                                    cursor.moveTo(focusAnnotation);<a name="line.638"></a>
<FONT color="green">639</FONT>                                    if (adjacentBefore) {<a name="line.639"></a>
<FONT color="green">640</FONT>                                            while (cursor.isValid()) {<a name="line.640"></a>
<FONT color="green">641</FONT>                                                    cursor.moveToPrevious();<a name="line.641"></a>
<FONT color="green">642</FONT>                                                    Annotation annotation = (Annotation) cursor.get();<a name="line.642"></a>
<FONT color="green">643</FONT>                                                    if (adjacentClass.isInstance(annotation) &amp;&amp; annotation.getEnd() &lt;= focusAnnotation.getBegin()) return adjacentClass<a name="line.643"></a>
<FONT color="green">644</FONT>                                                    .cast(annotation);<a name="line.644"></a>
<FONT color="green">645</FONT>                                            }<a name="line.645"></a>
<FONT color="green">646</FONT>                                    }<a name="line.646"></a>
<FONT color="green">647</FONT>                                    else {<a name="line.647"></a>
<FONT color="green">648</FONT>                                            while (cursor.isValid()) {<a name="line.648"></a>
<FONT color="green">649</FONT>                                                    cursor.moveToNext();<a name="line.649"></a>
<FONT color="green">650</FONT>                                                    Annotation annotation = (Annotation) cursor.get();<a name="line.650"></a>
<FONT color="green">651</FONT>                                                    if (adjacentClass.isInstance(annotation) &amp;&amp; annotation.getBegin() &gt;= focusAnnotation.getEnd()) return adjacentClass<a name="line.651"></a>
<FONT color="green">652</FONT>                                                    .cast(annotation);<a name="line.652"></a>
<FONT color="green">653</FONT>                                            }<a name="line.653"></a>
<FONT color="green">654</FONT>                                    }<a name="line.654"></a>
<FONT color="green">655</FONT>                            }<a name="line.655"></a>
<FONT color="green">656</FONT>                    }<a name="line.656"></a>
<FONT color="green">657</FONT>                    catch (NoSuchElementException nsee) {<a name="line.657"></a>
<FONT color="green">658</FONT>                            return null;<a name="line.658"></a>
<FONT color="green">659</FONT>                    }<a name="line.659"></a>
<FONT color="green">660</FONT>                    return null;<a name="line.660"></a>
<FONT color="green">661</FONT>            }<a name="line.661"></a>
<FONT color="green">662</FONT>    <a name="line.662"></a>
<FONT color="green">663</FONT>            public static &lt;T extends Annotation&gt; AnnotationIndex getAnnotationIndex(JCas jCas, Class&lt;T&gt; cls) {<a name="line.663"></a>
<FONT color="green">664</FONT>                    return jCas.getAnnotationIndex(UIMAUtil.getCasType(jCas, cls));<a name="line.664"></a>
<FONT color="green">665</FONT>            }<a name="line.665"></a>
<FONT color="green">666</FONT>    <a name="line.666"></a>
<FONT color="green">667</FONT>            /**<a name="line.667"></a>
<FONT color="green">668</FONT>             * Get the DocumentAnnotation for this JCas. <a name="line.668"></a>
<FONT color="green">669</FONT>             * @param jCas The JCas for the document.<a name="line.669"></a>
<FONT color="green">670</FONT>             * @return     The DocumentAnnotation.<a name="line.670"></a>
<FONT color="green">671</FONT>             */<a name="line.671"></a>
<FONT color="green">672</FONT>            public static DocumentAnnotation getDocument(JCas jCas)<a name="line.672"></a>
<FONT color="green">673</FONT>            {<a name="line.673"></a>
<FONT color="green">674</FONT>                    return (DocumentAnnotation)jCas.getDocumentAnnotationFs();<a name="line.674"></a>
<FONT color="green">675</FONT>            }<a name="line.675"></a>
<FONT color="green">676</FONT>    <a name="line.676"></a>
<FONT color="green">677</FONT>    }<a name="line.677"></a>
<FONT color="green">678</FONT>    <a name="line.678"></a>




























































</PRE>
</BODY>
</HTML>
